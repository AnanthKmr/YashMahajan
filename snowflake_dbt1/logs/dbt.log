[0m15:58:21.114569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA177FB290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA17B78090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA1780D0D0>]}


============================== 15:58:21.118568 | d2535c1a-1b8f-46af-b240-b5502c1532c4 ==============================
[0m15:58:21.118568 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:58:21.120568 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt debug', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:58:21.121568 [info ] [MainThread]: dbt version: 1.6.6
[0m15:58:21.122568 [info ] [MainThread]: python version: 3.11.4
[0m15:58:21.122568 [info ] [MainThread]: python path: C:\Users\yashm\AppData\Local\Programs\Python\Python311\python.exe
[0m15:58:21.123568 [info ] [MainThread]: os info: Windows-10-10.0.19045-SP0
[0m15:58:21.463571 [info ] [MainThread]: Using profiles dir at C:\Users\yashm\.dbt
[0m15:58:21.464571 [info ] [MainThread]: Using profiles.yml file at C:\Users\yashm\.dbt\profiles.yml
[0m15:58:21.464571 [info ] [MainThread]: Using dbt_project.yml file at D:\snowflake_dbt1\snowflake_dbt1\dbt_project.yml
[0m15:58:21.466569 [info ] [MainThread]: adapter type: snowflake
[0m15:58:21.467577 [info ] [MainThread]: adapter version: 1.6.4
[0m15:58:21.501863 [info ] [MainThread]: Configuration:
[0m15:58:21.502865 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m15:58:21.503865 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m15:58:21.504864 [info ] [MainThread]: Required dependencies:
[0m15:58:21.505864 [debug] [MainThread]: Executing "git --help"
[0m15:58:21.633545 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m15:58:21.634545 [debug] [MainThread]: STDERR: "b''"
[0m15:58:21.634545 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m15:58:21.636545 [info ] [MainThread]: Connection:
[0m15:58:21.637545 [info ] [MainThread]:   account: drvxydw
[0m15:58:21.638546 [info ] [MainThread]:   user: YASHDIGITAL
[0m15:58:21.639546 [info ] [MainThread]:   database: DEMO_DATABASE1
[0m15:58:21.640546 [info ] [MainThread]:   warehouse: DEMO_WAREHOUSE1
[0m15:58:21.641545 [info ] [MainThread]:   role: sysadmin
[0m15:58:21.643547 [info ] [MainThread]:   schema: demo_schema1 
[0m15:58:21.644547 [info ] [MainThread]:   authenticator: None
[0m15:58:21.645548 [info ] [MainThread]:   private_key_path: None
[0m15:58:21.647546 [info ] [MainThread]:   token: None
[0m15:58:21.648545 [info ] [MainThread]:   oauth_client_id: None
[0m15:58:21.649544 [info ] [MainThread]:   query_tag: None
[0m15:58:21.650545 [info ] [MainThread]:   client_session_keep_alive: False
[0m15:58:21.651546 [info ] [MainThread]:   host: None
[0m15:58:21.652545 [info ] [MainThread]:   port: None
[0m15:58:21.653546 [info ] [MainThread]:   proxy_host: None
[0m15:58:21.654546 [info ] [MainThread]:   proxy_port: None
[0m15:58:21.655546 [info ] [MainThread]:   protocol: None
[0m15:58:21.656546 [info ] [MainThread]:   connect_retries: 1
[0m15:58:21.657545 [info ] [MainThread]:   connect_timeout: None
[0m15:58:21.658545 [info ] [MainThread]:   retry_on_database_errors: False
[0m15:58:21.659546 [info ] [MainThread]:   retry_all: False
[0m15:58:21.661547 [info ] [MainThread]:   insecure_mode: False
[0m15:58:21.662550 [info ] [MainThread]:   reuse_connections: None
[0m15:58:21.663547 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:58:21.665547 [debug] [MainThread]: Acquiring new snowflake connection 'debug'
[0m15:58:21.666546 [debug] [MainThread]: Using snowflake connection "debug"
[0m15:58:21.667551 [debug] [MainThread]: On debug: select 1 as id
[0m15:58:21.668550 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:58:23.663982 [debug] [MainThread]: Snowflake adapter: Error running SQL: select 1 as id
[0m15:58:23.663982 [debug] [MainThread]: Snowflake adapter: Rolling back transaction.
[0m15:58:23.663982 [debug] [MainThread]: On debug: No close available on handle
[0m15:58:23.663982 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m15:58:23.663982 [info ] [MainThread]: [31m1 check failed:[0m
[0m15:58:23.663982 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Database Error
  250001 (08001): Failed to connect to DB. Verify the account name is correct: drvxydw.snowflakecomputing.com:443. HTTP 403: Forbidden

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m15:58:23.663982 [debug] [MainThread]: Command `dbt debug` failed at 15:58:23.663982 after 2.59 seconds
[0m15:58:23.663982 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m15:58:23.663982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA18A9BED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA17ABD090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA17FC5C10>]}
[0m15:58:23.663982 [debug] [MainThread]: Flushing usage events
[0m19:54:40.254660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002874045B190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002874076B510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002874045AD90>]}


============================== 19:54:40.259660 | 3491e2e1-bacc-4c15-8867-d315f10a55d7 ==============================
[0m19:54:40.259660 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:54:40.260660 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:54:40.261661 [info ] [MainThread]: dbt version: 1.6.6
[0m19:54:40.283661 [info ] [MainThread]: python version: 3.11.4
[0m19:54:40.285662 [info ] [MainThread]: python path: C:\Users\yashm\AppData\Local\Programs\Python\Python311\python.exe
[0m19:54:40.286662 [info ] [MainThread]: os info: Windows-10-10.0.19045-SP0
[0m19:54:40.713675 [info ] [MainThread]: Using profiles dir at C:\Users\yashm\.dbt
[0m19:54:40.714675 [info ] [MainThread]: Using profiles.yml file at C:\Users\yashm\.dbt\profiles.yml
[0m19:54:40.715674 [info ] [MainThread]: Using dbt_project.yml file at D:\snowflake_dbt1\snowflake_dbt1\dbt_project.yml
[0m19:54:40.717675 [info ] [MainThread]: adapter type: snowflake
[0m19:54:40.718677 [info ] [MainThread]: adapter version: 1.6.4
[0m19:54:40.770677 [info ] [MainThread]: Configuration:
[0m19:54:40.772676 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m19:54:40.774676 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m19:54:40.778677 [info ] [MainThread]: Required dependencies:
[0m19:54:40.780677 [debug] [MainThread]: Executing "git --help"
[0m19:54:40.892686 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m19:54:40.893683 [debug] [MainThread]: STDERR: "b''"
[0m19:54:40.894684 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m19:54:40.896682 [info ] [MainThread]: Connection:
[0m19:54:40.897682 [info ] [MainThread]:   account: drvxydw-gf36759
[0m19:54:40.898681 [info ] [MainThread]:   user: YASHDIGITAL
[0m19:54:40.899683 [info ] [MainThread]:   database: demo_database
[0m19:54:40.900683 [info ] [MainThread]:   warehouse: demo_warehouse
[0m19:54:40.902682 [info ] [MainThread]:   role: sysadmin
[0m19:54:40.903682 [info ] [MainThread]:   schema: demo_schema
[0m19:54:40.905682 [info ] [MainThread]:   authenticator: None
[0m19:54:40.907684 [info ] [MainThread]:   private_key_path: None
[0m19:54:40.909684 [info ] [MainThread]:   token: None
[0m19:54:40.910682 [info ] [MainThread]:   oauth_client_id: None
[0m19:54:40.911681 [info ] [MainThread]:   query_tag: None
[0m19:54:40.912685 [info ] [MainThread]:   client_session_keep_alive: False
[0m19:54:40.914682 [info ] [MainThread]:   host: None
[0m19:54:40.937682 [info ] [MainThread]:   port: None
[0m19:54:40.953685 [info ] [MainThread]:   proxy_host: None
[0m19:54:40.954683 [info ] [MainThread]:   proxy_port: None
[0m19:54:40.957682 [info ] [MainThread]:   protocol: None
[0m19:54:40.962685 [info ] [MainThread]:   connect_retries: 1
[0m19:54:40.970684 [info ] [MainThread]:   connect_timeout: None
[0m19:54:40.972684 [info ] [MainThread]:   retry_on_database_errors: False
[0m19:54:40.979690 [info ] [MainThread]:   retry_all: False
[0m19:54:40.982686 [info ] [MainThread]:   insecure_mode: False
[0m19:54:40.984684 [info ] [MainThread]:   reuse_connections: None
[0m19:54:40.987687 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:54:40.988683 [debug] [MainThread]: Acquiring new snowflake connection 'debug'
[0m19:54:40.996687 [debug] [MainThread]: Using snowflake connection "debug"
[0m19:54:40.998461 [debug] [MainThread]: On debug: select 1 as id
[0m19:54:40.999458 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:54:43.052740 [debug] [MainThread]: SQL status: SUCCESS 1 in 2.0 seconds
[0m19:54:43.053739 [debug] [MainThread]: On debug: Close
[0m19:54:43.118741 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m19:54:43.120744 [info ] [MainThread]: [32mAll checks passed![0m
[0m19:54:43.122773 [debug] [MainThread]: Command `dbt debug` succeeded at 19:54:43.121741 after 2.91 seconds
[0m19:54:43.122773 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m19:54:43.123743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028740543710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000287404D0890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028740C321D0>]}
[0m19:54:43.124746 [debug] [MainThread]: Flushing usage events
[0m19:55:30.158922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BA276EB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BA275FE10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BA244B750>]}


============================== 19:55:30.162919 | 1cebefbf-4de3-4115-b0f5-d5489a7e6727 ==============================
[0m19:55:30.162919 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:55:30.164890 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt debug', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:55:30.165889 [info ] [MainThread]: dbt version: 1.6.6
[0m19:55:30.166889 [info ] [MainThread]: python version: 3.11.4
[0m19:55:30.167889 [info ] [MainThread]: python path: C:\Users\yashm\AppData\Local\Programs\Python\Python311\python.exe
[0m19:55:30.168888 [info ] [MainThread]: os info: Windows-10-10.0.19045-SP0
[0m19:55:30.563901 [info ] [MainThread]: Using profiles dir at C:\Users\yashm\.dbt
[0m19:55:30.564906 [info ] [MainThread]: Using profiles.yml file at C:\Users\yashm\.dbt\profiles.yml
[0m19:55:30.565901 [info ] [MainThread]: Using dbt_project.yml file at D:\snowflake_dbt1\snowflake_dbt1\dbt_project.yml
[0m19:55:30.567902 [info ] [MainThread]: adapter type: snowflake
[0m19:55:30.569904 [info ] [MainThread]: adapter version: 1.6.4
[0m19:55:30.610909 [info ] [MainThread]: Configuration:
[0m19:55:30.614906 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m19:55:30.615906 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m19:55:30.619915 [info ] [MainThread]: Required dependencies:
[0m19:55:30.621905 [debug] [MainThread]: Executing "git --help"
[0m19:55:30.730909 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m19:55:30.731908 [debug] [MainThread]: STDERR: "b''"
[0m19:55:30.731908 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m19:55:30.733908 [info ] [MainThread]: Connection:
[0m19:55:30.734909 [info ] [MainThread]:   account: drvxydw-gf36759
[0m19:55:30.735908 [info ] [MainThread]:   user: YASHDIGITAL
[0m19:55:30.736909 [info ] [MainThread]:   database: demo_database
[0m19:55:30.737909 [info ] [MainThread]:   warehouse: demo_warehouse
[0m19:55:30.738910 [info ] [MainThread]:   role: sysadmin
[0m19:55:30.740908 [info ] [MainThread]:   schema: demo_schema
[0m19:55:30.741910 [info ] [MainThread]:   authenticator: None
[0m19:55:30.742908 [info ] [MainThread]:   private_key_path: None
[0m19:55:30.743907 [info ] [MainThread]:   token: None
[0m19:55:30.745909 [info ] [MainThread]:   oauth_client_id: None
[0m19:55:30.747908 [info ] [MainThread]:   query_tag: None
[0m19:55:30.757910 [info ] [MainThread]:   client_session_keep_alive: False
[0m19:55:30.758910 [info ] [MainThread]:   host: None
[0m19:55:30.759908 [info ] [MainThread]:   port: None
[0m19:55:30.761909 [info ] [MainThread]:   proxy_host: None
[0m19:55:30.763909 [info ] [MainThread]:   proxy_port: None
[0m19:55:30.764910 [info ] [MainThread]:   protocol: None
[0m19:55:30.768910 [info ] [MainThread]:   connect_retries: 1
[0m19:55:30.769915 [info ] [MainThread]:   connect_timeout: None
[0m19:55:30.770910 [info ] [MainThread]:   retry_on_database_errors: False
[0m19:55:30.771909 [info ] [MainThread]:   retry_all: False
[0m19:55:30.772908 [info ] [MainThread]:   insecure_mode: False
[0m19:55:30.773909 [info ] [MainThread]:   reuse_connections: None
[0m19:55:30.774909 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:55:30.776910 [debug] [MainThread]: Acquiring new snowflake connection 'debug'
[0m19:55:30.778917 [debug] [MainThread]: Using snowflake connection "debug"
[0m19:55:30.780911 [debug] [MainThread]: On debug: select 1 as id
[0m19:55:30.781908 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:55:32.240101 [debug] [MainThread]: SQL status: SUCCESS 1 in 1.0 seconds
[0m19:55:32.243098 [debug] [MainThread]: On debug: Close
[0m19:55:32.304475 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m19:55:32.306441 [info ] [MainThread]: [32mAll checks passed![0m
[0m19:55:32.309444 [debug] [MainThread]: Command `dbt debug` succeeded at 19:55:32.308443 after 2.18 seconds
[0m19:55:32.310479 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m19:55:32.311475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BA1853B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BA28567D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BA2C1E4D0>]}
[0m19:55:32.313443 [debug] [MainThread]: Flushing usage events
[0m19:56:30.138629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DDDDB190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DE0E9FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DE085B90>]}


============================== 19:56:30.143640 | 2be9f147-8847-4cfe-8cfe-70547bec20ab ==============================
[0m19:56:30.143640 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:56:30.144599 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:56:30.693614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DE0B78D0>]}
[0m19:56:30.716616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DE5994D0>]}
[0m19:56:30.717617 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:56:30.734621 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:56:30.752632 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m19:56:30.754619 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6E016F890>]}
[0m19:56:32.317250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DF056410>]}
[0m19:56:32.336251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6E023E9D0>]}
[0m19:56:32.337254 [info ] [MainThread]: Found 2 models, 4 tests, 0 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:56:32.339254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DF087A10>]}
[0m19:56:32.341253 [info ] [MainThread]: 
[0m19:56:32.343253 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:56:32.345252 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:56:32.367274 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:56:32.368257 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:56:32.369253 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:56:33.433293 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:56:33.436290 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:56:33.513294 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:56:33.527292 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:56:33.528292 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:56:33.529294 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:56:34.434320 [debug] [ThreadPool]: SQL status: SUCCESS 36 in 1.0 seconds
[0m19:56:34.438322 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:56:34.523326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DE5A31D0>]}
[0m19:56:34.525329 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:56:34.530326 [info ] [MainThread]: 
[0m19:56:34.538326 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_first_dbt_model
[0m19:56:34.539326 [info ] [Thread-1 (]: 1 of 2 START sql table model demo_schema.my_first_dbt_model .................... [RUN]
[0m19:56:34.554330 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_first_dbt_model'
[0m19:56:34.556328 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_first_dbt_model
[0m19:56:34.591328 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_first_dbt_model"
[0m19:56:34.616333 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_first_dbt_model (compile): 19:56:34.557327 => 19:56:34.616333
[0m19:56:34.619331 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_first_dbt_model
[0m19:56:34.673331 [debug] [Thread-1 (]: Writing runtime sql for node "model.snowflake_dbt1.my_first_dbt_model"
[0m19:56:34.678334 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_first_dbt_model"
[0m19:56:34.679331 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_first_dbt_model"} */
create or replace transient table demo_database.demo_schema.my_first_dbt_model
         as
        (/*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
        );
[0m19:56:34.680331 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:56:36.409327 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.0 seconds
[0m19:56:36.440327 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_first_dbt_model (execute): 19:56:34.620330 => 19:56:36.440327
[0m19:56:36.441326 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_first_dbt_model: Close
[0m19:56:36.549329 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6E00BBA10>]}
[0m19:56:36.550330 [info ] [Thread-1 (]: 1 of 2 OK created sql table model demo_schema.my_first_dbt_model ............... [[32mSUCCESS 1[0m in 2.00s]
[0m19:56:36.552331 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_first_dbt_model
[0m19:56:36.553331 [debug] [Thread-3 (]: Began running node model.snowflake_dbt1.my_second_dbt_model
[0m19:56:36.554331 [info ] [Thread-3 (]: 2 of 2 START sql view model demo_schema.my_second_dbt_model .................... [RUN]
[0m19:56:36.556330 [debug] [Thread-3 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_second_dbt_model'
[0m19:56:36.557333 [debug] [Thread-3 (]: Began compiling node model.snowflake_dbt1.my_second_dbt_model
[0m19:56:36.561333 [debug] [Thread-3 (]: Writing injected SQL for node "model.snowflake_dbt1.my_second_dbt_model"
[0m19:56:36.564333 [debug] [Thread-3 (]: Timing info for model.snowflake_dbt1.my_second_dbt_model (compile): 19:56:36.558331 => 19:56:36.563331
[0m19:56:36.565332 [debug] [Thread-3 (]: Began executing node model.snowflake_dbt1.my_second_dbt_model
[0m19:56:36.618348 [debug] [Thread-3 (]: Writing runtime sql for node "model.snowflake_dbt1.my_second_dbt_model"
[0m19:56:36.623334 [debug] [Thread-3 (]: Using snowflake connection "model.snowflake_dbt1.my_second_dbt_model"
[0m19:56:36.624332 [debug] [Thread-3 (]: On model.snowflake_dbt1.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_second_dbt_model"} */
create or replace   view demo_database.demo_schema.my_second_dbt_model
  
   as (
    -- Use the `ref` function to select from other models

select *
from demo_database.demo_schema.my_first_dbt_model
where id = 1
  );
[0m19:56:36.625333 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m19:56:37.453708 [debug] [Thread-3 (]: SQL status: SUCCESS 1 in 1.0 seconds
[0m19:56:37.458698 [debug] [Thread-3 (]: Timing info for model.snowflake_dbt1.my_second_dbt_model (execute): 19:56:36.566332 => 19:56:37.458698
[0m19:56:37.459700 [debug] [Thread-3 (]: On model.snowflake_dbt1.my_second_dbt_model: Close
[0m19:56:37.532415 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2be9f147-8847-4cfe-8cfe-70547bec20ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6E0693FD0>]}
[0m19:56:37.533414 [info ] [Thread-3 (]: 2 of 2 OK created sql view model demo_schema.my_second_dbt_model ............... [[32mSUCCESS 1[0m in 0.98s]
[0m19:56:37.535416 [debug] [Thread-3 (]: Finished running node model.snowflake_dbt1.my_second_dbt_model
[0m19:56:37.538415 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:56:37.538415 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:56:37.539415 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:56:37.540419 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_first_dbt_model' was properly closed.
[0m19:56:37.541418 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_second_dbt_model' was properly closed.
[0m19:56:37.541418 [info ] [MainThread]: 
[0m19:56:37.543417 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 5.20 seconds (5.20s).
[0m19:56:37.545419 [debug] [MainThread]: Command end result
[0m19:56:37.560418 [info ] [MainThread]: 
[0m19:56:37.561419 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:56:37.562419 [info ] [MainThread]: 
[0m19:56:37.564420 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m19:56:37.568418 [debug] [MainThread]: Command `dbt run` succeeded at 19:56:37.568418 after 7.46 seconds
[0m19:56:37.570418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DDDCCC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DDFEEF90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6DE57BD10>]}
[0m19:56:37.571419 [debug] [MainThread]: Flushing usage events
[0m19:58:36.563235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974CB4E290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974C715990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974C3B7350>]}


============================== 19:58:36.567235 | de4d079a-0f84-402d-8a62-01ac6abbe770 ==============================
[0m19:58:36.567235 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:58:36.569236 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select my_python', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:58:37.028209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'de4d079a-0f84-402d-8a62-01ac6abbe770', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974C68C3D0>]}
[0m19:58:37.048246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'de4d079a-0f84-402d-8a62-01ac6abbe770', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974C439110>]}
[0m19:58:37.049211 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:58:37.062242 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:58:37.163297 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m19:58:37.164268 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\my_python.py
[0m19:58:37.258268 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.snowflake_dbt1.my_python' (models\example\my_python.py) depends on a source named 'student_s.target_dp' which was not found
[0m19:58:37.260268 [debug] [MainThread]: Command `dbt run` failed at 19:58:37.260268 after 0.73 seconds
[0m19:58:37.261269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974CB4D710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974C677F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001974C677190>]}
[0m19:58:37.262299 [debug] [MainThread]: Flushing usage events
[0m20:00:54.629353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CA2B190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CD3F550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CE2CDD0>]}


============================== 20:00:54.634353 | fd51bd7d-c5d2-43a3-995e-002144b5b5b0 ==============================
[0m20:00:54.634353 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:00:54.635352 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select my_python', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:00:55.139674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fd51bd7d-c5d2-43a3-995e-002144b5b5b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CAE8790>]}
[0m20:00:55.160678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fd51bd7d-c5d2-43a3-995e-002144b5b5b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CAE8790>]}
[0m20:00:55.162678 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:00:55.176676 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:00:55.297629 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m20:00:55.298629 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\my_python.py
[0m20:00:55.300630 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\source.yml
[0m20:00:55.454631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fd51bd7d-c5d2-43a3-995e-002144b5b5b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CD4E0D0>]}
[0m20:00:55.490633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fd51bd7d-c5d2-43a3-995e-002144b5b5b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2EE52850>]}
[0m20:00:55.491630 [info ] [MainThread]: Found 3 models, 4 tests, 3 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:00:55.492631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd51bd7d-c5d2-43a3-995e-002144b5b5b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C28746610>]}
[0m20:00:55.495632 [info ] [MainThread]: 
[0m20:00:55.497633 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:00:55.499631 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:00:55.519633 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:00:55.520630 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:00:55.520630 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:56.899201 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:00:56.902169 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:00:56.989168 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:00:57.002167 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:00:57.002167 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:00:57.003167 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:57.751409 [debug] [ThreadPool]: SQL status: SUCCESS 36 in 1.0 seconds
[0m20:00:57.755407 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:00:57.864374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd51bd7d-c5d2-43a3-995e-002144b5b5b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CD4DE10>]}
[0m20:00:57.866410 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:00:57.867374 [info ] [MainThread]: 
[0m20:00:57.876376 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_python
[0m20:00:57.877375 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.my_python .......................... [RUN]
[0m20:00:57.880383 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_python'
[0m20:00:57.882377 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_python
[0m20:00:57.943380 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_python"
[0m20:00:57.947377 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (compile): 20:00:57.882377 => 20:00:57.947377
[0m20:00:57.949379 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_python
[0m20:00:57.999377 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.my_python"
[0m20:00:58.003400 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_python"
[0m20:00:58.004376 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_python"} */
WITH my_python__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    target_name = dbt.source("student_s", "target_dp")

    source_df = dbt.source("student_s", "bank_stream")
    
    if source_df.count() <= 2:
        insert_query = f"insert into {target_name} select * from {source_df}"
        result=session.sql(insert_query)
        
    else:
        updt_fields={}
        trgt_cols = target_name.columns
        for col_name in trgt_cols:
            if col_name in source_df.columns:
                updt_fields[col_name] = source_df[col_name]
        result=target_name.merge(source_df, (target_name["custid"] == source_df["custid"]),
                    [when_matched().update(updt_fields), when_not_matched().insert(updt_fields)])

    result.show()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "my_python"
    
    def __repr__(self):
        return 'demo_database.demo_schema.my_python'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.my_python', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL my_python__dbt_sp();
[0m20:00:58.005377 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:01:02.183141 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b06426-0001-0d24-0000-000299e6e459
[0m20:01:02.184170 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 117, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function MY_PYTHON__DBT_SP with handler main
[0m20:01:02.186171 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (execute): 20:00:57.949379 => 20:01:02.185142
[0m20:01:02.187142 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: Close
[0m20:01:02.275807 [debug] [Thread-1 (]: Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m20:01:02.276840 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd51bd7d-c5d2-43a3-995e-002144b5b5b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2EE4F590>]}
[0m20:01:02.278808 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.my_python ................. [[31mERROR[0m in 4.40s]
[0m20:01:02.280807 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_python
[0m20:01:02.283805 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:01:02.284806 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:01:02.285806 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:01:02.286806 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_python' was properly closed.
[0m20:01:02.287806 [info ] [MainThread]: 
[0m20:01:02.289810 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.79 seconds (6.79s).
[0m20:01:02.291810 [debug] [MainThread]: Command end result
[0m20:01:02.309807 [info ] [MainThread]: 
[0m20:01:02.310805 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:01:02.312807 [info ] [MainThread]: 
[0m20:01:02.313805 [error] [MainThread]:   Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m20:01:02.315805 [info ] [MainThread]: 
[0m20:01:02.316853 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:01:02.319144 [debug] [MainThread]: Command `dbt run` failed at 20:01:02.319144 after 7.72 seconds
[0m20:01:02.321110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2D20FB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2BDF3E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021C2CA2B7D0>]}
[0m20:01:02.323112 [debug] [MainThread]: Flushing usage events
[0m12:57:06.329658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C023B83E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C023B88090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C024493890>]}


============================== 12:57:06.345282 | 758002b7-30d3-4195-9db0-3663ab61b2fd ==============================
[0m12:57:06.345282 [info ] [MainThread]: Running with dbt=1.6.6
[0m12:57:06.345282 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:57:06.730709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C0254B6110>]}
[0m12:57:06.746367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C0242A66D0>]}
[0m12:57:06.746367 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m12:57:06.761991 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m12:57:06.859171 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:57:06.859171 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:57:06.899583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C01D5C2110>]}
[0m12:57:06.928313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C026517910>]}
[0m12:57:06.929344 [info ] [MainThread]: Found 3 models, 4 tests, 3 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m12:57:06.930311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C02463FA90>]}
[0m12:57:06.932309 [info ] [MainThread]: 
[0m12:57:06.934310 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m12:57:06.936310 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m12:57:06.948204 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m12:57:06.948204 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m12:57:06.948204 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:57:08.634935 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 2.0 seconds
[0m12:57:08.650385 [debug] [ThreadPool]: On list_demo_database: Close
[0m12:57:08.719629 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m12:57:08.735245 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m12:57:08.735245 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m12:57:08.735245 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:57:09.522225 [debug] [ThreadPool]: SQL status: SUCCESS 36 in 1.0 seconds
[0m12:57:09.537625 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m12:57:09.622106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C02463FA90>]}
[0m12:57:09.622106 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m12:57:09.622106 [info ] [MainThread]: 
[0m12:57:09.637727 [debug] [Thread-2 (]: Began running node model.snowflake_dbt1.my_python
[0m12:57:09.622106 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_first_dbt_model
[0m12:57:09.638522 [info ] [Thread-2 (]: 2 of 3 START python table model demo_schema.my_python .......................... [RUN]
[0m12:57:09.641523 [debug] [Thread-2 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_python'
[0m12:57:09.639523 [info ] [Thread-1 (]: 1 of 3 START sql table model demo_schema.my_first_dbt_model .................... [RUN]
[0m12:57:09.642552 [debug] [Thread-2 (]: Began compiling node model.snowflake_dbt1.my_python
[0m12:57:09.645634 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_first_dbt_model'
[0m12:57:09.676077 [debug] [Thread-2 (]: Writing injected SQL for node "model.snowflake_dbt1.my_python"
[0m12:57:09.676077 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_first_dbt_model
[0m12:57:09.676077 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_first_dbt_model"
[0m12:57:09.676077 [debug] [Thread-2 (]: Timing info for model.snowflake_dbt1.my_python (compile): 12:57:09.645634 => 12:57:09.676077
[0m12:57:09.676077 [debug] [Thread-2 (]: Began executing node model.snowflake_dbt1.my_python
[0m12:57:09.676077 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_first_dbt_model (compile): 12:57:09.676077 => 12:57:09.676077
[0m12:57:09.725262 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_first_dbt_model
[0m12:57:09.726454 [debug] [Thread-2 (]: Writing runtime python for node "model.snowflake_dbt1.my_python"
[0m12:57:09.726454 [debug] [Thread-1 (]: Writing runtime sql for node "model.snowflake_dbt1.my_first_dbt_model"
[0m12:57:09.726454 [debug] [Thread-2 (]: Using snowflake connection "model.snowflake_dbt1.my_python"
[0m12:57:09.726454 [debug] [Thread-2 (]: On model.snowflake_dbt1.my_python: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_python"} */
WITH my_python__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    target_name = dbt.source("student_s", "target_dp")

    source_df = dbt.source("student_s", "bank_stream")
    
    if source_df.count() <= 2:
        insert_query = f"insert into {target_name} select * from {source_df}"
        result=session.sql(insert_query)
        
    else:
        updt_fields={}
        trgt_cols = target_name.columns
        for col_name in trgt_cols:
            if col_name in source_df.columns:
                updt_fields[col_name] = source_df[col_name]
        result=target_name.merge(source_df, (target_name["custid"] == source_df["custid"]),
                    [when_matched().update(updt_fields), when_not_matched().insert(updt_fields)])

    result.show()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "my_python"
    
    def __repr__(self):
        return 'demo_database.demo_schema.my_python'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.my_python', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL my_python__dbt_sp();
[0m12:57:09.726454 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_first_dbt_model"
[0m12:57:09.726454 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m12:57:09.726454 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_first_dbt_model"} */
create or replace transient table demo_database.demo_schema.my_first_dbt_model
         as
        (/*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
        );
[0m12:57:09.741931 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m12:57:12.529489 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m12:57:12.560514 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_first_dbt_model (execute): 12:57:09.726454 => 12:57:12.560514
[0m12:57:12.560514 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_first_dbt_model: Close
[0m12:57:12.614134 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C026BB5750>]}
[0m12:57:12.629539 [info ] [Thread-1 (]: 1 of 3 OK created sql table model demo_schema.my_first_dbt_model ............... [[32mSUCCESS 1[0m in 2.97s]
[0m12:57:12.629539 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_first_dbt_model
[0m12:57:12.629539 [debug] [Thread-4 (]: Began running node model.snowflake_dbt1.my_second_dbt_model
[0m12:57:12.629539 [info ] [Thread-4 (]: 3 of 3 START sql view model demo_schema.my_second_dbt_model .................... [RUN]
[0m12:57:12.629539 [debug] [Thread-4 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_second_dbt_model'
[0m12:57:12.629539 [debug] [Thread-4 (]: Began compiling node model.snowflake_dbt1.my_second_dbt_model
[0m12:57:12.629539 [debug] [Thread-4 (]: Writing injected SQL for node "model.snowflake_dbt1.my_second_dbt_model"
[0m12:57:12.629539 [debug] [Thread-4 (]: Timing info for model.snowflake_dbt1.my_second_dbt_model (compile): 12:57:12.629539 => 12:57:12.629539
[0m12:57:12.629539 [debug] [Thread-4 (]: Began executing node model.snowflake_dbt1.my_second_dbt_model
[0m12:57:12.675276 [debug] [Thread-4 (]: Writing runtime sql for node "model.snowflake_dbt1.my_second_dbt_model"
[0m12:57:12.678062 [debug] [Thread-4 (]: Using snowflake connection "model.snowflake_dbt1.my_second_dbt_model"
[0m12:57:12.678062 [debug] [Thread-4 (]: On model.snowflake_dbt1.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_second_dbt_model"} */
create or replace   view demo_database.demo_schema.my_second_dbt_model
  
   as (
    -- Use the `ref` function to select from other models

select *
from demo_database.demo_schema.my_first_dbt_model
where id = 1
  );
[0m12:57:12.678062 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m12:57:13.424744 [debug] [Thread-4 (]: SQL status: SUCCESS 1 in 1.0 seconds
[0m12:57:13.440197 [debug] [Thread-4 (]: Timing info for model.snowflake_dbt1.my_second_dbt_model (execute): 12:57:12.629539 => 12:57:13.440197
[0m12:57:13.440197 [debug] [Thread-4 (]: On model.snowflake_dbt1.my_second_dbt_model: Close
[0m12:57:13.509186 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C026C28E50>]}
[0m12:57:13.509186 [info ] [Thread-4 (]: 3 of 3 OK created sql view model demo_schema.my_second_dbt_model ............... [[32mSUCCESS 1[0m in 0.88s]
[0m12:57:13.509186 [debug] [Thread-4 (]: Finished running node model.snowflake_dbt1.my_second_dbt_model
[0m12:57:14.681098 [debug] [Thread-2 (]: Snowflake adapter: Snowflake query id: 01b0735f-0001-0d23-0000-000299e6f3dd
[0m12:57:14.681098 [debug] [Thread-2 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 117, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function MY_PYTHON__DBT_SP with handler main
[0m12:57:14.681098 [debug] [Thread-2 (]: Timing info for model.snowflake_dbt1.my_python (execute): 12:57:09.676077 => 12:57:14.681098
[0m12:57:14.681098 [debug] [Thread-2 (]: On model.snowflake_dbt1.my_python: Close
[0m12:57:14.759211 [debug] [Thread-2 (]: Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m12:57:14.759211 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '758002b7-30d3-4195-9db0-3663ab61b2fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C026CE3550>]}
[0m12:57:14.765723 [error] [Thread-2 (]: 2 of 3 ERROR creating python table model demo_schema.my_python ................. [[31mERROR[0m in 5.12s]
[0m12:57:14.765723 [debug] [Thread-2 (]: Finished running node model.snowflake_dbt1.my_python
[0m12:57:14.765723 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:57:14.765723 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m12:57:14.765723 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m12:57:14.765723 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_python' was properly closed.
[0m12:57:14.765723 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_first_dbt_model' was properly closed.
[0m12:57:14.765723 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_second_dbt_model' was properly closed.
[0m12:57:14.765723 [info ] [MainThread]: 
[0m12:57:14.765723 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 7.83 seconds (7.83s).
[0m12:57:14.782978 [debug] [MainThread]: Command end result
[0m12:57:14.798017 [info ] [MainThread]: 
[0m12:57:14.799018 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:57:14.800021 [info ] [MainThread]: 
[0m12:57:14.801018 [error] [MainThread]:   Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m12:57:14.803018 [info ] [MainThread]: 
[0m12:57:14.805020 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m12:57:14.806020 [debug] [MainThread]: Command `dbt run` failed at 12:57:14.806020 after 8.49 seconds
[0m12:57:14.807051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C02480B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C02436E890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C0245678D0>]}
[0m12:57:14.808046 [debug] [MainThread]: Flushing usage events
[0m13:11:55.894750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4316CA2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4314637D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4314810D0>]}


============================== 13:11:55.899780 | 04fd7644-1f34-47c9-b24a-4d82182cd95f ==============================
[0m13:11:55.899780 [info ] [MainThread]: Running with dbt=1.6.6
[0m13:11:55.900750 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:11:56.330512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D431B92690>]}
[0m13:11:56.350512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D432670310>]}
[0m13:11:56.351513 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m13:11:56.364512 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m13:11:56.463481 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:11:56.464512 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:11:56.517514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D430ACFD90>]}
[0m13:11:56.534483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43369EED0>]}
[0m13:11:56.535483 [info ] [MainThread]: Found 3 models, 4 tests, 3 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m13:11:56.537485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42D156810>]}
[0m13:11:56.539513 [info ] [MainThread]: 
[0m13:11:56.541484 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m13:11:56.543484 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m13:11:56.560517 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m13:11:56.561509 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m13:11:56.561509 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:11:57.613004 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m13:11:57.617006 [debug] [ThreadPool]: On list_demo_database: Close
[0m13:11:57.710885 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m13:11:57.731515 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m13:11:57.732514 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m13:11:57.733514 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:11:58.583148 [debug] [ThreadPool]: SQL status: SUCCESS 36 in 1.0 seconds
[0m13:11:58.593149 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m13:11:58.689381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42EC87510>]}
[0m13:11:58.691351 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m13:11:58.692475 [info ] [MainThread]: 
[0m13:11:58.701512 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_first_dbt_model
[0m13:11:58.702513 [debug] [Thread-2 (]: Began running node model.snowflake_dbt1.my_python
[0m13:11:58.702513 [info ] [Thread-1 (]: 1 of 3 START sql table model demo_schema.my_first_dbt_model .................... [RUN]
[0m13:11:58.705515 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_first_dbt_model'
[0m13:11:58.703514 [info ] [Thread-2 (]: 2 of 3 START python table model demo_schema.my_python .......................... [RUN]
[0m13:11:58.706514 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_first_dbt_model
[0m13:11:58.708545 [debug] [Thread-2 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_python'
[0m13:11:58.720516 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_first_dbt_model"
[0m13:11:58.721516 [debug] [Thread-2 (]: Began compiling node model.snowflake_dbt1.my_python
[0m13:11:58.758515 [debug] [Thread-2 (]: Writing injected SQL for node "model.snowflake_dbt1.my_python"
[0m13:11:58.758515 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_first_dbt_model (compile): 13:11:58.708545 => 13:11:58.758515
[0m13:11:58.759515 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_first_dbt_model
[0m13:11:58.772548 [debug] [Thread-2 (]: Timing info for model.snowflake_dbt1.my_python (compile): 13:11:58.722516 => 13:11:58.772548
[0m13:11:58.805513 [debug] [Thread-1 (]: Writing runtime sql for node "model.snowflake_dbt1.my_first_dbt_model"
[0m13:11:58.805513 [debug] [Thread-2 (]: Began executing node model.snowflake_dbt1.my_python
[0m13:11:58.812514 [debug] [Thread-2 (]: Writing runtime python for node "model.snowflake_dbt1.my_python"
[0m13:11:58.814535 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_first_dbt_model"
[0m13:11:58.815518 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_first_dbt_model"} */
create or replace transient table demo_database.demo_schema.my_first_dbt_model
         as
        (/*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
        );
[0m13:11:58.817513 [debug] [Thread-2 (]: Using snowflake connection "model.snowflake_dbt1.my_python"
[0m13:11:58.817513 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:11:58.818513 [debug] [Thread-2 (]: On model.snowflake_dbt1.my_python: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_python"} */
WITH my_python__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    target_name = dbt.source("student_s", "target_dp")

    source_df = dbt.source("student_s", "bank_stream")
    
    if source_df.count() <= 2:
        insert_query = f"insert into {target_name} select * from {source_df}"
        result=session.sql(insert_query)
        
    else:
        updt_fields={}
        trgt_cols = target_name.columns
        for col_name in trgt_cols:
            if col_name in source_df.columns:
                updt_fields[col_name] = source_df[col_name]
        result=target_name.merge(source_df, (target_name["custid"] == source_df["custid"]),
                    [when_matched().update(updt_fields), when_not_matched().insert(updt_fields)])

    result.show()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "my_python"
    
    def __repr__(self):
        return 'demo_database.demo_schema.my_python'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.my_python', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL my_python__dbt_sp();
[0m13:11:58.821514 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m13:12:00.619071 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 2.0 seconds
[0m13:12:00.660019 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_first_dbt_model (execute): 13:11:58.760514 => 13:12:00.660019
[0m13:12:00.661018 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_first_dbt_model: Close
[0m13:12:00.717121 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D432694E50>]}
[0m13:12:00.718121 [info ] [Thread-1 (]: 1 of 3 OK created sql table model demo_schema.my_first_dbt_model ............... [[32mSUCCESS 1[0m in 2.01s]
[0m13:12:00.720123 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_first_dbt_model
[0m13:12:00.722124 [debug] [Thread-4 (]: Began running node model.snowflake_dbt1.my_second_dbt_model
[0m13:12:00.723124 [info ] [Thread-4 (]: 3 of 3 START sql view model demo_schema.my_second_dbt_model .................... [RUN]
[0m13:12:00.725126 [debug] [Thread-4 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_second_dbt_model'
[0m13:12:00.726127 [debug] [Thread-4 (]: Began compiling node model.snowflake_dbt1.my_second_dbt_model
[0m13:12:00.732131 [debug] [Thread-4 (]: Writing injected SQL for node "model.snowflake_dbt1.my_second_dbt_model"
[0m13:12:00.735127 [debug] [Thread-4 (]: Timing info for model.snowflake_dbt1.my_second_dbt_model (compile): 13:12:00.727122 => 13:12:00.734125
[0m13:12:00.736124 [debug] [Thread-4 (]: Began executing node model.snowflake_dbt1.my_second_dbt_model
[0m13:12:00.767125 [debug] [Thread-4 (]: Writing runtime sql for node "model.snowflake_dbt1.my_second_dbt_model"
[0m13:12:00.771123 [debug] [Thread-4 (]: Using snowflake connection "model.snowflake_dbt1.my_second_dbt_model"
[0m13:12:00.772163 [debug] [Thread-4 (]: On model.snowflake_dbt1.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_second_dbt_model"} */
create or replace   view demo_database.demo_schema.my_second_dbt_model
  
   as (
    -- Use the `ref` function to select from other models

select *
from demo_database.demo_schema.my_first_dbt_model
where id = 1
  );
[0m13:12:00.773154 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m13:12:00.948121 [debug] [Thread-2 (]: Snowflake adapter: Snowflake query id: 01b0736e-0001-0d23-0000-000299e6f465
[0m13:12:00.949152 [debug] [Thread-2 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 117, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function MY_PYTHON__DBT_SP with handler main
[0m13:12:00.950123 [debug] [Thread-2 (]: Timing info for model.snowflake_dbt1.my_python (execute): 13:11:58.806512 => 13:12:00.950123
[0m13:12:00.951123 [debug] [Thread-2 (]: On model.snowflake_dbt1.my_python: Close
[0m13:12:01.015153 [debug] [Thread-2 (]: Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m13:12:01.016152 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D433C960D0>]}
[0m13:12:01.017121 [error] [Thread-2 (]: 2 of 3 ERROR creating python table model demo_schema.my_python ................. [[31mERROR[0m in 2.31s]
[0m13:12:01.019123 [debug] [Thread-2 (]: Finished running node model.snowflake_dbt1.my_python
[0m13:12:01.541229 [debug] [Thread-4 (]: SQL status: SUCCESS 1 in 1.0 seconds
[0m13:12:01.549230 [debug] [Thread-4 (]: Timing info for model.snowflake_dbt1.my_second_dbt_model (execute): 13:12:00.736124 => 13:12:01.549230
[0m13:12:01.551225 [debug] [Thread-4 (]: On model.snowflake_dbt1.my_second_dbt_model: Close
[0m13:12:01.637158 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '04fd7644-1f34-47c9-b24a-4d82182cd95f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D433764E10>]}
[0m13:12:01.640163 [info ] [Thread-4 (]: 3 of 3 OK created sql view model demo_schema.my_second_dbt_model ............... [[32mSUCCESS 1[0m in 0.91s]
[0m13:12:01.644328 [debug] [Thread-4 (]: Finished running node model.snowflake_dbt1.my_second_dbt_model
[0m13:12:01.651329 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:12:01.653328 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m13:12:01.655279 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m13:12:01.656325 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_first_dbt_model' was properly closed.
[0m13:12:01.658323 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_python' was properly closed.
[0m13:12:01.659278 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_second_dbt_model' was properly closed.
[0m13:12:01.661278 [info ] [MainThread]: 
[0m13:12:01.663277 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 5.12 seconds (5.12s).
[0m13:12:01.667274 [debug] [MainThread]: Command end result
[0m13:12:01.684280 [info ] [MainThread]: 
[0m13:12:01.686273 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:12:01.688274 [info ] [MainThread]: 
[0m13:12:01.689272 [error] [MainThread]:   Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m13:12:01.691273 [info ] [MainThread]: 
[0m13:12:01.693277 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m13:12:01.695305 [debug] [MainThread]: Command `dbt run` failed at 13:12:01.694283 after 5.83 seconds
[0m13:12:01.695305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42E9FD350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D430D7C190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42D156810>]}
[0m13:12:01.696274 [debug] [MainThread]: Flushing usage events
[0m13:12:13.116533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1AE43E710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1ADC7CE10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1ADF95C10>]}


============================== 13:12:13.120534 | 12e8bec8-1044-4166-a124-c50cd6c39932 ==============================
[0m13:12:13.120534 [info ] [MainThread]: Running with dbt=1.6.6
[0m13:12:13.122509 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select my_python', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m13:12:13.543553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '12e8bec8-1044-4166-a124-c50cd6c39932', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1ADCA6590>]}
[0m13:12:13.563553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '12e8bec8-1044-4166-a124-c50cd6c39932', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1AE85A890>]}
[0m13:12:13.565557 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m13:12:13.578586 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m13:12:13.677222 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:12:13.678253 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:12:13.729221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '12e8bec8-1044-4166-a124-c50cd6c39932', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1AE0653D0>]}
[0m13:12:13.747225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '12e8bec8-1044-4166-a124-c50cd6c39932', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1AFEFEC50>]}
[0m13:12:13.748228 [info ] [MainThread]: Found 3 models, 4 tests, 3 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m13:12:13.750225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12e8bec8-1044-4166-a124-c50cd6c39932', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1AD6648D0>]}
[0m13:12:13.752226 [info ] [MainThread]: 
[0m13:12:13.753238 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m13:12:13.756224 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m13:12:13.773228 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m13:12:13.776224 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m13:12:13.776224 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:12:15.041619 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m13:12:15.047565 [debug] [ThreadPool]: On list_demo_database: Close
[0m13:12:15.116368 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m13:12:15.129363 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m13:12:15.130331 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m13:12:15.130331 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:12:15.787348 [debug] [ThreadPool]: SQL status: SUCCESS 36 in 1.0 seconds
[0m13:12:15.796346 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m13:12:15.891014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12e8bec8-1044-4166-a124-c50cd6c39932', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1ADCAFBD0>]}
[0m13:12:15.892983 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m13:12:15.894979 [info ] [MainThread]: 
[0m13:12:15.906006 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_python
[0m13:12:15.907007 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.my_python .......................... [RUN]
[0m13:12:15.907977 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_python'
[0m13:12:15.909978 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_python
[0m13:12:15.951976 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_python"
[0m13:12:15.954995 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (compile): 13:12:15.911013 => 13:12:15.953977
[0m13:12:15.955978 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_python
[0m13:12:16.000017 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.my_python"
[0m13:12:16.004008 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_python"
[0m13:12:16.004987 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_python"} */
WITH my_python__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    target_name = dbt.source("student_s", "target_dp")

    source_df = dbt.source("student_s", "bank_stream")
    
    if source_df.count() <= 2:
        insert_query = f"insert into {target_name} select * from {source_df}"
        result=session.sql(insert_query)
        
    else:
        updt_fields={}
        trgt_cols = target_name.columns
        for col_name in trgt_cols:
            if col_name in source_df.columns:
                updt_fields[col_name] = source_df[col_name]
        result=target_name.merge(source_df, (target_name["custid"] == source_df["custid"]),
                    [when_matched().update(updt_fields), when_not_matched().insert(updt_fields)])

    result.show()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "my_python"
    
    def __repr__(self):
        return 'demo_database.demo_schema.my_python'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.my_python', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL my_python__dbt_sp();
[0m13:12:16.006008 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:12:17.617413 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0736e-0001-0d24-0000-000299e6e515
[0m13:12:17.618414 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 117, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function MY_PYTHON__DBT_SP with handler main
[0m13:12:17.619418 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (execute): 13:12:15.956988 => 13:12:17.619418
[0m13:12:17.620418 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: Close
[0m13:12:17.697601 [debug] [Thread-1 (]: Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m13:12:17.698635 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '12e8bec8-1044-4166-a124-c50cd6c39932', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1AFF4D750>]}
[0m13:12:17.699602 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.my_python ................. [[31mERROR[0m in 1.79s]
[0m13:12:17.700601 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_python
[0m13:12:17.704602 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:12:17.705602 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m13:12:17.706605 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m13:12:17.707601 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_python' was properly closed.
[0m13:12:17.708600 [info ] [MainThread]: 
[0m13:12:17.709601 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.96 seconds (3.96s).
[0m13:12:17.713602 [debug] [MainThread]: Command end result
[0m13:12:17.730603 [info ] [MainThread]: 
[0m13:12:17.733607 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:12:17.735604 [info ] [MainThread]: 
[0m13:12:17.737602 [error] [MainThread]:   Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m13:12:17.740601 [info ] [MainThread]: 
[0m13:12:17.741602 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:12:17.743604 [debug] [MainThread]: Command `dbt run` failed at 13:12:17.743604 after 4.65 seconds
[0m13:12:17.744600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1ADCAFB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1AE42EBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C1ADC7C1D0>]}
[0m13:12:17.745601 [debug] [MainThread]: Flushing usage events
[0m13:27:31.502821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F476B210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F486C590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F47A9C90>]}


============================== 13:27:31.507821 | bea4798c-e948-4610-b37c-f50d007c90ce ==============================
[0m13:27:31.507821 [info ] [MainThread]: Running with dbt=1.6.6
[0m13:27:31.509837 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select try', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:27:31.939822 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bea4798c-e948-4610-b37c-f50d007c90ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F4F4FF50>]}
[0m13:27:31.958855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bea4798c-e948-4610-b37c-f50d007c90ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F4F4FF50>]}
[0m13:27:31.959824 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m13:27:31.972854 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m13:27:32.072857 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m13:27:32.073823 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\try.py
[0m13:27:32.180855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bea4798c-e948-4610-b37c-f50d007c90ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F5BBC0D0>]}
[0m13:27:32.198823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bea4798c-e948-4610-b37c-f50d007c90ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F5BCDB90>]}
[0m13:27:32.199848 [info ] [MainThread]: Found 4 models, 4 tests, 3 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m13:27:32.200823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bea4798c-e948-4610-b37c-f50d007c90ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F5BBC210>]}
[0m13:27:32.202854 [info ] [MainThread]: 
[0m13:27:32.203824 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m13:27:32.205857 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m13:27:32.225858 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m13:27:32.226855 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m13:27:32.227824 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:27:33.303215 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m13:27:33.309263 [debug] [ThreadPool]: On list_demo_database: Close
[0m13:27:33.786431 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m13:27:33.806429 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m13:27:33.807432 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m13:27:33.808427 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:27:34.530833 [debug] [ThreadPool]: SQL status: SUCCESS 36 in 1.0 seconds
[0m13:27:34.536793 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m13:27:34.624468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bea4798c-e948-4610-b37c-f50d007c90ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F6EA3110>]}
[0m13:27:34.626458 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m13:27:34.628424 [info ] [MainThread]: 
[0m13:27:34.637419 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try
[0m13:27:34.638450 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try ................................ [RUN]
[0m13:27:34.640451 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try'
[0m13:27:34.641419 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try
[0m13:27:34.680449 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try"
[0m13:27:34.683373 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try (compile): 13:27:34.642423 => 13:27:34.682360
[0m13:27:34.683373 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try
[0m13:27:34.728402 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try"
[0m13:27:34.732373 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try"
[0m13:27:34.733403 [debug] [Thread-1 (]: On model.snowflake_dbt1.try: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try"} */
WITH try__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    return source_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try__dbt_sp();
[0m13:27:34.734403 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:27:37.238534 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0737d-0001-0d23-0000-000299e6f479
[0m13:27:37.239535 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 100, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function TRY__DBT_SP with handler main
[0m13:27:37.240536 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try (execute): 13:27:34.684371 => 13:27:37.239535
[0m13:27:37.241537 [debug] [Thread-1 (]: On model.snowflake_dbt1.try: Close
[0m13:27:37.308236 [debug] [Thread-1 (]: Database Error in model try (models\example\try.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 100, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function TRY__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try.py
[0m13:27:37.309207 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bea4798c-e948-4610-b37c-f50d007c90ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F5A3C710>]}
[0m13:27:37.310239 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try ....................... [[31mERROR[0m in 2.67s]
[0m13:27:37.312206 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try
[0m13:27:37.315206 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:27:37.316242 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m13:27:37.317239 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m13:27:37.318242 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try' was properly closed.
[0m13:27:37.318242 [info ] [MainThread]: 
[0m13:27:37.320207 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.11 seconds (5.11s).
[0m13:27:37.322207 [debug] [MainThread]: Command end result
[0m13:27:37.339210 [info ] [MainThread]: 
[0m13:27:37.341210 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:27:37.342205 [info ] [MainThread]: 
[0m13:27:37.343238 [error] [MainThread]:   Database Error in model try (models\example\try.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 100, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function TRY__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try.py
[0m13:27:37.346206 [info ] [MainThread]: 
[0m13:27:37.347085 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:27:37.349095 [debug] [MainThread]: Command `dbt run` failed at 13:27:37.349095 after 5.87 seconds
[0m13:27:37.350095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F46F03D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F47ABBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177F4B7C190>]}
[0m13:27:37.350095 [debug] [MainThread]: Flushing usage events
[0m13:46:09.755876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028576F01290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285763D07D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028576ABA590>]}


============================== 13:46:09.755876 | 9cd4aa6a-4d61-4c60-b17f-33475f152459 ==============================
[0m13:46:09.755876 [info ] [MainThread]: Running with dbt=1.6.6
[0m13:46:09.755876 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select src_emp', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:46:10.171722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9cd4aa6a-4d61-4c60-b17f-33475f152459', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028576767F50>]}
[0m13:46:10.195946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9cd4aa6a-4d61-4c60-b17f-33475f152459', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028576767A10>]}
[0m13:46:10.204015 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m13:46:10.214130 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m13:46:10.345244 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:46:10.345244 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:46:10.345244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9cd4aa6a-4d61-4c60-b17f-33475f152459', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028576191C50>]}
[0m13:46:10.360911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9cd4aa6a-4d61-4c60-b17f-33475f152459', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285789BAD90>]}
[0m13:46:10.360911 [info ] [MainThread]: Found 5 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m13:46:10.376504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9cd4aa6a-4d61-4c60-b17f-33475f152459', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028575AF3950>]}
[0m13:46:10.376504 [info ] [MainThread]: 
[0m13:46:10.376504 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m13:46:10.376504 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m13:46:10.398999 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m13:46:10.400001 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m13:46:10.400001 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:46:11.965348 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 2.0 seconds
[0m13:46:11.965348 [debug] [ThreadPool]: On list_demo_database: Close
[0m13:46:12.366405 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m13:46:12.381813 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m13:46:12.381813 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m13:46:12.381813 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:46:13.284547 [debug] [ThreadPool]: SQL status: SUCCESS 36 in 1.0 seconds
[0m13:46:13.284547 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m13:46:13.353589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9cd4aa6a-4d61-4c60-b17f-33475f152459', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028575AF3950>]}
[0m13:46:13.353589 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m13:46:13.353589 [info ] [MainThread]: 
[0m13:46:13.353589 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.src_emp
[0m13:46:13.353589 [info ] [Thread-1 (]: 1 of 1 START sql table model demo_schema.src_emp ............................... [RUN]
[0m13:46:13.369230 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.src_emp'
[0m13:46:13.370839 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.src_emp
[0m13:46:13.384504 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.src_emp"
[0m13:46:13.384782 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.src_emp (compile): 13:46:13.371840 => 13:46:13.384782
[0m13:46:13.384782 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.src_emp
[0m13:46:13.424597 [debug] [Thread-1 (]: Writing runtime sql for node "model.snowflake_dbt1.src_emp"
[0m13:46:13.425639 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.src_emp"
[0m13:46:13.425639 [debug] [Thread-1 (]: On model.snowflake_dbt1.src_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.src_emp"} */
create or replace transient table demo_database.demo_schema.src_emp
         as
        (


with src_emp as(
    select * from emp
)

select * from src_emp
        );
[0m13:46:13.425639 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:46:17.363581 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m13:46:17.394843 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.src_emp (execute): 13:46:13.384782 => 13:46:17.394843
[0m13:46:17.394843 [debug] [Thread-1 (]: On model.snowflake_dbt1.src_emp: Close
[0m13:46:17.441969 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9cd4aa6a-4d61-4c60-b17f-33475f152459', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028578A70290>]}
[0m13:46:17.441969 [info ] [Thread-1 (]: 1 of 1 OK created sql table model demo_schema.src_emp .......................... [[32mSUCCESS 1[0m in 4.07s]
[0m13:46:17.441969 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.src_emp
[0m13:46:17.457345 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:46:17.457345 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m13:46:17.457345 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m13:46:17.457345 [debug] [MainThread]: Connection 'model.snowflake_dbt1.src_emp' was properly closed.
[0m13:46:17.457345 [info ] [MainThread]: 
[0m13:46:17.457345 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.08 seconds (7.08s).
[0m13:46:17.464978 [debug] [MainThread]: Command end result
[0m13:46:17.478903 [info ] [MainThread]: 
[0m13:46:17.481090 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:46:17.482748 [info ] [MainThread]: 
[0m13:46:17.484748 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:46:17.485745 [debug] [MainThread]: Command `dbt run` succeeded at 13:46:17.485745 after 7.75 seconds
[0m13:46:17.486747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028576765550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028576AFEB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002856FAF2F90>]}
[0m13:46:17.487767 [debug] [MainThread]: Flushing usage events
[0m13:59:28.524401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FF4D190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FB6FD90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FF4D090>]}


============================== 13:59:28.524401 | 98bc1221-3fff-4dc2-8e14-a64243bdeed6 ==============================
[0m13:59:28.524401 [info ] [MainThread]: Running with dbt=1.6.6
[0m13:59:28.524401 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select try', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m13:59:28.925945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '98bc1221-3fff-4dc2-8e14-a64243bdeed6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FE5DC10>]}
[0m13:59:28.941608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '98bc1221-3fff-4dc2-8e14-a64243bdeed6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FC109D0>]}
[0m13:59:28.941608 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m13:59:28.960966 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m13:59:29.097120 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:59:29.098118 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try.py
[0m13:59:29.142027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '98bc1221-3fff-4dc2-8e14-a64243bdeed6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C330DF0910>]}
[0m13:59:29.157655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '98bc1221-3fff-4dc2-8e14-a64243bdeed6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C330DF24D0>]}
[0m13:59:29.157655 [info ] [MainThread]: Found 5 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m13:59:29.157655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98bc1221-3fff-4dc2-8e14-a64243bdeed6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FC31750>]}
[0m13:59:29.157655 [info ] [MainThread]: 
[0m13:59:29.173241 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m13:59:29.173241 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m13:59:29.190690 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m13:59:29.191689 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m13:59:29.192688 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:59:30.205916 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m13:59:30.205916 [debug] [ThreadPool]: On list_demo_database: Close
[0m13:59:30.268440 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m13:59:30.283813 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m13:59:30.283813 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m13:59:30.283813 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:59:31.070417 [debug] [ThreadPool]: SQL status: SUCCESS 37 in 1.0 seconds
[0m13:59:31.070417 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m13:59:31.154993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98bc1221-3fff-4dc2-8e14-a64243bdeed6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C33219C8D0>]}
[0m13:59:31.154993 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m13:59:31.154993 [info ] [MainThread]: 
[0m13:59:31.154993 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try
[0m13:59:31.154993 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try ................................ [RUN]
[0m13:59:31.168558 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try'
[0m13:59:31.169565 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try
[0m13:59:31.197731 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try"
[0m13:59:31.197731 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try (compile): 13:59:31.169565 => 13:59:31.197731
[0m13:59:31.197731 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try
[0m13:59:31.246993 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try"
[0m13:59:31.249993 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try"
[0m13:59:31.251006 [debug] [Thread-1 (]: On model.snowflake_dbt1.try: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try"} */
WITH try__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp")

    

    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try__dbt_sp();
[0m13:59:31.251006 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m13:59:35.182036 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m13:59:35.219746 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try (execute): 13:59:31.197731 => 13:59:35.219746
[0m13:59:35.219746 [debug] [Thread-1 (]: On model.snowflake_dbt1.try: Close
[0m13:59:35.303950 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98bc1221-3fff-4dc2-8e14-a64243bdeed6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C332379B10>]}
[0m13:59:35.303950 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try ........................... [[32mSUCCESS 1[0m in 4.15s]
[0m13:59:35.303950 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try
[0m13:59:35.303950 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:59:35.303950 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m13:59:35.303950 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m13:59:35.303950 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try' was properly closed.
[0m13:59:35.303950 [info ] [MainThread]: 
[0m13:59:35.303950 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.13 seconds (6.13s).
[0m13:59:35.318996 [debug] [MainThread]: Command end result
[0m13:59:35.333161 [info ] [MainThread]: 
[0m13:59:35.334537 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:59:35.337027 [info ] [MainThread]: 
[0m13:59:35.337937 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:59:35.339950 [debug] [MainThread]: Command `dbt run` succeeded at 13:59:35.339950 after 6.83 seconds
[0m13:59:35.339950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FEEB410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FEEB9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C32FC1FE50>]}
[0m13:59:35.340949 [debug] [MainThread]: Flushing usage events
[0m15:02:38.456597 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6F6E6490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6F204690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6EFDC990>]}


============================== 15:02:38.456597 | a0e0f01e-728b-4dcc-a6f4-cab77aba3aee ==============================
[0m15:02:38.456597 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:02:38.456597 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select try', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:02:38.857749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a0e0f01e-728b-4dcc-a6f4-cab77aba3aee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B70190310>]}
[0m15:02:38.891986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a0e0f01e-728b-4dcc-a6f4-cab77aba3aee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6FFCFA10>]}
[0m15:02:38.893987 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:02:38.905537 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:02:39.034648 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:02:39.034648 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:02:39.050274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a0e0f01e-728b-4dcc-a6f4-cab77aba3aee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B71265910>]}
[0m15:02:39.065906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a0e0f01e-728b-4dcc-a6f4-cab77aba3aee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B701C6750>]}
[0m15:02:39.065906 [info ] [MainThread]: Found 5 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:02:39.065906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a0e0f01e-728b-4dcc-a6f4-cab77aba3aee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6EF4BA50>]}
[0m15:02:39.065906 [info ] [MainThread]: 
[0m15:02:39.065906 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:02:39.065906 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:02:39.080419 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:02:39.080419 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:02:39.080419 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:40.082584 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:02:40.098223 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:02:40.160728 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:02:40.176380 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:02:40.176380 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:02:40.176380 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:02:40.800672 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:02:40.800672 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:02:40.869192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a0e0f01e-728b-4dcc-a6f4-cab77aba3aee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6E9BDD90>]}
[0m15:02:40.869192 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:02:40.869192 [info ] [MainThread]: 
[0m15:02:40.884819 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try
[0m15:02:40.884819 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try ................................ [RUN]
[0m15:02:40.892881 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try'
[0m15:02:40.893866 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try
[0m15:02:40.925066 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try"
[0m15:02:40.925066 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try (compile): 15:02:40.893866 => 15:02:40.925066
[0m15:02:40.925066 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try
[0m15:02:40.972371 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try"
[0m15:02:40.975378 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try"
[0m15:02:40.976372 [debug] [Thread-1 (]: On model.snowflake_dbt1.try: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try"} */
WITH try__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    

    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try__dbt_sp();
[0m15:02:40.977372 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:02:48.718996 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 8.0 seconds
[0m15:02:48.734594 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try (execute): 15:02:40.925066 => 15:02:48.734594
[0m15:02:48.734594 [debug] [Thread-1 (]: On model.snowflake_dbt1.try: Close
[0m15:02:48.803838 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0e0f01e-728b-4dcc-a6f4-cab77aba3aee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B7156E310>]}
[0m15:02:48.803838 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try ........................... [[32mSUCCESS 1[0m in 7.92s]
[0m15:02:48.803838 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try
[0m15:02:48.803838 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:02:48.803838 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:02:48.803838 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:02:48.803838 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try' was properly closed.
[0m15:02:48.819249 [info ] [MainThread]: 
[0m15:02:48.820184 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.75 seconds (9.75s).
[0m15:02:48.822184 [debug] [MainThread]: Command end result
[0m15:02:48.838733 [info ] [MainThread]: 
[0m15:02:48.839732 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:02:48.840740 [info ] [MainThread]: 
[0m15:02:48.842584 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:02:48.842584 [debug] [MainThread]: Command `dbt run` succeeded at 15:02:48.842584 after 10.42 seconds
[0m15:02:48.842584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6E820490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6F6D3F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016B6F6D0CD0>]}
[0m15:02:48.842584 [debug] [MainThread]: Flushing usage events
[0m15:12:41.446818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02E026610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02DF99590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02DF99090>]}


============================== 15:12:41.446818 | 9308e8af-4393-4832-a0a2-feb944be44de ==============================
[0m15:12:41.446818 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:12:41.446818 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select insert', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:12:41.848054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9308e8af-4393-4832-a0a2-feb944be44de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02DFA8A10>]}
[0m15:12:41.863651 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9308e8af-4393-4832-a0a2-feb944be44de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02EF68810>]}
[0m15:12:41.863651 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:12:41.885035 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:12:42.017696 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 2 files added, 0 files changed.
[0m15:12:42.017696 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\describe.py
[0m15:12:42.017696 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\insert.py
[0m15:12:42.017696 [debug] [MainThread]: Partial parsing: deleted file: snowflake_dbt1://models\example\try.py
[0m15:12:42.080209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9308e8af-4393-4832-a0a2-feb944be44de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02E492950>]}
[0m15:12:42.085751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9308e8af-4393-4832-a0a2-feb944be44de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02FFD7F90>]}
[0m15:12:42.085751 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:12:42.085751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9308e8af-4393-4832-a0a2-feb944be44de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02D7B0A50>]}
[0m15:12:42.101389 [info ] [MainThread]: 
[0m15:12:42.101389 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:12:42.101389 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:12:42.120791 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:12:42.121794 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:12:42.123671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:12:43.103148 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:12:43.103148 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:12:43.165657 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:12:43.181075 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:12:43.187586 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:12:43.187586 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:12:43.835798 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:12:43.835798 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:12:43.936278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9308e8af-4393-4832-a0a2-feb944be44de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F030419ED0>]}
[0m15:12:43.936278 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:12:43.936278 [info ] [MainThread]: 
[0m15:12:43.936278 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:12:43.936278 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:12:43.949530 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:12:43.950521 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:12:43.982709 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:12:43.982709 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:12:43.951516 => 15:12:43.982709
[0m15:12:43.989748 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:12:44.026909 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:12:44.030779 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:12:44.031821 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp")

    insert_query = f"insert into {info} values (5,'adad',6666,current_timestamp)"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:12:44.032820 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:12:45.872915 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073e6-0001-0d24-0000-000299e6e64d
[0m15:12:45.873916 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
    snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
    result = self.do_resolve(logical_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
    res = self.do_resolve_with_resolved_children(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
    return self.plan_builder.save_as_table(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
    return get_create_and_insert_plan(child, replace=True)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
    attribute_to_schema_string(child.attributes),
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
    val = self.func(instance)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
    output = analyze_attributes(self.schema_query, self.session)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
    return session._get_result_attributes(sql)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
    return self._conn.get_result_attributes(query)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
    return convert_result_meta_to_attribute(self._cursor.describe(query))
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
    self.execute(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073e6-0001-0d24-0000-000299e6e655: 001003 (42000): SQL compilation error:
syntax error line 1 at position 12 unexpected '<'.
syntax error line 1 at position 37 unexpected '.'.
syntax error line 1 at position 54 unexpected '0x7f5812870be0'.
 in function INSERT__DBT_SP with handler main
[0m15:12:45.874916 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:12:43.989748 => 15:12:45.874916
[0m15:12:45.875916 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:12:45.942088 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073e6-0001-0d24-0000-000299e6e655: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 12 unexpected '<'.
  syntax error line 1 at position 37 unexpected '.'.
  syntax error line 1 at position 54 unexpected '0x7f5812870be0'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:12:45.942088 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9308e8af-4393-4832-a0a2-feb944be44de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F03032F310>]}
[0m15:12:45.942088 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 2.01s]
[0m15:12:45.942088 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:12:45.942088 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:12:45.942088 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:12:45.942088 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:12:45.942088 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:12:45.942088 [info ] [MainThread]: 
[0m15:12:45.942088 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.84 seconds (3.84s).
[0m15:12:45.956241 [debug] [MainThread]: Command end result
[0m15:12:45.969704 [info ] [MainThread]: 
[0m15:12:45.969704 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:12:45.969704 [info ] [MainThread]: 
[0m15:12:45.969704 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073e6-0001-0d24-0000-000299e6e655: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 12 unexpected '<'.
  syntax error line 1 at position 37 unexpected '.'.
  syntax error line 1 at position 54 unexpected '0x7f5812870be0'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:12:45.985442 [info ] [MainThread]: 
[0m15:12:45.987445 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:12:45.990476 [debug] [MainThread]: Command `dbt run` failed at 15:12:45.989448 after 4.56 seconds
[0m15:12:45.990476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02DC9CC50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02E025710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F02DFA9290>]}
[0m15:12:45.991443 [debug] [MainThread]: Flushing usage events
[0m15:17:37.207305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28DB71810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28E331510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28E054C50>]}


============================== 15:17:37.207305 | 36bc85ba-f6a8-4cbf-be32-b783b0e010ec ==============================
[0m15:17:37.207305 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:17:37.207305 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select insert', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:17:37.607468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '36bc85ba-f6a8-4cbf-be32-b783b0e010ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28E80EF10>]}
[0m15:17:37.623097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '36bc85ba-f6a8-4cbf-be32-b783b0e010ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28E5E5010>]}
[0m15:17:37.623097 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:17:37.638721 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:17:37.776437 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:17:37.776437 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\insert.py
[0m15:17:37.838937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '36bc85ba-f6a8-4cbf-be32-b783b0e010ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28E0540D0>]}
[0m15:17:37.854535 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '36bc85ba-f6a8-4cbf-be32-b783b0e010ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28DAB5750>]}
[0m15:17:37.854535 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:17:37.854535 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '36bc85ba-f6a8-4cbf-be32-b783b0e010ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28EB8C810>]}
[0m15:17:37.861097 [info ] [MainThread]: 
[0m15:17:37.861097 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:17:37.861097 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:17:37.880539 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:17:37.881539 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:17:37.882823 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:17:38.825830 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:17:38.841239 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:17:38.910228 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:17:38.925882 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:17:38.925882 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:17:38.925882 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:17:39.679913 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:17:39.695362 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:17:39.779798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '36bc85ba-f6a8-4cbf-be32-b783b0e010ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A2906DC8D0>]}
[0m15:17:39.779798 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:17:39.779798 [info ] [MainThread]: 
[0m15:17:39.799246 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:17:39.800273 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:17:39.802248 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:17:39.804247 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:17:39.835660 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:17:39.835660 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:17:39.804680 => 15:17:39.835660
[0m15:17:39.835660 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:17:39.869044 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:17:39.884853 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:17:39.885866 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp")

    insert_query = f"insert into {info} values (5,'adad',6666,current_timestamp);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:17:39.885866 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:17:41.499242 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073eb-0001-0d24-0000-000299e6e65d
[0m15:17:41.499242 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
    snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
    result = self.do_resolve(logical_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
    res = self.do_resolve_with_resolved_children(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
    return self.plan_builder.save_as_table(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
    return get_create_and_insert_plan(child, replace=True)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
    attribute_to_schema_string(child.attributes),
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
    val = self.func(instance)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
    output = analyze_attributes(self.schema_query, self.session)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
    return session._get_result_attributes(sql)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
    return self._conn.get_result_attributes(query)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
    return convert_result_meta_to_attribute(self._cursor.describe(query))
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
    self.execute(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073eb-0001-0d24-0000-000299e6e665: 001003 (42000): SQL compilation error:
syntax error line 1 at position 12 unexpected '<'.
syntax error line 1 at position 37 unexpected '.'.
syntax error line 1 at position 54 unexpected '0x7ff92ec44be0'.
 in function INSERT__DBT_SP with handler main
[0m15:17:41.499242 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:17:39.835660 => 15:17:41.499242
[0m15:17:41.499242 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:17:41.583809 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073eb-0001-0d24-0000-000299e6e665: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 12 unexpected '<'.
  syntax error line 1 at position 37 unexpected '.'.
  syntax error line 1 at position 54 unexpected '0x7ff92ec44be0'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:17:41.583809 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '36bc85ba-f6a8-4cbf-be32-b783b0e010ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A2908B9390>]}
[0m15:17:41.583809 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 1.78s]
[0m15:17:41.583809 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:17:41.599377 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:17:41.599377 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:17:41.599377 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:17:41.599377 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:17:41.599377 [info ] [MainThread]: 
[0m15:17:41.599377 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.74 seconds (3.74s).
[0m15:17:41.605315 [debug] [MainThread]: Command end result
[0m15:17:41.620769 [info ] [MainThread]: 
[0m15:17:41.621935 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:17:41.623501 [info ] [MainThread]: 
[0m15:17:41.625548 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073eb-0001-0d24-0000-000299e6e665: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 12 unexpected '<'.
  syntax error line 1 at position 37 unexpected '.'.
  syntax error line 1 at position 54 unexpected '0x7ff92ec44be0'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:17:41.636256 [info ] [MainThread]: 
[0m15:17:41.637257 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:17:41.639253 [debug] [MainThread]: Command `dbt run` failed at 15:17:41.639253 after 4.46 seconds
[0m15:17:41.640255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28E7E4E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28DD406D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A28E0D9A10>]}
[0m15:17:41.641256 [debug] [MainThread]: Flushing usage events
[0m15:28:09.582560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469DEE7E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469DA54A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469DAA9C10>]}


============================== 15:28:09.589100 | 1c72a4bc-cd44-4862-a69b-450187c15c83 ==============================
[0m15:28:09.589100 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:28:09.589100 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select insert', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:28:09.983922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1c72a4bc-cd44-4862-a69b-450187c15c83', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469DC3BD10>]}
[0m15:28:09.990460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1c72a4bc-cd44-4862-a69b-450187c15c83', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469D756650>]}
[0m15:28:09.990460 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:28:10.006128 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:28:10.141197 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:28:10.156821 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\insert.py
[0m15:28:10.206753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1c72a4bc-cd44-4862-a69b-450187c15c83', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469DB0BF50>]}
[0m15:28:10.223418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1c72a4bc-cd44-4862-a69b-450187c15c83', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469EAAC6D0>]}
[0m15:28:10.227796 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:28:10.228798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c72a4bc-cd44-4862-a69b-450187c15c83', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469D941F90>]}
[0m15:28:10.230795 [info ] [MainThread]: 
[0m15:28:10.232826 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:28:10.233827 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:28:10.253158 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:28:10.253158 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:28:10.253158 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:28:11.256544 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:28:11.256544 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:28:11.342862 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:28:11.358287 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:28:11.358287 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:28:11.358287 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:28:12.153488 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:28:12.159531 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:28:12.222047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c72a4bc-cd44-4862-a69b-450187c15c83', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469E9A7E50>]}
[0m15:28:12.222047 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:28:12.222047 [info ] [MainThread]: 
[0m15:28:12.222047 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:28:12.237669 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:28:12.240105 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:28:12.241103 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:28:12.273314 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:28:12.279801 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:28:12.242105 => 15:28:12.278813
[0m15:28:12.280808 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:28:12.313537 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:28:12.313537 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:28:12.313537 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp")

    insert_query = f"insert into {info} values (5,'adad',6666,current_timestamp());"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:28:12.313537 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:28:14.025408 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073f6-0001-0d23-0000-000299e6f655
[0m15:28:14.025408 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
    snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
    result = self.do_resolve(logical_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
    res = self.do_resolve_with_resolved_children(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
    return self.plan_builder.save_as_table(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
    return get_create_and_insert_plan(child, replace=True)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
    attribute_to_schema_string(child.attributes),
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
    val = self.func(instance)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
    output = analyze_attributes(self.schema_query, self.session)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
    return session._get_result_attributes(sql)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
    return self._conn.get_result_attributes(query)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
    return convert_result_meta_to_attribute(self._cursor.describe(query))
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
    self.execute(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f6-0001-0d23-0000-000299e6f65d: 001003 (42000): SQL compilation error:
syntax error line 1 at position 12 unexpected '<'.
syntax error line 1 at position 37 unexpected '.'.
syntax error line 1 at position 54 unexpected '0x7faa8a503be0'.
 in function INSERT__DBT_SP with handler main
[0m15:28:14.025408 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:28:12.281801 => 15:28:14.025408
[0m15:28:14.025408 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:28:14.096173 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f6-0001-0d23-0000-000299e6f65d: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 12 unexpected '<'.
  syntax error line 1 at position 37 unexpected '.'.
  syntax error line 1 at position 54 unexpected '0x7faa8a503be0'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:28:14.096173 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c72a4bc-cd44-4862-a69b-450187c15c83', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469E2793D0>]}
[0m15:28:14.096173 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 1.86s]
[0m15:28:14.096173 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:28:14.111591 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:28:14.111591 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:28:14.111591 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:28:14.111591 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:28:14.111591 [info ] [MainThread]: 
[0m15:28:14.111591 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.88 seconds (3.88s).
[0m15:28:14.119333 [debug] [MainThread]: Command end result
[0m15:28:14.134053 [info ] [MainThread]: 
[0m15:28:14.135781 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:28:14.136408 [info ] [MainThread]: 
[0m15:28:14.137894 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f6-0001-0d23-0000-000299e6f65d: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 12 unexpected '<'.
  syntax error line 1 at position 37 unexpected '.'.
  syntax error line 1 at position 54 unexpected '0x7faa8a503be0'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:28:14.147779 [info ] [MainThread]: 
[0m15:28:14.148780 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:28:14.151229 [debug] [MainThread]: Command `dbt run` failed at 15:28:14.151229 after 4.59 seconds
[0m15:28:14.153238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469E9E6BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469D1D53D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002469D757390>]}
[0m15:28:14.154284 [debug] [MainThread]: Flushing usage events
[0m15:28:49.552429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC60FB30D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC6126FA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC6126ED50>]}


============================== 15:28:49.552429 | d1884a46-3982-4546-bd79-90e2dc108163 ==============================
[0m15:28:49.552429 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:28:49.552429 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select insert', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:28:49.951005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd1884a46-3982-4546-bd79-90e2dc108163', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC6172FF50>]}
[0m15:28:49.961692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd1884a46-3982-4546-bd79-90e2dc108163', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC612FB5D0>]}
[0m15:28:49.961692 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:28:49.983116 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:28:50.122201 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:28:50.122201 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\insert.py
[0m15:28:50.169087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd1884a46-3982-4546-bd79-90e2dc108163', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC63217990>]}
[0m15:28:50.200305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd1884a46-3982-4546-bd79-90e2dc108163', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC632C0590>]}
[0m15:28:50.200305 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:28:50.200305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd1884a46-3982-4546-bd79-90e2dc108163', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC610C6690>]}
[0m15:28:50.200305 [info ] [MainThread]: 
[0m15:28:50.206817 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:28:50.206817 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:28:50.223201 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:28:50.224201 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:28:50.225203 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:28:51.152813 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:28:51.159324 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:28:51.238053 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:28:51.238053 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:28:51.238053 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:28:51.238053 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:28:51.876290 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:28:51.891706 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:28:51.976158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd1884a46-3982-4546-bd79-90e2dc108163', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC61754910>]}
[0m15:28:51.976158 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:28:51.976158 [info ] [MainThread]: 
[0m15:28:51.976158 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:28:51.976158 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:28:51.990707 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:28:51.991708 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:28:52.012358 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:28:52.029013 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:28:51.992736 => 15:28:52.012358
[0m15:28:52.029013 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:28:52.062590 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:28:52.062590 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:28:52.062590 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp")

    insert_query = f"insert into EMP values (5,'adad',6666,current_timestamp());"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:28:52.062590 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:28:55.485245 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073f6-0001-0d24-0000-000299e6e671
[0m15:28:55.485245 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f6-0001-0d24-0000-000299e6e681: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m15:28:55.485245 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:28:52.029013 => 15:28:55.485245
[0m15:28:55.485245 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:28:55.547927 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f6-0001-0d24-0000-000299e6e681: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:28:55.547927 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd1884a46-3982-4546-bd79-90e2dc108163', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC621EE010>]}
[0m15:28:55.547927 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 3.57s]
[0m15:28:55.547927 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:28:55.563347 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:28:55.563347 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:28:55.563347 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:28:55.569897 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:28:55.569897 [info ] [MainThread]: 
[0m15:28:55.569897 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.37 seconds (5.37s).
[0m15:28:55.573336 [debug] [MainThread]: Command end result
[0m15:28:55.588214 [info ] [MainThread]: 
[0m15:28:55.589854 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:28:55.590867 [info ] [MainThread]: 
[0m15:28:55.592241 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f6-0001-0d24-0000-000299e6e681: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:28:55.600251 [info ] [MainThread]: 
[0m15:28:55.602256 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:28:55.605252 [debug] [MainThread]: Command `dbt run` failed at 15:28:55.605252 after 6.07 seconds
[0m15:28:55.605252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC603A6890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC60FC0450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC60FC0110>]}
[0m15:28:55.606252 [debug] [MainThread]: Flushing usage events
[0m15:31:10.017777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBFDC0050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBF90A4D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBF6D9A10>]}


============================== 15:31:10.017777 | 62782774-27f5-4dd2-b7a9-c6514435e577 ==============================
[0m15:31:10.017777 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:31:10.017777 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select insert', 'send_anonymous_usage_stats': 'True'}
[0m15:31:10.412265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '62782774-27f5-4dd2-b7a9-c6514435e577', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DC0888C90>]}
[0m15:31:10.430994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '62782774-27f5-4dd2-b7a9-c6514435e577', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBF630BD0>]}
[0m15:31:10.430994 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:31:10.439130 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:31:10.570167 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:31:10.570167 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\insert.py
[0m15:31:10.632708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '62782774-27f5-4dd2-b7a9-c6514435e577', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBFDDB090>]}
[0m15:31:10.648303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '62782774-27f5-4dd2-b7a9-c6514435e577', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DC0848E50>]}
[0m15:31:10.648303 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:31:10.648303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '62782774-27f5-4dd2-b7a9-c6514435e577', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DC18E0210>]}
[0m15:31:10.648303 [info ] [MainThread]: 
[0m15:31:10.648303 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:31:10.648303 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:31:10.681199 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:31:10.682741 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:31:10.683746 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:11.604132 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:31:11.619540 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:31:11.673147 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:31:11.704449 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:31:11.704449 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:31:11.704449 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:12.453048 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:31:12.468499 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:31:12.537661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '62782774-27f5-4dd2-b7a9-c6514435e577', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBD1A2990>]}
[0m15:31:12.553209 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:31:12.553209 [info ] [MainThread]: 
[0m15:31:12.553209 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:31:12.553209 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:31:12.565908 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:31:12.566894 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:31:12.599525 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:31:12.599525 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:31:12.566894 => 15:31:12.599525
[0m15:31:12.599525 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:31:12.642198 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:31:12.645198 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:31:12.646213 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = f"insert into {table} values (5,'adad',6666,current_timestamp());"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:31:12.647198 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:31:15.129603 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073f9-0001-0d23-0000-000299e6f665
[0m15:31:15.129603 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f9-0001-0d23-0000-000299e6f675: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m15:31:15.129603 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:31:12.599525 => 15:31:15.129603
[0m15:31:15.129603 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:31:15.214008 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f9-0001-0d23-0000-000299e6f675: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:31:15.214008 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '62782774-27f5-4dd2-b7a9-c6514435e577', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DC0874BD0>]}
[0m15:31:15.214008 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 2.66s]
[0m15:31:15.214008 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:31:15.229642 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:31:15.229642 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:31:15.229642 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:31:15.229642 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:31:15.229642 [info ] [MainThread]: 
[0m15:31:15.229642 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.58 seconds (4.58s).
[0m15:31:15.237991 [debug] [MainThread]: Command end result
[0m15:31:15.253028 [info ] [MainThread]: 
[0m15:31:15.255552 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:31:15.256551 [info ] [MainThread]: 
[0m15:31:15.257565 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f9-0001-0d23-0000-000299e6f675: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:31:15.265479 [info ] [MainThread]: 
[0m15:31:15.266469 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:31:15.268467 [debug] [MainThread]: Command `dbt run` failed at 15:31:15.268467 after 5.28 seconds
[0m15:31:15.270193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBF97EE90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBF6C1F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028DBEF97F50>]}
[0m15:31:15.270193 [debug] [MainThread]: Flushing usage events
[0m15:31:47.798189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5F372B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5F3E6C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5F371090>]}


============================== 15:31:47.813815 | 622e5766-a366-41ab-8bf8-b8c35a31aa48 ==============================
[0m15:31:47.813815 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:31:47.813815 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select insert', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:31:48.236645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '622e5766-a366-41ab-8bf8-b8c35a31aa48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5F345C10>]}
[0m15:31:48.252280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '622e5766-a366-41ab-8bf8-b8c35a31aa48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5F117F50>]}
[0m15:31:48.252280 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:31:48.273821 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:31:48.394939 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:31:48.394939 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\insert.py
[0m15:31:48.452832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '622e5766-a366-41ab-8bf8-b8c35a31aa48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D61311C50>]}
[0m15:31:48.468464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '622e5766-a366-41ab-8bf8-b8c35a31aa48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5DCF9290>]}
[0m15:31:48.468464 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:31:48.468464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '622e5766-a366-41ab-8bf8-b8c35a31aa48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5F832D90>]}
[0m15:31:48.468464 [info ] [MainThread]: 
[0m15:31:48.484083 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:31:48.484083 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:31:48.501576 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:31:48.501576 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:31:48.502576 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:49.719291 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:31:49.719291 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:31:49.796959 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:31:49.812405 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:31:49.812405 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:31:49.812405 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:50.590283 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:31:50.605698 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:31:50.690049 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '622e5766-a366-41ab-8bf8-b8c35a31aa48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D612E7410>]}
[0m15:31:50.690049 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:31:50.705715 [info ] [MainThread]: 
[0m15:31:50.722825 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:31:50.725822 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:31:50.728853 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:31:50.729852 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:31:50.764854 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:31:50.764854 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:31:50.730820 => 15:31:50.764854
[0m15:31:50.764854 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:31:50.798167 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:31:50.814794 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:31:50.814794 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = f"insert into {table} values (5,'adad',6666);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:31:50.814794 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:31:52.448980 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073f9-0001-0d24-0000-000299e6e695
[0m15:31:52.448980 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
    snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
    result = self.do_resolve(logical_plan)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
    res = self.do_resolve_with_resolved_children(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
    return self.plan_builder.save_as_table(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
    return get_create_and_insert_plan(child, replace=True)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
    attribute_to_schema_string(child.attributes),
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
    val = self.func(instance)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
    output = analyze_attributes(self.schema_query, self.session)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
    return session._get_result_attributes(sql)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
    return self._conn.get_result_attributes(query)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
    return convert_result_meta_to_attribute(self._cursor.describe(query))
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
    self.execute(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f9-0001-0d24-0000-000299e6e69d: 002020 (21S01): SQL compilation error:
Insert value list does not match column list expecting 4 but got 3
 in function INSERT__DBT_SP with handler main
[0m15:31:52.448980 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:31:50.764854 => 15:31:52.448980
[0m15:31:52.448980 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:31:52.511763 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f9-0001-0d24-0000-000299e6e69d: 002020 (21S01): SQL compilation error:
  Insert value list does not match column list expecting 4 but got 3
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:31:52.527150 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '622e5766-a366-41ab-8bf8-b8c35a31aa48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D61844B90>]}
[0m15:31:52.527150 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 1.80s]
[0m15:31:52.527150 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:31:52.527150 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:31:52.527150 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:31:52.527150 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:31:52.527150 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:31:52.527150 [info ] [MainThread]: 
[0m15:31:52.527150 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.04 seconds (4.04s).
[0m15:31:52.539249 [debug] [MainThread]: Command end result
[0m15:31:52.553827 [info ] [MainThread]: 
[0m15:31:52.556032 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:31:52.557043 [info ] [MainThread]: 
[0m15:31:52.559029 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 201, in save_as_table
      snowflake_plan = session._analyzer.resolve(create_table_logic_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 697, in resolve
      result = self.do_resolve(logical_plan)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 740, in do_resolve
      res = self.do_resolve_with_resolved_children(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/analyzer.py", line 897, in do_resolve_with_resolved_children
      return self.plan_builder.save_as_table(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 613, in save_as_table
      return get_create_and_insert_plan(child, replace=True)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 569, in get_create_and_insert_plan
      attribute_to_schema_string(child.attributes),
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/functools.py", line 967, in __get__
      val = self.func(instance)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 250, in attributes
      output = analyze_attributes(self.schema_query, self.session)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/schema_utils.py", line 82, in analyze_attributes
      return session._get_result_attributes(sql)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/session.py", line 1630, in _get_result_attributes
      return self._conn.get_result_attributes(query)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 206, in get_result_attributes
      return convert_result_meta_to_attribute(self._cursor.describe(query))
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 866, in describe
      self.execute(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073f9-0001-0d24-0000-000299e6e69d: 002020 (21S01): SQL compilation error:
  Insert value list does not match column list expecting 4 but got 3
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:31:52.567974 [info ] [MainThread]: 
[0m15:31:52.568972 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:31:52.571623 [debug] [MainThread]: Command `dbt run` failed at 15:31:52.570975 after 4.79 seconds
[0m15:31:52.571623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5F08DAD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5C5FD010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D5EEE2310>]}
[0m15:31:52.573338 [debug] [MainThread]: Flushing usage events
[0m15:32:53.688275 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBDB96F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBD6FA450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBCD78410>]}


============================== 15:32:53.688275 | ac24bd76-f710-4190-a265-998fa7be93e1 ==============================
[0m15:32:53.688275 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:32:53.688275 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select insert', 'send_anonymous_usage_stats': 'True'}
[0m15:32:54.089304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ac24bd76-f710-4190-a265-998fa7be93e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBE5DC8D0>]}
[0m15:32:54.104970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ac24bd76-f710-4190-a265-998fa7be93e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBE6702D0>]}
[0m15:32:54.104970 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:32:54.126464 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:32:54.262371 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:32:54.263343 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:32:54.265034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ac24bd76-f710-4190-a265-998fa7be93e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBF7361D0>]}
[0m15:32:54.280695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ac24bd76-f710-4190-a265-998fa7be93e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBE6AA950>]}
[0m15:32:54.280695 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:32:54.289706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac24bd76-f710-4190-a265-998fa7be93e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBDC0A890>]}
[0m15:32:54.289706 [info ] [MainThread]: 
[0m15:32:54.289706 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:32:54.289706 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:32:54.310836 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:32:54.312179 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:32:54.312179 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:32:55.209042 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:32:55.209042 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:32:55.298653 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:32:55.314274 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:32:55.314274 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:32:55.314274 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:32:56.158300 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:32:56.158300 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:32:56.236445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac24bd76-f710-4190-a265-998fa7be93e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBE64A590>]}
[0m15:32:56.236445 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:32:56.236445 [info ] [MainThread]: 
[0m15:32:56.259151 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:32:56.260151 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:32:56.261165 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:32:56.262151 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:32:56.298871 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:32:56.301197 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:32:56.263149 => 15:32:56.301197
[0m15:32:56.301197 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:32:56.340084 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:32:56.343086 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:32:56.344084 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = f"insert into {table} values (5,'adad',6666);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:32:56.345085 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:33:00.129876 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073fa-0001-0d23-0000-000299e6f6b1
[0m15:33:00.129876 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073fb-0001-0d23-0000-000299e6f6c1: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m15:33:00.129876 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:32:56.301197 => 15:33:00.129876
[0m15:33:00.129876 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:33:00.216252 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073fb-0001-0d23-0000-000299e6f6c1: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:33:00.216252 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ac24bd76-f710-4190-a265-998fa7be93e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBF6A76D0>]}
[0m15:33:00.216252 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 3.96s]
[0m15:33:00.216252 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:33:00.231671 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:33:00.231671 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:33:00.231671 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:33:00.231671 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:33:00.231671 [info ] [MainThread]: 
[0m15:33:00.231671 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.94 seconds (5.94s).
[0m15:33:00.239646 [debug] [MainThread]: Command end result
[0m15:33:00.254468 [info ] [MainThread]: 
[0m15:33:00.255964 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:33:00.256987 [info ] [MainThread]: 
[0m15:33:00.258980 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073fb-0001-0d23-0000-000299e6f6c1: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:33:00.266888 [info ] [MainThread]: 
[0m15:33:00.267884 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:33:00.269885 [debug] [MainThread]: Command `dbt run` failed at 15:33:00.269885 after 6.60 seconds
[0m15:33:00.270886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBD611A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBD499E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026BBD415550>]}
[0m15:33:00.271753 [debug] [MainThread]: Flushing usage events
[0m15:33:21.608112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E752171810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E751C94ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7521700D0>]}


============================== 15:33:21.608112 | 8db33c65-1a85-4b06-9b35-969e138e6215 ==============================
[0m15:33:21.608112 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:33:21.608112 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select insert', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:33:22.000568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8db33c65-1a85-4b06-9b35-969e138e6215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E752C30090>]}
[0m15:33:22.020922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8db33c65-1a85-4b06-9b35-969e138e6215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E752C30090>]}
[0m15:33:22.020922 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:33:22.029042 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:33:22.162230 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:33:22.162230 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\insert.py
[0m15:33:22.217750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8db33c65-1a85-4b06-9b35-969e138e6215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E752C66410>]}
[0m15:33:22.243659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8db33c65-1a85-4b06-9b35-969e138e6215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E753D24950>]}
[0m15:33:22.244650 [info ] [MainThread]: Found 6 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:33:22.245649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8db33c65-1a85-4b06-9b35-969e138e6215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E74F41DF90>]}
[0m15:33:22.247648 [info ] [MainThread]: 
[0m15:33:22.248747 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:33:22.248747 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:33:22.266096 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:33:22.267095 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:33:22.268125 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:33:23.298255 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:33:23.303624 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:33:23.381821 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:33:23.404006 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:33:23.404006 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:33:23.404006 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:33:24.152665 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:33:24.168110 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:33:24.237769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8db33c65-1a85-4b06-9b35-969e138e6215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E751D67650>]}
[0m15:33:24.237769 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:33:24.237769 [info ] [MainThread]: 
[0m15:33:24.237769 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m15:33:24.237769 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m15:33:24.255767 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m15:33:24.255767 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m15:33:24.290907 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m15:33:24.290907 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 15:33:24.256767 => 15:33:24.290907
[0m15:33:24.290907 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m15:33:24.334307 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m15:33:24.334307 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m15:33:24.334307 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = F"insert into {table} values (5,'adad',6666);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m15:33:24.334307 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:33:26.744346 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b073fb-0001-0d23-0000-000299e6f6c9
[0m15:33:26.744346 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073fb-0001-0d23-0000-000299e6f6d9: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m15:33:26.759739 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 15:33:24.290907 => 15:33:26.744346
[0m15:33:26.759739 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m15:33:26.828777 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073fb-0001-0d23-0000-000299e6f6d9: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:33:26.828777 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8db33c65-1a85-4b06-9b35-969e138e6215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7541EF590>]}
[0m15:33:26.828777 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 2.57s]
[0m15:33:26.828777 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m15:33:26.844369 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:33:26.846146 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:33:26.847146 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:33:26.849143 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m15:33:26.850142 [info ] [MainThread]: 
[0m15:33:26.851138 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.60 seconds (4.60s).
[0m15:33:26.854139 [debug] [MainThread]: Command end result
[0m15:33:26.870321 [info ] [MainThread]: 
[0m15:33:26.871318 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:33:26.872317 [info ] [MainThread]: 
[0m15:33:26.873318 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b073fb-0001-0d23-0000-000299e6f6d9: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m15:33:26.881133 [info ] [MainThread]: 
[0m15:33:26.883146 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:33:26.885134 [debug] [MainThread]: Command `dbt run` failed at 15:33:26.885134 after 5.30 seconds
[0m15:33:26.886164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E75196B2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E751BEA0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E752C4ACD0>]}
[0m15:33:26.887166 [debug] [MainThread]: Flushing usage events
[0m15:45:28.673612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468A19810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468A18090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468C34450>]}


============================== 15:45:28.689866 | df3201ae-6ab5-427a-8e7e-09c3e38614fd ==============================
[0m15:45:28.689866 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:45:28.689866 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select try_source', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:45:29.063180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'df3201ae-6ab5-427a-8e7e-09c3e38614fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018469CC6910>]}
[0m15:45:29.094430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'df3201ae-6ab5-427a-8e7e-09c3e38614fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468D14890>]}
[0m15:45:29.094430 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:45:29.094430 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:45:29.232280 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m15:45:29.232280 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\try_source.py
[0m15:45:29.294783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'df3201ae-6ab5-427a-8e7e-09c3e38614fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468A0E9D0>]}
[0m15:45:29.310409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'df3201ae-6ab5-427a-8e7e-09c3e38614fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184691F31D0>]}
[0m15:45:29.316919 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:45:29.316919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'df3201ae-6ab5-427a-8e7e-09c3e38614fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468AEFA90>]}
[0m15:45:29.316919 [info ] [MainThread]: 
[0m15:45:29.316919 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:45:29.316919 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:45:29.339639 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:45:29.340677 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:45:29.341645 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:45:30.365210 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:45:30.365210 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:45:30.433932 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:45:30.449333 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:45:30.449333 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:45:30.449333 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:45:31.096873 [debug] [ThreadPool]: SQL status: SUCCESS 38 in 1.0 seconds
[0m15:45:31.112247 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:45:31.181276 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'df3201ae-6ab5-427a-8e7e-09c3e38614fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468D14CD0>]}
[0m15:45:31.181276 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:45:31.196891 [info ] [MainThread]: 
[0m15:45:31.196891 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m15:45:31.196891 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m15:45:31.207136 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m15:45:31.208124 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m15:45:31.241955 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m15:45:31.245480 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 15:45:31.209125 => 15:45:31.245480
[0m15:45:31.246475 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m15:45:31.275303 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m15:45:31.275303 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m15:45:31.275303 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank")

    return source_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank": "demo_database.demo_schema.bank"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m15:45:31.275303 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:45:35.605845 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m15:45:35.629744 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 15:45:31.246475 => 15:45:35.629744
[0m15:45:35.629744 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m15:45:35.676882 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'df3201ae-6ab5-427a-8e7e-09c3e38614fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018469C784D0>]}
[0m15:45:35.676882 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 4.48s]
[0m15:45:35.676882 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m15:45:35.692257 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:45:35.692257 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:45:35.692257 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:45:35.692257 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m15:45:35.692257 [info ] [MainThread]: 
[0m15:45:35.692257 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.38 seconds (6.38s).
[0m15:45:35.699668 [debug] [MainThread]: Command end result
[0m15:45:35.714544 [info ] [MainThread]: 
[0m15:45:35.716023 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:45:35.717041 [info ] [MainThread]: 
[0m15:45:35.718024 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:45:35.720029 [debug] [MainThread]: Command `dbt run` succeeded at 15:45:35.720029 after 7.06 seconds
[0m15:45:35.721051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468A08AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468AC04D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018468D2C290>]}
[0m15:45:35.721313 [debug] [MainThread]: Flushing usage events
[0m15:46:26.343982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB831FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB081810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB429C50>]}


============================== 15:46:26.343982 | c60c7ab1-b70e-4a56-bf74-8269bee24474 ==============================
[0m15:46:26.343982 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:46:26.359608 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select try_source', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:46:26.761414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c60c7ab1-b70e-4a56-bf74-8269bee24474', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB3D8550>]}
[0m15:46:26.782616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c60c7ab1-b70e-4a56-bf74-8269bee24474', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB3D8550>]}
[0m15:46:26.782616 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:46:26.782616 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:46:26.922905 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:46:26.922905 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m15:46:26.982907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c60c7ab1-b70e-4a56-bf74-8269bee24474', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131ED3940D0>]}
[0m15:46:26.998532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c60c7ab1-b70e-4a56-bf74-8269bee24474', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131ED397650>]}
[0m15:46:26.998532 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:46:26.998532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c60c7ab1-b70e-4a56-bf74-8269bee24474', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EC343AD0>]}
[0m15:46:26.998532 [info ] [MainThread]: 
[0m15:46:26.998532 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:46:26.998532 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:46:27.029100 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:46:27.030760 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:46:27.030760 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:28.000802 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:46:28.000802 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:46:28.085359 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:46:28.100758 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:46:28.100758 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:46:28.100758 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:29.134296 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m15:46:29.134296 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:46:29.208807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c60c7ab1-b70e-4a56-bf74-8269bee24474', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131ED6F13D0>]}
[0m15:46:29.208807 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:46:29.208807 [info ] [MainThread]: 
[0m15:46:29.224428 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m15:46:29.224428 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m15:46:29.231933 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m15:46:29.232919 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m15:46:29.268063 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m15:46:29.270354 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 15:46:29.232919 => 15:46:29.269062
[0m15:46:29.270354 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m15:46:29.311041 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m15:46:29.311041 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m15:46:29.311041 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    return source_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m15:46:29.311041 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:46:32.376045 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m15:46:32.405057 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 15:46:29.271894 => 15:46:32.404055
[0m15:46:32.406021 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m15:46:32.455805 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c60c7ab1-b70e-4a56-bf74-8269bee24474', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131ED80E5D0>]}
[0m15:46:32.455805 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 3.23s]
[0m15:46:32.455805 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m15:46:32.455805 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:46:32.455805 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:46:32.455805 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:46:32.471184 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m15:46:32.472228 [info ] [MainThread]: 
[0m15:46:32.473222 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.47 seconds (5.47s).
[0m15:46:32.475216 [debug] [MainThread]: Command end result
[0m15:46:32.479764 [info ] [MainThread]: 
[0m15:46:32.491406 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:46:32.493406 [info ] [MainThread]: 
[0m15:46:32.494408 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:46:32.496405 [debug] [MainThread]: Command `dbt run` succeeded at 15:46:32.496405 after 6.17 seconds
[0m15:46:32.497406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB3D84D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB810E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000131EB81F9D0>]}
[0m15:46:32.498564 [debug] [MainThread]: Flushing usage events
[0m15:48:03.287956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDE73D950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDDF7CA50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDDF7C6D0>]}


============================== 15:48:03.293464 | 0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2 ==============================
[0m15:48:03.293464 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:48:03.293464 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select try_source', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:48:03.687713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDE267CD0>]}
[0m15:48:03.709857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDF220810>]}
[0m15:48:03.709857 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:48:03.709857 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:48:03.858020 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:48:03.858020 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m15:48:03.914836 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDF256650>]}
[0m15:48:03.927036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDF2624D0>]}
[0m15:48:03.927036 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:48:03.927036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDDFA5010>]}
[0m15:48:03.935097 [info ] [MainThread]: 
[0m15:48:03.935097 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:48:03.935097 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:48:03.956999 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:48:03.956999 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:48:03.956999 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:04.894333 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:48:04.894333 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:48:04.978553 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:48:04.993977 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:48:04.993977 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:48:04.993977 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:05.811840 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m15:48:05.827286 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:48:05.912125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDE167450>]}
[0m15:48:05.912125 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:48:05.927752 [info ] [MainThread]: 
[0m15:48:05.927752 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m15:48:05.927752 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m15:48:05.938524 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m15:48:05.939512 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m15:48:05.970491 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m15:48:05.977101 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 15:48:05.939512 => 15:48:05.977101
[0m15:48:05.977101 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m15:48:06.010412 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m15:48:06.010412 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m15:48:06.010412 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")

    return source_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m15:48:06.010412 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:48:08.534471 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m15:48:08.572136 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 15:48:05.977101 => 15:48:08.572136
[0m15:48:08.587759 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m15:48:08.650267 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c40ad00-76b2-48b5-8eb5-f8491ce4b4c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE06A3150>]}
[0m15:48:08.650267 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 2.72s]
[0m15:48:08.650267 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m15:48:08.656780 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:48:08.656780 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:48:08.656780 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:48:08.656780 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m15:48:08.656780 [info ] [MainThread]: 
[0m15:48:08.656780 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.72 seconds (4.72s).
[0m15:48:08.664580 [debug] [MainThread]: Command end result
[0m15:48:08.680678 [info ] [MainThread]: 
[0m15:48:08.682425 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:48:08.682425 [info ] [MainThread]: 
[0m15:48:08.682425 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:48:08.687558 [debug] [MainThread]: Command `dbt run` succeeded at 15:48:08.687558 after 5.42 seconds
[0m15:48:08.688559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDE1B10D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FED7625090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDE71DF90>]}
[0m15:48:08.688559 [debug] [MainThread]: Flushing usage events
[0m15:48:31.438640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020214229550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020213E4C650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020213A96690>]}


============================== 15:48:31.438640 | 699a61bc-fb57-4942-82a1-9ebab0a83223 ==============================
[0m15:48:31.438640 [info ] [MainThread]: Running with dbt=1.6.6
[0m15:48:31.438640 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select try_source', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:48:31.823966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '699a61bc-fb57-4942-82a1-9ebab0a83223', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020213B1B550>]}
[0m15:48:31.839632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '699a61bc-fb57-4942-82a1-9ebab0a83223', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020214CD0B10>]}
[0m15:48:31.839632 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m15:48:31.862059 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m15:48:31.991963 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:48:31.991963 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m15:48:32.039887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '699a61bc-fb57-4942-82a1-9ebab0a83223', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020215D24150>]}
[0m15:48:32.055548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '699a61bc-fb57-4942-82a1-9ebab0a83223', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020215DB9D50>]}
[0m15:48:32.055548 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m15:48:32.071140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '699a61bc-fb57-4942-82a1-9ebab0a83223', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020214CF3150>]}
[0m15:48:32.071140 [info ] [MainThread]: 
[0m15:48:32.071140 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:48:32.071140 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m15:48:32.094126 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m15:48:32.095988 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m15:48:32.097134 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:33.042320 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m15:48:33.042320 [debug] [ThreadPool]: On list_demo_database: Close
[0m15:48:33.126505 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m15:48:33.126505 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m15:48:33.142175 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m15:48:33.142175 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:33.733327 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m15:48:33.741374 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m15:48:33.820071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '699a61bc-fb57-4942-82a1-9ebab0a83223', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020215DB0990>]}
[0m15:48:33.820071 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m15:48:33.820071 [info ] [MainThread]: 
[0m15:48:33.820071 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m15:48:33.820071 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m15:48:33.835543 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m15:48:33.836538 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m15:48:33.863049 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m15:48:33.863049 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 15:48:33.836538 => 15:48:33.863049
[0m15:48:33.863049 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m15:48:33.913320 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m15:48:33.916321 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m15:48:33.917321 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")

    return target_name


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m15:48:33.918321 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:48:36.545304 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m15:48:36.560697 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 15:48:33.863049 => 15:48:36.560697
[0m15:48:36.576320 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m15:48:36.645360 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '699a61bc-fb57-4942-82a1-9ebab0a83223', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020214CEB810>]}
[0m15:48:36.645360 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 2.83s]
[0m15:48:36.645360 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m15:48:36.645360 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:48:36.645360 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m15:48:36.645360 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m15:48:36.645360 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m15:48:36.645360 [info ] [MainThread]: 
[0m15:48:36.645360 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.57 seconds (4.57s).
[0m15:48:36.662566 [debug] [MainThread]: Command end result
[0m15:48:36.677211 [info ] [MainThread]: 
[0m15:48:36.678209 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:48:36.680208 [info ] [MainThread]: 
[0m15:48:36.681207 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:48:36.683160 [debug] [MainThread]: Command `dbt run` succeeded at 15:48:36.683160 after 5.27 seconds
[0m15:48:36.683905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020213A94890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020213A9F9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020213A9F0D0>]}
[0m15:48:36.684938 [debug] [MainThread]: Flushing usage events
[0m16:06:47.646792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5C6D0950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5BF1F050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5BF1F5D0>]}


============================== 16:06:47.646792 | 92577f44-6841-44ad-8f19-ef48940d4ff3 ==============================
[0m16:06:47.646792 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:06:47.646792 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select try_source', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:06:48.063246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '92577f44-6841-44ad-8f19-ef48940d4ff3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5C208A50>]}
[0m16:06:48.078871 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '92577f44-6841-44ad-8f19-ef48940d4ff3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5CFAF710>]}
[0m16:06:48.078871 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:06:48.100229 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:06:48.232118 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:06:48.232118 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:06:48.232118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '92577f44-6841-44ad-8f19-ef48940d4ff3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5E233010>]}
[0m16:06:48.247744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '92577f44-6841-44ad-8f19-ef48940d4ff3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5E1A04D0>]}
[0m16:06:48.263369 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:06:48.263369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92577f44-6841-44ad-8f19-ef48940d4ff3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5C42CD90>]}
[0m16:06:48.263369 [info ] [MainThread]: 
[0m16:06:48.263369 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:06:48.263369 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:06:48.284965 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:06:48.284965 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:06:48.288303 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:06:49.318395 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:06:49.318395 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:06:49.403415 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:06:49.418425 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:06:49.418425 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:06:49.418425 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:06:50.051381 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:06:50.051381 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:06:50.120108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92577f44-6841-44ad-8f19-ef48940d4ff3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5BF37210>]}
[0m16:06:50.120108 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:06:50.120108 [info ] [MainThread]: 
[0m16:06:50.135747 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:06:50.135747 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:06:50.144883 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:06:50.145910 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:06:50.177579 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:06:50.177579 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:06:50.145910 => 16:06:50.177579
[0m16:06:50.177579 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:06:50.226697 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:06:50.229731 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:06:50.230697 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    print('hello')

    return target_name


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:06:50.231697 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:06:52.925296 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m16:06:52.956562 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:06:50.177579 => 16:06:52.956562
[0m16:06:52.956562 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:06:53.019164 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92577f44-6841-44ad-8f19-ef48940d4ff3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5D0DED50>]}
[0m16:06:53.019164 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 2.88s]
[0m16:06:53.025670 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:06:53.025670 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:06:53.025670 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:06:53.025670 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:06:53.025670 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:06:53.025670 [info ] [MainThread]: 
[0m16:06:53.025670 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.76 seconds (4.76s).
[0m16:06:53.034426 [debug] [MainThread]: Command end result
[0m16:06:53.047089 [info ] [MainThread]: 
[0m16:06:53.047089 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:06:53.047089 [info ] [MainThread]: 
[0m16:06:53.047089 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:06:53.055031 [debug] [MainThread]: Command `dbt run` succeeded at 16:06:53.047089 after 5.43 seconds
[0m16:06:53.055768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5C297250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B554B5090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B5C6B2610>]}
[0m16:06:53.055768 [debug] [MainThread]: Flushing usage events
[0m16:10:54.726028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB4E8BFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB5245990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB51AF550>]}


============================== 16:10:54.742634 | f009f045-695c-435c-8265-01862d5ee253 ==============================
[0m16:10:54.742634 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:10:54.742634 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select try_source', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:10:55.126846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f009f045-695c-435c-8265-01862d5ee253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB50DECD0>]}
[0m16:10:55.151217 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f009f045-695c-435c-8265-01862d5ee253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB4ECAD90>]}
[0m16:10:55.151217 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:10:55.159313 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:10:55.305915 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:10:55.307590 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:10:55.354496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f009f045-695c-435c-8265-01862d5ee253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB715E410>]}
[0m16:10:55.370038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f009f045-695c-435c-8265-01862d5ee253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB60F59D0>]}
[0m16:10:55.370038 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:10:55.370038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f009f045-695c-435c-8265-01862d5ee253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB60073D0>]}
[0m16:10:55.370038 [info ] [MainThread]: 
[0m16:10:55.370038 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:10:55.370038 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:10:55.392671 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:10:55.392671 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:10:55.392671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:10:56.335216 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:10:56.336353 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:10:56.404126 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:10:56.419528 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:10:56.419528 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:10:56.419528 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:10:57.074315 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:10:57.090010 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:10:57.190201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f009f045-695c-435c-8265-01862d5ee253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB4EE76D0>]}
[0m16:10:57.190201 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:10:57.190201 [info ] [MainThread]: 
[0m16:10:57.205819 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:10:57.205819 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:10:57.215025 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:10:57.216025 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:10:57.252021 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:10:57.252021 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:10:57.216025 => 16:10:57.252021
[0m16:10:57.252021 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:10:57.293315 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:10:57.293315 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:10:57.293315 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    
    if source_df.count() > 1:
        result=source_df.count()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:10:57.293315 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:10:59.472897 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07420-0001-0d24-0000-000299e6e785
[0m16:10:59.472897 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 104, in main
  File "_udf_code.py", line 20, in model
UnboundLocalError: local variable 'result' referenced before assignment
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:10:59.472897 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:10:57.252021 => 16:10:59.472897
[0m16:10:59.472897 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:10:59.557078 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 20, in model
  UnboundLocalError: local variable 'result' referenced before assignment
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:10:59.557078 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f009f045-695c-435c-8265-01862d5ee253', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB71A1290>]}
[0m16:10:59.557078 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 2.35s]
[0m16:10:59.572999 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:10:59.572999 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:10:59.572999 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:10:59.572999 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:10:59.572999 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:10:59.572999 [info ] [MainThread]: 
[0m16:10:59.572999 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.20 seconds (4.20s).
[0m16:10:59.582176 [debug] [MainThread]: Command end result
[0m16:10:59.597595 [info ] [MainThread]: 
[0m16:10:59.599179 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:10:59.600178 [info ] [MainThread]: 
[0m16:10:59.601177 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 20, in model
  UnboundLocalError: local variable 'result' referenced before assignment
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:10:59.603176 [info ] [MainThread]: 
[0m16:10:59.604442 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:10:59.606668 [debug] [MainThread]: Command `dbt run` failed at 16:10:59.606668 after 4.89 seconds
[0m16:10:59.607667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB5671D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB52452D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CB4F984D0>]}
[0m16:10:59.609676 [debug] [MainThread]: Flushing usage events
[0m16:11:25.697002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134420B5E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134419A3FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013441CBD9D0>]}


============================== 16:11:25.697002 | 0b996817-acef-48d1-87e5-19f0f26a98b3 ==============================
[0m16:11:25.697002 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:11:25.697002 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select try_source', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:11:26.091354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0b996817-acef-48d1-87e5-19f0f26a98b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013441BEED90>]}
[0m16:11:26.097861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0b996817-acef-48d1-87e5-19f0f26a98b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013441930790>]}
[0m16:11:26.097861 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:11:26.113495 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:11:26.255369 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:11:26.255369 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:11:26.314263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0b996817-acef-48d1-87e5-19f0f26a98b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013441931450>]}
[0m16:11:26.329859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0b996817-acef-48d1-87e5-19f0f26a98b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013443B95D90>]}
[0m16:11:26.329859 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:11:26.329859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b996817-acef-48d1-87e5-19f0f26a98b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134419EAE50>]}
[0m16:11:26.329859 [info ] [MainThread]: 
[0m16:11:26.329859 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:11:26.329859 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:11:26.358679 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:11:26.358679 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:11:26.359678 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:11:27.347539 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:11:27.347539 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:11:27.439890 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:11:27.441561 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:11:27.441561 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:11:27.441561 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:11:28.074839 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:11:28.074839 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:11:28.143477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b996817-acef-48d1-87e5-19f0f26a98b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001343AD327D0>]}
[0m16:11:28.143477 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:11:28.159119 [info ] [MainThread]: 
[0m16:11:28.159119 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:11:28.159119 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:11:28.168746 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:11:28.169762 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:11:28.202179 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:11:28.202179 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:11:28.170746 => 16:11:28.202179
[0m16:11:28.208861 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:11:28.287193 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:11:28.290192 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:11:28.291178 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    
    
    result=source_df.count()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:11:28.292195 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:11:30.108039 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07421-0001-0d24-0000-000299e6e791
[0m16:11:30.108039 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 105, in main
  File "_udf_code.py", line 100, in materialize
AttributeError: 'int' object has no attribute 'write'
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:11:30.123680 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:11:28.209850 => 16:11:30.108039
[0m16:11:30.123680 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:11:30.178860 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 105, in main
    File "_udf_code.py", line 100, in materialize
  AttributeError: 'int' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:11:30.178860 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b996817-acef-48d1-87e5-19f0f26a98b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134440B4BD0>]}
[0m16:11:30.178860 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 2.02s]
[0m16:11:30.178860 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:11:30.178860 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:11:30.178860 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:11:30.178860 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:11:30.178860 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:11:30.178860 [info ] [MainThread]: 
[0m16:11:30.194451 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.85 seconds (3.85s).
[0m16:11:30.196502 [debug] [MainThread]: Command end result
[0m16:11:30.211716 [info ] [MainThread]: 
[0m16:11:30.214281 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:11:30.215022 [info ] [MainThread]: 
[0m16:11:30.216308 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 105, in main
    File "_udf_code.py", line 100, in materialize
  AttributeError: 'int' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:11:30.219318 [info ] [MainThread]: 
[0m16:11:30.220560 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:11:30.220560 [debug] [MainThread]: Command `dbt run` failed at 16:11:30.220560 after 4.55 seconds
[0m16:11:30.220560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134419D5850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001344133FB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001343EF5FF90>]}
[0m16:11:30.220560 [debug] [MainThread]: Flushing usage events
[0m16:17:19.747182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A143D9990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A1366FA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A143CFBD0>]}


============================== 16:17:19.747182 | be2d2a39-a7c0-43dc-8785-2c548185b450 ==============================
[0m16:17:19.747182 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:17:19.747182 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select try_source', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:17:20.147046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'be2d2a39-a7c0-43dc-8785-2c548185b450', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A143CEF10>]}
[0m16:17:20.162673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'be2d2a39-a7c0-43dc-8785-2c548185b450', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A1486F490>]}
[0m16:17:20.162673 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:17:20.182980 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:17:20.311150 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:17:20.311150 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:17:20.358062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'be2d2a39-a7c0-43dc-8785-2c548185b450', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A143F2550>]}
[0m16:17:20.384729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'be2d2a39-a7c0-43dc-8785-2c548185b450', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A13C529D0>]}
[0m16:17:20.384729 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:17:20.384729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be2d2a39-a7c0-43dc-8785-2c548185b450', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A143F1D90>]}
[0m16:17:20.384729 [info ] [MainThread]: 
[0m16:17:20.384729 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:17:20.384729 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:17:20.415332 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:17:20.416533 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:17:20.416533 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:17:21.480499 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:17:21.487073 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:17:21.565275 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:17:21.565275 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:17:21.580876 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:17:21.580876 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:17:22.351372 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:17:22.351372 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:17:22.428120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be2d2a39-a7c0-43dc-8785-2c548185b450', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A1629C8D0>]}
[0m16:17:22.428120 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:17:22.428120 [info ] [MainThread]: 
[0m16:17:22.443778 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:17:22.443778 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:17:22.453401 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:17:22.454399 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:17:22.489077 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:17:22.489077 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:17:22.454399 => 16:17:22.489077
[0m16:17:22.489077 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:17:22.532726 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:17:22.535728 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:17:22.536726 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    
    
    result=source_df.describe()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:17:22.537726 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:17:28.403143 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 6.0 seconds
[0m16:17:28.434161 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:17:22.489077 => 16:17:28.434161
[0m16:17:28.434161 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:17:28.503192 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'be2d2a39-a7c0-43dc-8785-2c548185b450', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A14E7A250>]}
[0m16:17:28.503192 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 6.06s]
[0m16:17:28.503192 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:17:28.503192 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:17:28.503192 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:17:28.503192 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:17:28.503192 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:17:28.503192 [info ] [MainThread]: 
[0m16:17:28.503192 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.12 seconds (8.12s).
[0m16:17:28.518171 [debug] [MainThread]: Command end result
[0m16:17:28.531947 [info ] [MainThread]: 
[0m16:17:28.533951 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:17:28.534481 [info ] [MainThread]: 
[0m16:17:28.534481 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:17:28.534481 [debug] [MainThread]: Command `dbt run` succeeded at 16:17:28.534481 after 8.82 seconds
[0m16:17:28.534481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A13920450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A13E62550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014A143BBD50>]}
[0m16:17:28.534481 [debug] [MainThread]: Flushing usage events
[0m16:22:29.608028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020591452B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020591463610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020591461F50>]}


============================== 16:22:29.608028 | 4a62960e-5266-45ea-9e39-e3f1d49cfe1c ==============================
[0m16:22:29.608028 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:22:29.624583 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select try_source', 'send_anonymous_usage_stats': 'True'}
[0m16:22:30.009221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4a62960e-5266-45ea-9e39-e3f1d49cfe1c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002059194E590>]}
[0m16:22:30.024888 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4a62960e-5266-45ea-9e39-e3f1d49cfe1c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002059220F150>]}
[0m16:22:30.024888 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:22:30.040482 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:22:30.180586 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:22:30.180586 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:22:30.240488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4a62960e-5266-45ea-9e39-e3f1d49cfe1c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020593425C10>]}
[0m16:22:30.256112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4a62960e-5266-45ea-9e39-e3f1d49cfe1c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205934E1D50>]}
[0m16:22:30.256112 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:22:30.256112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a62960e-5266-45ea-9e39-e3f1d49cfe1c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002058EE95E50>]}
[0m16:22:30.256112 [info ] [MainThread]: 
[0m16:22:30.256112 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:22:30.256112 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:22:30.283244 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:22:30.283244 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:22:30.283244 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:22:31.267908 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:22:31.267908 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:22:31.352396 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:22:31.352396 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:22:31.352396 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:22:31.352396 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:22:31.953862 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:22:31.969532 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:22:32.032250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a62960e-5266-45ea-9e39-e3f1d49cfe1c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205912B7090>]}
[0m16:22:32.032250 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:22:32.032250 [info ] [MainThread]: 
[0m16:22:32.054132 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:22:32.054132 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:22:32.056668 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:22:32.057668 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:22:32.091685 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:22:32.091685 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:22:32.058667 => 16:22:32.091685
[0m16:22:32.091685 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:22:32.132885 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:22:32.132885 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:22:32.132885 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    
    ans='true'

    if ans=='true':
        result=source_df.describe()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:22:32.132885 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:22:37.846714 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 6.0 seconds
[0m16:22:37.882901 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:22:32.097081 => 16:22:37.882901
[0m16:22:37.882901 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:22:37.929857 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a62960e-5266-45ea-9e39-e3f1d49cfe1c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205923723D0>]}
[0m16:22:37.929857 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 5.88s]
[0m16:22:37.929857 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:22:37.945402 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:22:37.945402 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:22:37.945402 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:22:37.945402 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:22:37.945402 [info ] [MainThread]: 
[0m16:22:37.945402 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.69 seconds (7.69s).
[0m16:22:37.952828 [debug] [MainThread]: Command end result
[0m16:22:37.967784 [info ] [MainThread]: 
[0m16:22:37.968783 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:22:37.970784 [info ] [MainThread]: 
[0m16:22:37.971786 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:22:37.974795 [debug] [MainThread]: Command `dbt run` succeeded at 16:22:37.974795 after 8.38 seconds
[0m16:22:37.975787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020590D3E150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205919118D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020591463690>]}
[0m16:22:37.975787 [debug] [MainThread]: Flushing usage events
[0m16:34:51.643827 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002804027A8D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000280402FA8D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002804025EE90>]}


============================== 16:34:51.659452 | 3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e ==============================
[0m16:34:51.659452 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:34:51.659452 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select try_source', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:34:52.049993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028040173890>]}
[0m16:34:52.066654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002804076B450>]}
[0m16:34:52.066654 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:34:52.086045 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:34:52.213877 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:34:52.213877 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:34:52.267334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028041242790>]}
[0m16:34:52.283003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002804233DF10>]}
[0m16:34:52.283003 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:34:52.283003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002803DC7FED0>]}
[0m16:34:52.283003 [info ] [MainThread]: 
[0m16:34:52.283003 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:34:52.298599 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:34:52.314225 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:34:52.315034 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:34:52.316067 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:34:53.363178 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:34:53.378622 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:34:53.479007 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:34:53.500997 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:34:53.500997 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:34:53.500997 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:34:54.166733 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:34:54.166733 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:34:54.249684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028040265410>]}
[0m16:34:54.249684 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:34:54.249684 [info ] [MainThread]: 
[0m16:34:54.268185 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:34:54.269214 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:34:54.272185 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:34:54.273345 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:34:54.304013 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:34:54.304013 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:34:54.273345 => 16:34:54.304013
[0m16:34:54.304013 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:34:54.353252 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:34:54.354272 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:34:54.354272 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.columns

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:34:54.354272 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:34:56.070857 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07438-0001-0d24-0000-000299e6e7f1
[0m16:34:56.070857 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
AttributeError: 'list' object has no attribute 'write'
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:34:56.070857 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:34:54.304013 => 16:34:56.070857
[0m16:34:56.070857 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:34:56.154028 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
  AttributeError: 'list' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:34:56.154028 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3fc8b90e-b0b5-47d0-8f38-98d7cbd11f0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002804004E750>]}
[0m16:34:56.154028 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 1.88s]
[0m16:34:56.154028 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:34:56.154028 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:34:56.154028 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:34:56.154028 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:34:56.154028 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:34:56.154028 [info ] [MainThread]: 
[0m16:34:56.154028 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.87 seconds (3.87s).
[0m16:34:56.170222 [debug] [MainThread]: Command end result
[0m16:34:56.185220 [info ] [MainThread]: 
[0m16:34:56.185767 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:34:56.187781 [info ] [MainThread]: 
[0m16:34:56.189780 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
  AttributeError: 'list' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:34:56.192778 [info ] [MainThread]: 
[0m16:34:56.194781 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:34:56.196780 [debug] [MainThread]: Command `dbt run` failed at 16:34:56.196780 after 4.56 seconds
[0m16:34:56.197779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002803FF90690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002803FF6A650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002803FF69110>]}
[0m16:34:56.198779 [debug] [MainThread]: Flushing usage events
[0m16:35:12.962022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F05FE50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2EB88690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2EC6DAD0>]}


============================== 16:35:12.972054 | fa3ffa43-a24b-450a-bb82-52e4abc8e5e3 ==============================
[0m16:35:12.972054 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:35:12.972054 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select try_source', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:35:13.351568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fa3ffa43-a24b-450a-bb82-52e4abc8e5e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2FB3DC10>]}
[0m16:35:13.383037 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fa3ffa43-a24b-450a-bb82-52e4abc8e5e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2FB28710>]}
[0m16:35:13.383037 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:35:13.393218 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:35:13.524344 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:35:13.524344 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:35:13.571232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fa3ffa43-a24b-450a-bb82-52e4abc8e5e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2FB16310>]}
[0m16:35:13.586860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fa3ffa43-a24b-450a-bb82-52e4abc8e5e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2E35BD50>]}
[0m16:35:13.586860 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:35:13.602509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa3ffa43-a24b-450a-bb82-52e4abc8e5e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2EBC4C90>]}
[0m16:35:13.602509 [info ] [MainThread]: 
[0m16:35:13.602509 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:35:13.602509 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:35:13.625042 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:35:13.625042 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:35:13.625042 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:14.526989 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:35:14.542632 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:35:14.605374 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:35:14.627304 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:35:14.627304 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:35:14.627304 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:15.254064 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:35:15.269742 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:35:15.360165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa3ffa43-a24b-450a-bb82-52e4abc8e5e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2E9FA390>]}
[0m16:35:15.360165 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:35:15.375783 [info ] [MainThread]: 
[0m16:35:15.375783 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:35:15.375783 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:35:15.385215 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:35:15.386228 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:35:15.420877 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:35:15.420877 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:35:15.387214 => 16:35:15.420877
[0m16:35:15.420877 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:35:15.454214 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:35:15.454214 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:35:15.471130 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.shape

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:35:15.471130 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:35:17.370903 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07439-0001-0d23-0000-000299e6f7e9
[0m16:35:17.370903 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 21, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute shape
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:35:17.370903 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:35:15.420877 => 16:35:17.370903
[0m16:35:17.370903 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:35:17.464648 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute shape
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:35:17.464648 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa3ffa43-a24b-450a-bb82-52e4abc8e5e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2E32BB50>]}
[0m16:35:17.464648 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 2.09s]
[0m16:35:17.464648 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:35:17.464648 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:35:17.464648 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:35:17.464648 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:35:17.464648 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:35:17.464648 [info ] [MainThread]: 
[0m16:35:17.464648 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.86 seconds (3.86s).
[0m16:35:17.480679 [debug] [MainThread]: Command end result
[0m16:35:17.493478 [info ] [MainThread]: 
[0m16:35:17.493478 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:35:17.493478 [info ] [MainThread]: 
[0m16:35:17.493478 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute shape
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:35:17.502921 [info ] [MainThread]: 
[0m16:35:17.503924 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:35:17.505936 [debug] [MainThread]: Command `dbt run` failed at 16:35:17.505936 after 4.56 seconds
[0m16:35:17.506945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2EB887D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2FAED510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2E984A90>]}
[0m16:35:17.507949 [debug] [MainThread]: Flushing usage events
[0m16:35:36.830256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B32665CD50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B326195990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B326194610>]}


============================== 16:35:36.830256 | 2f9d7b41-9e22-4db4-8b4d-0d6e8526865d ==============================
[0m16:35:36.830256 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:35:36.830256 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select try_source', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:35:37.230921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2f9d7b41-9e22-4db4-8b4d-0d6e8526865d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B32666DB50>]}
[0m16:35:37.252118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2f9d7b41-9e22-4db4-8b4d-0d6e8526865d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3252F6ED0>]}
[0m16:35:37.253662 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:35:37.261231 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:35:37.392750 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:35:37.392750 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:35:37.439669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2f9d7b41-9e22-4db4-8b4d-0d6e8526865d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B327153990>]}
[0m16:35:37.455296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2f9d7b41-9e22-4db4-8b4d-0d6e8526865d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B32663D510>]}
[0m16:35:37.471045 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:35:37.471553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2f9d7b41-9e22-4db4-8b4d-0d6e8526865d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B325DE0790>]}
[0m16:35:37.471553 [info ] [MainThread]: 
[0m16:35:37.471553 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:35:37.471553 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:35:37.493441 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:35:37.493441 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:35:37.493441 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:38.408798 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:35:38.408798 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:35:38.477516 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:35:38.493144 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:35:38.493144 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:35:38.493144 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:39.094649 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:35:39.094649 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:35:39.194748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2f9d7b41-9e22-4db4-8b4d-0d6e8526865d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B325EC5490>]}
[0m16:35:39.194748 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:35:39.194748 [info ] [MainThread]: 
[0m16:35:39.213121 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:35:39.214145 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:35:39.216877 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:35:39.216877 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:35:39.247818 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:35:39.255632 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:35:39.216877 => 16:35:39.254625
[0m16:35:39.256610 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:35:39.294986 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:35:39.297984 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:35:39.298986 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    # dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.shape

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:35:39.299986 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:35:40.950861 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07439-0001-0d24-0000-000299e6e809
[0m16:35:40.950861 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 21, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute shape
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:35:40.950861 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:35:39.256610 => 16:35:40.950861
[0m16:35:40.950861 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:35:41.013372 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute shape
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:35:41.013372 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f9d7b41-9e22-4db4-8b4d-0d6e8526865d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B328676CD0>]}
[0m16:35:41.013372 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 1.80s]
[0m16:35:41.013372 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:35:41.013372 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:35:41.013372 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:35:41.013372 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:35:41.013372 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:35:41.013372 [info ] [MainThread]: 
[0m16:35:41.028997 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.54 seconds (3.54s).
[0m16:35:41.031037 [debug] [MainThread]: Command end result
[0m16:35:41.046836 [info ] [MainThread]: 
[0m16:35:41.047919 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:35:41.048937 [info ] [MainThread]: 
[0m16:35:41.050183 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute shape
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:35:41.053604 [info ] [MainThread]: 
[0m16:35:41.055647 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:35:41.057634 [debug] [MainThread]: Command `dbt run` failed at 16:35:41.056606 after 4.24 seconds
[0m16:35:41.057634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B326194DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B326197090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B326197690>]}
[0m16:35:41.058603 [debug] [MainThread]: Flushing usage events
[0m16:35:55.885754 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C23815D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C1BA9810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C1F29A50>]}


============================== 16:35:55.885754 | 4acc313d-5935-4e44-a2e1-91cf8b8d636d ==============================
[0m16:35:55.885754 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:35:55.885754 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select try_source', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:35:56.287184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4acc313d-5935-4e44-a2e1-91cf8b8d636d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C2E7CB90>]}
[0m16:35:56.302820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4acc313d-5935-4e44-a2e1-91cf8b8d636d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C2E5A1D0>]}
[0m16:35:56.302820 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:35:56.322332 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:35:56.452544 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:35:56.452544 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:35:56.502942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4acc313d-5935-4e44-a2e1-91cf8b8d636d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C239A150>]}
[0m16:35:56.518567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4acc313d-5935-4e44-a2e1-91cf8b8d636d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C1BA9410>]}
[0m16:35:56.518567 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:35:56.518567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4acc313d-5935-4e44-a2e1-91cf8b8d636d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C1A22590>]}
[0m16:35:56.518567 [info ] [MainThread]: 
[0m16:35:56.518567 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:35:56.518567 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:35:56.543658 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:35:56.543658 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:35:56.543658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:57.467741 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:35:57.467741 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:35:57.536528 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:35:57.552152 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:35:57.552152 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:35:57.552152 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:35:58.322866 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:35:58.330866 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:35:58.423388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4acc313d-5935-4e44-a2e1-91cf8b8d636d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C431BF50>]}
[0m16:35:58.423388 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:35:58.423388 [info ] [MainThread]: 
[0m16:35:58.423388 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:35:58.423388 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:35:58.439443 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:35:58.440443 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:35:58.495062 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:35:58.495062 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:35:58.440443 => 16:35:58.495062
[0m16:35:58.495062 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:35:58.538870 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:35:58.538870 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:35:58.538870 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    # dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.describe()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:35:58.538870 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:36:03.183696 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 5.0 seconds
[0m16:36:03.204661 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:35:58.495062 => 16:36:03.204661
[0m16:36:03.220330 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:36:03.282800 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4acc313d-5935-4e44-a2e1-91cf8b8d636d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C4361150>]}
[0m16:36:03.282800 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 4.84s]
[0m16:36:03.282800 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:36:03.282800 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:36:03.282800 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:36:03.282800 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:36:03.282800 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:36:03.282800 [info ] [MainThread]: 
[0m16:36:03.282800 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.76 seconds (6.76s).
[0m16:36:03.297315 [debug] [MainThread]: Command end result
[0m16:36:03.310683 [info ] [MainThread]: 
[0m16:36:03.310683 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:36:03.310683 [info ] [MainThread]: 
[0m16:36:03.310683 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:36:03.310683 [debug] [MainThread]: Command `dbt run` succeeded at 16:36:03.310683 after 7.45 seconds
[0m16:36:03.310683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C1C419D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C1F66AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000255C2361CD0>]}
[0m16:36:03.310683 [debug] [MainThread]: Flushing usage events
[0m16:36:46.466184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1032D010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1032DA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1032F710>]}


============================== 16:36:46.471183 | cc907526-e89f-4fa5-87b6-505c86ef3a8a ==============================
[0m16:36:46.471183 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:36:46.472192 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select try_source', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:36:46.890234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc907526-e89f-4fa5-87b6-505c86ef3a8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C10DF7150>]}
[0m16:36:46.910265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc907526-e89f-4fa5-87b6-505c86ef3a8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C0FC09210>]}
[0m16:36:46.912235 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:36:46.924266 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:36:47.063236 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:36:47.064237 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:36:47.071235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cc907526-e89f-4fa5-87b6-505c86ef3a8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C11EE6C50>]}
[0m16:36:47.089237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cc907526-e89f-4fa5-87b6-505c86ef3a8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C11E36090>]}
[0m16:36:47.090236 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:36:47.091308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc907526-e89f-4fa5-87b6-505c86ef3a8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C0FC09590>]}
[0m16:36:47.093352 [info ] [MainThread]: 
[0m16:36:47.095319 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:36:47.097029 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:36:47.115071 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:36:47.116077 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:36:47.116077 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:36:48.105684 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:36:48.110680 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:36:48.179109 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:36:48.189107 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:36:48.190108 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:36:48.191108 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:36:48.846283 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:36:48.851287 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:36:48.931489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc907526-e89f-4fa5-87b6-505c86ef3a8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C0FC08FD0>]}
[0m16:36:48.933455 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:36:48.934457 [info ] [MainThread]: 
[0m16:36:48.943786 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:36:48.944786 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:36:48.945785 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:36:48.946786 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:36:48.982786 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:36:48.983785 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:36:48.947811 => 16:36:48.983785
[0m16:36:48.984786 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:36:49.022530 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:36:49.022530 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:36:49.022530 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    # dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.describe()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:36:49.022530 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:36:53.451287 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m16:36:53.471374 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:36:48.985786 => 16:36:53.471374
[0m16:36:53.471374 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:36:53.534047 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cc907526-e89f-4fa5-87b6-505c86ef3a8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C12073890>]}
[0m16:36:53.534047 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 4.59s]
[0m16:36:53.534047 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:36:53.534047 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:36:53.534047 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:36:53.549684 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:36:53.550732 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:36:53.551735 [info ] [MainThread]: 
[0m16:36:53.553733 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.46 seconds (6.46s).
[0m16:36:53.555729 [debug] [MainThread]: Command end result
[0m16:36:53.566797 [info ] [MainThread]: 
[0m16:36:53.571558 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:36:53.571558 [info ] [MainThread]: 
[0m16:36:53.571558 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:36:53.571558 [debug] [MainThread]: Command `dbt run` succeeded at 16:36:53.571558 after 7.14 seconds
[0m16:36:53.578996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C0FE47A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C0FE285D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C0FD91050>]}
[0m16:36:53.580027 [debug] [MainThread]: Flushing usage events
[0m16:37:12.502578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954C0A2150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954BAF3610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954B4CDB10>]}


============================== 16:37:12.518233 | d6cc6c14-ef32-48d0-b2df-16a7eaa8adde ==============================
[0m16:37:12.518233 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:37:12.518233 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select try_source', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:37:12.903770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd6cc6c14-ef32-48d0-b2df-16a7eaa8adde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954CB6A810>]}
[0m16:37:12.919401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd6cc6c14-ef32-48d0-b2df-16a7eaa8adde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954BC68490>]}
[0m16:37:12.919401 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:37:12.941534 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:37:13.072797 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:37:13.072797 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:37:13.119677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd6cc6c14-ef32-48d0-b2df-16a7eaa8adde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954B3B0810>]}
[0m16:37:13.141804 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd6cc6c14-ef32-48d0-b2df-16a7eaa8adde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954B98B0D0>]}
[0m16:37:13.141804 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:37:13.141804 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd6cc6c14-ef32-48d0-b2df-16a7eaa8adde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954AD37510>]}
[0m16:37:13.141804 [info ] [MainThread]: 
[0m16:37:13.157439 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:37:13.157439 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:37:13.174905 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:37:13.175905 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:37:13.176903 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:37:14.136566 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:37:14.136566 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:37:14.199320 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:37:14.214747 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:37:14.214747 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:37:14.214747 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:37:14.985316 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:37:14.985316 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:37:15.069850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd6cc6c14-ef32-48d0-b2df-16a7eaa8adde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954B8ABE10>]}
[0m16:37:15.069850 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:37:15.069850 [info ] [MainThread]: 
[0m16:37:15.086426 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:37:15.087441 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:37:15.089426 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:37:15.090423 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:37:15.121966 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:37:15.121966 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:37:15.090423 => 16:37:15.121966
[0m16:37:15.121966 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:37:15.172294 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:37:15.172294 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:37:15.172294 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    # dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.count()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:37:15.172294 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:37:16.873862 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0743b-0001-0d23-0000-000299e6f849
[0m16:37:16.873862 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
AttributeError: 'int' object has no attribute 'write'
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:37:16.873862 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:37:15.121966 => 16:37:16.873862
[0m16:37:16.889608 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:37:16.974170 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
  AttributeError: 'int' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:37:16.974170 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6cc6c14-ef32-48d0-b2df-16a7eaa8adde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954DC47E90>]}
[0m16:37:16.974170 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 1.89s]
[0m16:37:16.974170 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:37:16.989785 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:37:16.989785 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:37:16.989785 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:37:16.989785 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:37:16.989785 [info ] [MainThread]: 
[0m16:37:16.989785 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.85 seconds (3.85s).
[0m16:37:16.995769 [debug] [MainThread]: Command end result
[0m16:37:17.009462 [info ] [MainThread]: 
[0m16:37:17.010913 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:37:17.012080 [info ] [MainThread]: 
[0m16:37:17.013432 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
  AttributeError: 'int' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:37:17.015705 [info ] [MainThread]: 
[0m16:37:17.016717 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:37:17.017992 [debug] [MainThread]: Command `dbt run` failed at 16:37:17.017992 after 4.53 seconds
[0m16:37:17.017992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954C08FA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954C08F010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001954C08F2D0>]}
[0m16:37:17.017992 [debug] [MainThread]: Flushing usage events
[0m16:37:54.336198 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA1F7250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E9F17A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA1F6C90>]}


============================== 16:37:54.336198 | a71edb76-a09d-4ea2-8518-9fb73a45a545 ==============================
[0m16:37:54.336198 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:37:54.336198 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select try_source', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:37:54.737434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a71edb76-a09d-4ea2-8518-9fb73a45a545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA158A90>]}
[0m16:37:54.753090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a71edb76-a09d-4ea2-8518-9fb73a45a545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA650250>]}
[0m16:37:54.753090 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:37:54.753090 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:37:54.906410 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:37:54.906410 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:37:54.953292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a71edb76-a09d-4ea2-8518-9fb73a45a545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EC0F7C50>]}
[0m16:37:54.968881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a71edb76-a09d-4ea2-8518-9fb73a45a545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA651210>]}
[0m16:37:54.968881 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:37:54.968881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a71edb76-a09d-4ea2-8518-9fb73a45a545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E985E590>]}
[0m16:37:54.984507 [info ] [MainThread]: 
[0m16:37:54.984507 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:37:54.991020 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:37:55.010798 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:37:55.011795 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:37:55.013585 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:37:55.952406 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:37:55.952406 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:37:56.025083 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:37:56.040482 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:37:56.040482 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:37:56.040482 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:37:56.773547 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:37:56.788993 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:37:56.858274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a71edb76-a09d-4ea2-8518-9fb73a45a545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA63D990>]}
[0m16:37:56.858274 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:37:56.858274 [info ] [MainThread]: 
[0m16:37:56.858274 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:37:56.858274 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:37:56.871817 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:37:56.872803 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:37:56.907489 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:37:56.907489 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:37:56.872803 => 16:37:56.907489
[0m16:37:56.907489 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:37:56.950117 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:37:56.953116 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:37:56.954087 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.count()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:37:56.955085 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:37:58.663709 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0743b-0001-0d24-0000-000299e6e861
[0m16:37:58.663709 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
AttributeError: 'int' object has no attribute 'write'
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:37:58.679132 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:37:56.907489 => 16:37:58.679132
[0m16:37:58.679132 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:37:58.748157 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
  AttributeError: 'int' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:37:58.748157 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a71edb76-a09d-4ea2-8518-9fb73a45a545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E9E78E50>]}
[0m16:37:58.748157 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 1.89s]
[0m16:37:58.748157 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:37:58.748157 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:37:58.748157 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:37:58.748157 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:37:58.748157 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:37:58.748157 [info ] [MainThread]: 
[0m16:37:58.748157 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.76 seconds (3.76s).
[0m16:37:58.763758 [debug] [MainThread]: Command end result
[0m16:37:58.778271 [info ] [MainThread]: 
[0m16:37:58.778271 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:37:58.778271 [info ] [MainThread]: 
[0m16:37:58.778271 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
  AttributeError: 'int' object has no attribute 'write'
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:37:58.785821 [info ] [MainThread]: 
[0m16:37:58.786819 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:37:58.788595 [debug] [MainThread]: Command `dbt run` failed at 16:37:58.788595 after 4.47 seconds
[0m16:37:58.789590 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E97B7AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E97343D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E9E9FD90>]}
[0m16:37:58.790593 [debug] [MainThread]: Flushing usage events
[0m16:38:21.909590 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E5B77610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E5B4C7D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E5E337D0>]}


============================== 16:38:21.913620 | 4d4f79ee-c9f7-463a-96a3-dc6d92f090c3 ==============================
[0m16:38:21.913620 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:38:21.914571 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select my_python', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:38:22.296501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4d4f79ee-c9f7-463a-96a3-dc6d92f090c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E6307ED0>]}
[0m16:38:22.312099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4d4f79ee-c9f7-463a-96a3-dc6d92f090c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E6307ED0>]}
[0m16:38:22.312099 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:38:22.334292 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:38:22.469781 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:38:22.469781 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:38:22.469781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4d4f79ee-c9f7-463a-96a3-dc6d92f090c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E7E88910>]}
[0m16:38:22.485406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4d4f79ee-c9f7-463a-96a3-dc6d92f090c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E7DE4590>]}
[0m16:38:22.501002 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:38:22.501002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4d4f79ee-c9f7-463a-96a3-dc6d92f090c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E18A6850>]}
[0m16:38:22.501002 [info ] [MainThread]: 
[0m16:38:22.501002 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:38:22.501002 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:38:22.525849 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:38:22.526854 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:38:22.526854 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:38:23.486909 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:38:23.502313 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:38:23.584393 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:38:23.600040 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:38:23.600040 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:38:23.600040 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:38:24.396826 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:38:24.403368 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:38:24.481514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4d4f79ee-c9f7-463a-96a3-dc6d92f090c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E4F88C50>]}
[0m16:38:24.481514 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:38:24.481514 [info ] [MainThread]: 
[0m16:38:24.498921 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_python
[0m16:38:24.499932 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.my_python .......................... [RUN]
[0m16:38:24.500931 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_python'
[0m16:38:24.501931 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_python
[0m16:38:24.539345 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_python"
[0m16:38:24.541296 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (compile): 16:38:24.502931 => 16:38:24.541296
[0m16:38:24.542295 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_python
[0m16:38:24.573951 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.my_python"
[0m16:38:24.573951 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_python"
[0m16:38:24.573951 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_python"} */
WITH my_python__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    target_name = dbt.source("student_s", "target_dp")

    source_df = dbt.source("student_s", "bank_stream")
    
    if source_df.count() <= 2:
        insert_query = f"insert into {target_name} select * from {source_df}"
        result=session.sql(insert_query)
        
    else:
        updt_fields={}
        trgt_cols = target_name.columns
        for col_name in trgt_cols:
            if col_name in source_df.columns:
                updt_fields[col_name] = source_df[col_name]
        result=target_name.merge(source_df, (target_name["custid"] == source_df["custid"]),
                    [when_matched().update(updt_fields), when_not_matched().insert(updt_fields)])

    result.show()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "my_python"
    
    def __repr__(self):
        return 'demo_database.demo_schema.my_python'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.my_python', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL my_python__dbt_sp();
[0m16:38:24.573951 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:38:26.169022 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0743c-0001-0d23-0000-000299e6f85d
[0m16:38:26.169022 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 117, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function MY_PYTHON__DBT_SP with handler main
[0m16:38:26.169022 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (execute): 16:38:24.543294 => 16:38:26.169022
[0m16:38:26.169022 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: Close
[0m16:38:26.263328 [debug] [Thread-1 (]: Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m16:38:26.263328 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d4f79ee-c9f7-463a-96a3-dc6d92f090c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E83423D0>]}
[0m16:38:26.263328 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.my_python ................. [[31mERROR[0m in 1.76s]
[0m16:38:26.263328 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_python
[0m16:38:26.263328 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:38:26.263328 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:38:26.263328 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:38:26.263328 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_python' was properly closed.
[0m16:38:26.263328 [info ] [MainThread]: 
[0m16:38:26.278908 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.76 seconds (3.76s).
[0m16:38:26.280632 [debug] [MainThread]: Command end result
[0m16:38:26.295539 [info ] [MainThread]: 
[0m16:38:26.296487 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:38:26.297787 [info ] [MainThread]: 
[0m16:38:26.297787 [error] [MainThread]:   Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m16:38:26.301952 [info ] [MainThread]: 
[0m16:38:26.302964 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:38:26.303950 [debug] [MainThread]: Command `dbt run` failed at 16:38:26.303950 after 4.42 seconds
[0m16:38:26.304951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E5BF6BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206DF275090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206E5B751D0>]}
[0m16:38:26.306984 [debug] [MainThread]: Flushing usage events
[0m16:57:04.394760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263035EBC90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263038CE490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263038CEC10>]}


============================== 16:57:04.394760 | bca96910-8bf5-44b9-803a-f68164dabf47 ==============================
[0m16:57:04.394760 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:57:04.410375 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select my_python', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:57:04.795028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bca96910-8bf5-44b9-803a-f68164dabf47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026303DB7DD0>]}
[0m16:57:04.810655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bca96910-8bf5-44b9-803a-f68164dabf47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002630360CC50>]}
[0m16:57:04.810655 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:57:04.828008 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:57:04.960900 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:57:04.960900 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:57:05.011264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bca96910-8bf5-44b9-803a-f68164dabf47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026304828850>]}
[0m16:57:05.026917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bca96910-8bf5-44b9-803a-f68164dabf47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002637CC04090>]}
[0m16:57:05.026917 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:57:05.026917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bca96910-8bf5-44b9-803a-f68164dabf47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026303DA3790>]}
[0m16:57:05.026917 [info ] [MainThread]: 
[0m16:57:05.026917 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:57:05.026917 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:57:05.049535 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:57:05.049535 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:57:05.049535 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:06.145437 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:57:06.145437 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:57:06.252049 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:57:06.263004 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:57:06.264062 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:57:06.264062 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:07.016082 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:57:07.016082 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:57:07.084796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bca96910-8bf5-44b9-803a-f68164dabf47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002637E7BCC50>]}
[0m16:57:07.084796 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:57:07.084796 [info ] [MainThread]: 
[0m16:57:07.100468 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_python
[0m16:57:07.100468 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.my_python .......................... [RUN]
[0m16:57:07.109234 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_python'
[0m16:57:07.110235 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_python
[0m16:57:07.130791 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_python"
[0m16:57:07.147241 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (compile): 16:57:07.110235 => 16:57:07.147241
[0m16:57:07.147241 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_python
[0m16:57:07.184794 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.my_python"
[0m16:57:07.184794 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_python"
[0m16:57:07.184794 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_python"} */
WITH my_python__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    target_name = dbt.source("student_s", "target_dp")

    source_df = dbt.source("student_s", "bank_stream")
    
    if source_df.count() <= 2:
        insert_query = f"insert into {target_name} select * from {source_df}"
        result=session.sql(insert_query)
        
    else:
        updt_fields={}
        trgt_cols = target_name.columns
        for col_name in trgt_cols:
            if col_name in source_df.columns:
                updt_fields[col_name] = source_df[col_name]
        result=target_name.merge(source_df, (target_name["custid"] == source_df["custid"]),
                    [when_matched().update(updt_fields), when_not_matched().insert(updt_fields)])

    result.show()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "my_python"
    
    def __repr__(self):
        return 'demo_database.demo_schema.my_python'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.my_python', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL my_python__dbt_sp();
[0m16:57:07.184794 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:57:09.706253 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0744f-0001-0d24-0000-000299e6e875
[0m16:57:09.706253 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 117, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function MY_PYTHON__DBT_SP with handler main
[0m16:57:09.706253 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (execute): 16:57:07.147241 => 16:57:09.706253
[0m16:57:09.706253 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: Close
[0m16:57:09.768962 [debug] [Thread-1 (]: Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m16:57:09.784349 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bca96910-8bf5-44b9-803a-f68164dabf47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002630481AC90>]}
[0m16:57:09.784349 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.my_python ................. [[31mERROR[0m in 2.67s]
[0m16:57:09.784349 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_python
[0m16:57:09.790862 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:57:09.790862 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:57:09.790862 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:57:09.790862 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_python' was properly closed.
[0m16:57:09.790862 [info ] [MainThread]: 
[0m16:57:09.797957 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.76 seconds (4.76s).
[0m16:57:09.798956 [debug] [MainThread]: Command end result
[0m16:57:09.814210 [info ] [MainThread]: 
[0m16:57:09.816200 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:57:09.817200 [info ] [MainThread]: 
[0m16:57:09.818213 [error] [MainThread]:   Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m16:57:09.820141 [info ] [MainThread]: 
[0m16:57:09.820141 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:57:09.824062 [debug] [MainThread]: Command `dbt run` failed at 16:57:09.824062 after 5.45 seconds
[0m16:57:09.825060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026303605250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002630360E890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026303D95190>]}
[0m16:57:09.825060 [debug] [MainThread]: Flushing usage events
[0m16:57:23.381276 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043CDBB210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D5AF190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D5AC650>]}


============================== 16:57:23.381276 | 4161cb01-7afb-4570-b273-6dbc0a0162b3 ==============================
[0m16:57:23.381276 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:57:23.381276 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select my_python', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:57:23.779801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4161cb01-7afb-4570-b273-6dbc0a0162b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043E085C10>]}
[0m16:57:23.792096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4161cb01-7afb-4570-b273-6dbc0a0162b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D0D2E90>]}
[0m16:57:23.800187 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:57:23.812061 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:57:23.936394 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:57:23.936394 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:57:23.998895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4161cb01-7afb-4570-b273-6dbc0a0162b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043E033F50>]}
[0m16:57:24.014491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4161cb01-7afb-4570-b273-6dbc0a0162b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D5C4F10>]}
[0m16:57:24.014491 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:57:24.014491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4161cb01-7afb-4570-b273-6dbc0a0162b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D10DB10>]}
[0m16:57:24.014491 [info ] [MainThread]: 
[0m16:57:24.021035 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:57:24.021035 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:57:24.039397 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:57:24.040394 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:57:24.041390 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:24.985944 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:57:24.985944 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:57:25.070344 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:57:25.070344 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:57:25.070344 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:57:25.070344 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:25.695580 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:57:25.710977 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:57:25.786691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4161cb01-7afb-4570-b273-6dbc0a0162b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043F2DB090>]}
[0m16:57:25.786691 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:57:25.786691 [info ] [MainThread]: 
[0m16:57:25.786691 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.my_python
[0m16:57:25.786691 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.my_python .......................... [RUN]
[0m16:57:25.800378 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.my_python'
[0m16:57:25.801379 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.my_python
[0m16:57:25.832678 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.my_python"
[0m16:57:25.832678 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (compile): 16:57:25.802380 => 16:57:25.832678
[0m16:57:25.832678 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.my_python
[0m16:57:25.878921 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.my_python"
[0m16:57:25.882921 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.my_python"
[0m16:57:25.883922 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.my_python"} */
WITH my_python__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.schema(materialized = "table")

    target_name = dbt.source("student_s", "target_dp")

    source_df = dbt.source("student_s", "bank_stream")
    
    if source_df.count() <= 2:
        insert_query = f"insert into {target_name} select * from {source_df}"
        result=session.sql(insert_query)
        
    else:
        updt_fields={}
        trgt_cols = target_name.columns
        for col_name in trgt_cols:
            if col_name in source_df.columns:
                updt_fields[col_name] = source_df[col_name]
        result=target_name.merge(source_df, (target_name["custid"] == source_df["custid"]),
                    [when_matched().update(updt_fields), when_not_matched().insert(updt_fields)])

    result.show()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "my_python"
    
    def __repr__(self):
        return 'demo_database.demo_schema.my_python'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.my_python', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL my_python__dbt_sp();
[0m16:57:25.883922 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:57:28.376908 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0744f-0001-0d23-0000-000299e6f86d
[0m16:57:28.376908 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 117, in main
  File "_udf_code.py", line 12, in model
AttributeError: 'dbtObj' object has no attribute 'schema'
 in function MY_PYTHON__DBT_SP with handler main
[0m16:57:28.376908 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.my_python (execute): 16:57:25.832678 => 16:57:28.376908
[0m16:57:28.376908 [debug] [Thread-1 (]: On model.snowflake_dbt1.my_python: Close
[0m16:57:28.461792 [debug] [Thread-1 (]: Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m16:57:28.477181 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4161cb01-7afb-4570-b273-6dbc0a0162b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043F683810>]}
[0m16:57:28.477181 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.my_python ................. [[31mERROR[0m in 2.69s]
[0m16:57:28.477181 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.my_python
[0m16:57:28.477181 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:57:28.477181 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:57:28.477181 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:57:28.477181 [debug] [MainThread]: Connection 'model.snowflake_dbt1.my_python' was properly closed.
[0m16:57:28.477181 [info ] [MainThread]: 
[0m16:57:28.477181 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.46 seconds (4.46s).
[0m16:57:28.492810 [debug] [MainThread]: Command end result
[0m16:57:28.505809 [info ] [MainThread]: 
[0m16:57:28.512814 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:57:28.515810 [info ] [MainThread]: 
[0m16:57:28.517093 [error] [MainThread]:   Database Error in model my_python (models\example\my_python.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 117, in main
    File "_udf_code.py", line 12, in model
  AttributeError: 'dbtObj' object has no attribute 'schema'
   in function MY_PYTHON__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\my_python.py
[0m16:57:28.520913 [info ] [MainThread]: 
[0m16:57:28.522913 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:57:28.524914 [debug] [MainThread]: Command `dbt run` failed at 16:57:28.524914 after 5.16 seconds
[0m16:57:28.526228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D1A7710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D0E7AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002043D0E7510>]}
[0m16:57:28.526228 [debug] [MainThread]: Flushing usage events
[0m16:57:40.578217 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF137F7E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF1306E750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF130ECC10>]}


============================== 16:57:40.589759 | bdffbdd5-fcc6-4786-b439-eb11e14babfd ==============================
[0m16:57:40.589759 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:57:40.589759 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select try_source', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:57:40.968460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bdffbdd5-fcc6-4786-b439-eb11e14babfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF13810A10>]}
[0m16:57:40.990657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bdffbdd5-fcc6-4786-b439-eb11e14babfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF13810A10>]}
[0m16:57:40.990657 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:57:41.006325 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:57:41.143981 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:57:41.143981 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:57:41.143981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bdffbdd5-fcc6-4786-b439-eb11e14babfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF1334E410>]}
[0m16:57:41.175215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bdffbdd5-fcc6-4786-b439-eb11e14babfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF152D4450>]}
[0m16:57:41.175215 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:57:41.175215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bdffbdd5-fcc6-4786-b439-eb11e14babfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF1331B890>]}
[0m16:57:41.175215 [info ] [MainThread]: 
[0m16:57:41.175215 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:57:41.175215 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:57:41.200726 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:57:41.200726 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:57:41.201719 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:42.177485 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:57:42.177485 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:57:42.254704 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:57:42.254704 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:57:42.254704 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:57:42.254704 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:42.887346 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:57:42.893896 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:57:42.956451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bdffbdd5-fcc6-4786-b439-eb11e14babfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF1429C8D0>]}
[0m16:57:42.956451 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:57:42.956451 [info ] [MainThread]: 
[0m16:57:42.972034 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:57:42.972034 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:57:42.980676 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:57:42.981676 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:57:43.019298 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:57:43.019298 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:57:42.982676 => 16:57:43.019298
[0m16:57:43.019298 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:57:43.049152 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:57:43.063502 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:57:43.064505 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.describe()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:57:43.065501 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:57:48.156737 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 5.0 seconds
[0m16:57:48.178698 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:57:43.019298 => 16:57:48.178698
[0m16:57:48.178698 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:57:48.241462 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bdffbdd5-fcc6-4786-b439-eb11e14babfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF156BC510>]}
[0m16:57:48.241462 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 5.27s]
[0m16:57:48.256839 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:57:48.256839 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:57:48.256839 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:57:48.256839 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:57:48.256839 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:57:48.256839 [info ] [MainThread]: 
[0m16:57:48.256839 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.08 seconds (7.08s).
[0m16:57:48.267443 [debug] [MainThread]: Command end result
[0m16:57:48.283083 [info ] [MainThread]: 
[0m16:57:48.284083 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:57:48.286083 [info ] [MainThread]: 
[0m16:57:48.287082 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:57:48.290082 [debug] [MainThread]: Command `dbt run` succeeded at 16:57:48.290082 after 7.73 seconds
[0m16:57:48.291085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF1332CA50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF1332E610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF137E3690>]}
[0m16:57:48.292083 [debug] [MainThread]: Flushing usage events
[0m16:58:00.004252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F8F0B0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F8F4A450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F8FEA710>]}


============================== 16:58:00.004252 | f5fc2d3f-37ab-4f96-8f34-03f63179badb ==============================
[0m16:58:00.004252 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:58:00.019890 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select try_source', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:58:00.405286 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f5fc2d3f-37ab-4f96-8f34-03f63179badb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F971DBD0>]}
[0m16:58:00.420953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f5fc2d3f-37ab-4f96-8f34-03f63179badb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213FA1A8750>]}
[0m16:58:00.420953 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:58:00.436562 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:58:00.578954 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:58:00.578954 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:58:00.621790 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f5fc2d3f-37ab-4f96-8f34-03f63179badb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213FA1E7990>]}
[0m16:58:00.637385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f5fc2d3f-37ab-4f96-8f34-03f63179badb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213FB2285D0>]}
[0m16:58:00.637385 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:58:00.653007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f5fc2d3f-37ab-4f96-8f34-03f63179badb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F9724150>]}
[0m16:58:00.653007 [info ] [MainThread]: 
[0m16:58:00.653007 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:58:00.653007 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:58:00.675467 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:58:00.676465 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:58:00.677474 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:58:01.570727 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:58:01.570727 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:58:01.639486 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:58:01.654881 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:58:01.654881 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:58:01.654881 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:58:02.286466 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:58:02.286466 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:58:02.378664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f5fc2d3f-37ab-4f96-8f34-03f63179badb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F8B923D0>]}
[0m16:58:02.378664 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:58:02.378664 [info ] [MainThread]: 
[0m16:58:02.394256 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:58:02.395927 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:58:02.397926 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:58:02.397926 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:58:02.431137 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:58:02.431137 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:58:02.398924 => 16:58:02.431137
[0m16:58:02.431137 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:58:02.464542 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:58:02.480166 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:58:02.481842 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.mean()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:58:02.482854 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:58:04.544934 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07450-0001-0d24-0000-000299e6e88d
[0m16:58:04.544934 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 21, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute mean
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:58:04.544934 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:58:02.431137 => 16:58:04.544934
[0m16:58:04.544934 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:58:04.613930 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute mean
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:58:04.613930 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5fc2d3f-37ab-4f96-8f34-03f63179badb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213FB1E7710>]}
[0m16:58:04.613930 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 2.22s]
[0m16:58:04.613930 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:58:04.613930 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:58:04.613930 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:58:04.629598 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:58:04.630429 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:58:04.631430 [info ] [MainThread]: 
[0m16:58:04.633440 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.98 seconds (3.98s).
[0m16:58:04.635309 [debug] [MainThread]: Command end result
[0m16:58:04.649916 [info ] [MainThread]: 
[0m16:58:04.650947 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:58:04.651916 [info ] [MainThread]: 
[0m16:58:04.652914 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute mean
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:58:04.654150 [info ] [MainThread]: 
[0m16:58:04.654150 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:58:04.659734 [debug] [MainThread]: Command `dbt run` failed at 16:58:04.659734 after 4.67 seconds
[0m16:58:04.660732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F96F5F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213F96F5A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213FA155850>]}
[0m16:58:04.660732 [debug] [MainThread]: Flushing usage events
[0m16:58:25.101151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B837C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B60CA50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B585A90>]}


============================== 16:58:25.101151 | a3aa5914-6194-4ea6-b037-c476d8922ae6 ==============================
[0m16:58:25.101151 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:58:25.101151 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select try_source', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:58:25.502183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a3aa5914-6194-4ea6-b037-c476d8922ae6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B5F8C10>]}
[0m16:58:25.517811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a3aa5914-6194-4ea6-b037-c476d8922ae6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430C798810>]}
[0m16:58:25.517811 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:58:25.517811 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:58:25.655780 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:58:25.655780 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:58:25.702658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a3aa5914-6194-4ea6-b037-c476d8922ae6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B210590>]}
[0m16:58:25.733875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a3aa5914-6194-4ea6-b037-c476d8922ae6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430BD06210>]}
[0m16:58:25.733875 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:58:25.733875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a3aa5914-6194-4ea6-b037-c476d8922ae6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B8CA490>]}
[0m16:58:25.733875 [info ] [MainThread]: 
[0m16:58:25.733875 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:58:25.740387 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:58:25.740387 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:58:25.757330 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:58:25.757330 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:58:26.719660 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:58:26.719660 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:58:26.788541 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:58:26.803954 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:58:26.803954 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:58:26.803954 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:58:27.590425 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:58:27.590425 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:58:27.674869 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a3aa5914-6194-4ea6-b037-c476d8922ae6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B90F6D0>]}
[0m16:58:27.674869 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:58:27.674869 [info ] [MainThread]: 
[0m16:58:27.694149 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:58:27.695150 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:58:27.696466 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:58:27.698573 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:58:27.732551 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:58:27.732551 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:58:27.698759 => 16:58:27.732551
[0m16:58:27.732551 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:58:27.772151 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:58:27.775159 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:58:27.776149 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.mean

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:58:27.777150 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:58:29.463329 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07450-0001-0d24-0000-000299e6e89d
[0m16:58:29.463329 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 21, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute mean
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:58:29.463329 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:58:27.732551 => 16:58:29.463329
[0m16:58:29.463329 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:58:29.530098 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute mean
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:58:29.530098 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3aa5914-6194-4ea6-b037-c476d8922ae6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430C7D7710>]}
[0m16:58:29.530098 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 1.83s]
[0m16:58:29.545519 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:58:29.548030 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:58:29.548030 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:58:29.548030 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:58:29.548030 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:58:29.548030 [info ] [MainThread]: 
[0m16:58:29.548030 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.81 seconds (3.81s).
[0m16:58:29.556310 [debug] [MainThread]: Command end result
[0m16:58:29.571597 [info ] [MainThread]: 
[0m16:58:29.572597 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:58:29.573597 [info ] [MainThread]: 
[0m16:58:29.574597 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute mean
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:58:29.577597 [info ] [MainThread]: 
[0m16:58:29.577900 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:58:29.580459 [debug] [MainThread]: Command `dbt run` failed at 16:58:29.577900 after 4.50 seconds
[0m16:58:29.581463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B780FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430B5F8550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002430AE24A90>]}
[0m16:58:29.582460 [debug] [MainThread]: Flushing usage events
[0m16:58:41.516118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D79572E910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7957F7B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7954AE490>]}


============================== 16:58:41.516118 | 7f1965a6-cfcc-48f2-80af-d22e237a1d64 ==============================
[0m16:58:41.516118 [info ] [MainThread]: Running with dbt=1.6.6
[0m16:58:41.516118 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select try_source', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:58:41.910318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7f1965a6-cfcc-48f2-80af-d22e237a1d64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7957F6F10>]}
[0m16:58:41.916859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7f1965a6-cfcc-48f2-80af-d22e237a1d64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7957F6F10>]}
[0m16:58:41.916859 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m16:58:41.933209 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m16:58:42.064164 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:58:42.064164 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m16:58:42.117221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7f1965a6-cfcc-48f2-80af-d22e237a1d64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D795C5F810>]}
[0m16:58:42.148482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7f1965a6-cfcc-48f2-80af-d22e237a1d64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D79776EB50>]}
[0m16:58:42.148482 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m16:58:42.148482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f1965a6-cfcc-48f2-80af-d22e237a1d64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7955C6850>]}
[0m16:58:42.148482 [info ] [MainThread]: 
[0m16:58:42.148482 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:58:42.148482 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m16:58:42.170272 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m16:58:42.170272 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m16:58:42.170272 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:58:43.118757 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m16:58:43.118757 [debug] [ThreadPool]: On list_demo_database: Close
[0m16:58:43.212525 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m16:58:43.219047 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m16:58:43.219047 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m16:58:43.219047 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:58:44.020485 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m16:58:44.020485 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m16:58:44.120481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f1965a6-cfcc-48f2-80af-d22e237a1d64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D79670B110>]}
[0m16:58:44.120481 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m16:58:44.120481 [info ] [MainThread]: 
[0m16:58:44.120481 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m16:58:44.120481 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m16:58:44.135115 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m16:58:44.136100 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m16:58:44.166286 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m16:58:44.166286 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 16:58:44.137104 => 16:58:44.166286
[0m16:58:44.166286 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m16:58:44.212284 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m16:58:44.216286 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m16:58:44.217256 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.sum()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m16:58:44.217256 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:58:45.871982 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07450-0001-0d24-0000-000299e6e8b1
[0m16:58:45.887378 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 21, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute sum
 in function TRY_SOURCE__DBT_SP with handler main
[0m16:58:45.887378 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 16:58:44.166286 => 16:58:45.887378
[0m16:58:45.887378 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m16:58:45.972324 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute sum
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:58:45.973294 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f1965a6-cfcc-48f2-80af-d22e237a1d64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7977C6A10>]}
[0m16:58:45.974295 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 1.85s]
[0m16:58:45.975295 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m16:58:45.978296 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:58:45.979327 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m16:58:45.980293 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m16:58:45.981312 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m16:58:45.981312 [info ] [MainThread]: 
[0m16:58:45.983311 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.83 seconds (3.83s).
[0m16:58:45.984310 [debug] [MainThread]: Command end result
[0m16:58:45.997279 [info ] [MainThread]: 
[0m16:58:45.998280 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:58:45.999448 [info ] [MainThread]: 
[0m16:58:46.001450 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute sum
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m16:58:46.004286 [info ] [MainThread]: 
[0m16:58:46.005573 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:58:46.005573 [debug] [MainThread]: Command `dbt run` failed at 16:58:46.005573 after 4.51 seconds
[0m16:58:46.005573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D795804C50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7954C3010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D79575F290>]}
[0m16:58:46.005573 [debug] [MainThread]: Flushing usage events
[0m17:26:56.481307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022298A6AB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022298A691D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022298C99390>]}


============================== 17:26:56.481307 | d00f6116-0405-4b95-93df-2bb075fb1f77 ==============================
[0m17:26:56.481307 [info ] [MainThread]: Running with dbt=1.6.6
[0m17:26:56.481307 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select try_source', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:26:56.897909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd00f6116-0405-4b95-93df-2bb075fb1f77', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222989F5C10>]}
[0m17:26:56.913537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd00f6116-0405-4b95-93df-2bb075fb1f77', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222991C2490>]}
[0m17:26:56.913537 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m17:26:56.929164 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m17:26:57.067038 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:26:57.067038 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:26:57.067038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd00f6116-0405-4b95-93df-2bb075fb1f77', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022299CA7C10>]}
[0m17:26:57.091554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd00f6116-0405-4b95-93df-2bb075fb1f77', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002229ACE4450>]}
[0m17:26:57.092553 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m17:26:57.093550 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd00f6116-0405-4b95-93df-2bb075fb1f77', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022299AAF350>]}
[0m17:26:57.095550 [info ] [MainThread]: 
[0m17:26:57.096553 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:26:57.098550 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m17:26:57.114990 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m17:26:57.115208 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m17:26:57.115208 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:26:58.233154 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m17:26:58.248569 [debug] [ThreadPool]: On list_demo_database: Close
[0m17:26:58.333366 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m17:26:58.348789 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m17:26:58.348789 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m17:26:58.348789 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:26:59.166623 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m17:26:59.173197 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m17:26:59.255455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd00f6116-0405-4b95-93df-2bb075fb1f77', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002229B055F90>]}
[0m17:26:59.255455 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m17:26:59.255455 [info ] [MainThread]: 
[0m17:26:59.271048 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m17:26:59.271768 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m17:26:59.274768 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m17:26:59.275778 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m17:26:59.310520 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m17:26:59.310520 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 17:26:59.277194 => 17:26:59.310520
[0m17:26:59.310520 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m17:26:59.349870 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m17:26:59.352869 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m17:26:59.353871 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.head(1)

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m17:26:59.354869 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:27:01.102351 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0746d-0001-0d23-0000-000299e6f8c1
[0m17:27:01.102351 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 21, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute head
 in function TRY_SOURCE__DBT_SP with handler main
[0m17:27:01.102351 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 17:26:59.310520 => 17:27:01.102351
[0m17:27:01.102351 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m17:27:01.171365 [debug] [Thread-1 (]: Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute head
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m17:27:01.171365 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00f6116-0405-4b95-93df-2bb075fb1f77', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002229B268210>]}
[0m17:27:01.171365 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.try_source ................ [[31mERROR[0m in 1.90s]
[0m17:27:01.171365 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m17:27:01.171365 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:27:01.171365 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m17:27:01.171365 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m17:27:01.171365 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m17:27:01.171365 [info ] [MainThread]: 
[0m17:27:01.186989 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.07 seconds (4.07s).
[0m17:27:01.189087 [debug] [MainThread]: Command end result
[0m17:27:01.201365 [info ] [MainThread]: 
[0m17:27:01.201365 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m17:27:01.205837 [info ] [MainThread]: 
[0m17:27:01.206848 [error] [MainThread]:   Database Error in model try_source (models\example\try_source.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 21, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute head
   in function TRY_SOURCE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\try_source.py
[0m17:27:01.209849 [info ] [MainThread]: 
[0m17:27:01.211344 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:27:01.211344 [debug] [MainThread]: Command `dbt run` failed at 17:27:01.211344 after 4.75 seconds
[0m17:27:01.211344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022298CC02D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002229898AB10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022298D974D0>]}
[0m17:27:01.211344 [debug] [MainThread]: Flushing usage events
[0m17:27:19.259374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C7490D10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6D7A450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6FB6FD0>]}


============================== 17:27:19.259374 | bad4d358-774e-45aa-ba17-a1d21e524a85 ==============================
[0m17:27:19.259374 [info ] [MainThread]: Running with dbt=1.6.6
[0m17:27:19.259374 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select try_source', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:27:19.653840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bad4d358-774e-45aa-ba17-a1d21e524a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C7F2DC10>]}
[0m17:27:19.660349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bad4d358-774e-45aa-ba17-a1d21e524a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6CF7F50>]}
[0m17:27:19.660349 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m17:27:19.676017 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m17:27:19.807424 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:27:19.807424 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\try_source.py
[0m17:27:19.860844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bad4d358-774e-45aa-ba17-a1d21e524a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6FC1E90>]}
[0m17:27:19.877125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bad4d358-774e-45aa-ba17-a1d21e524a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6CDFA90>]}
[0m17:27:19.877125 [info ] [MainThread]: Found 7 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m17:27:19.877125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bad4d358-774e-45aa-ba17-a1d21e524a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6E8C990>]}
[0m17:27:19.877125 [info ] [MainThread]: 
[0m17:27:19.877125 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:27:19.893614 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m17:27:19.910324 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m17:27:19.910324 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m17:27:19.910324 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:27:20.825833 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m17:27:20.825833 [debug] [ThreadPool]: On list_demo_database: Close
[0m17:27:20.894971 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m17:27:20.910402 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m17:27:20.910402 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m17:27:20.910402 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:27:21.697068 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m17:27:21.712521 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m17:27:21.781467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bad4d358-774e-45aa-ba17-a1d21e524a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C9383110>]}
[0m17:27:21.781467 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m17:27:21.781467 [info ] [MainThread]: 
[0m17:27:21.797043 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.try_source
[0m17:27:21.797043 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.try_source ......................... [RUN]
[0m17:27:21.805479 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.try_source'
[0m17:27:21.806462 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.try_source
[0m17:27:21.832246 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.try_source"
[0m17:27:21.844665 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (compile): 17:27:21.807464 => 17:27:21.843639
[0m17:27:21.844665 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.try_source
[0m17:27:21.877379 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.try_source"
[0m17:27:21.877379 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.try_source"
[0m17:27:21.877379 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.try_source"} */
WITH try_source__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")
    target_name = dbt.source("student_s", "target_dp")
    

    ans='true'

    if ans=='true':
        result=source_df.describe()

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream", "student_s.target_dp": "demo_database.demo_schema.target_dp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "try_source"
    
    def __repr__(self):
        return 'demo_database.demo_schema.try_source'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.try_source', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL try_source__dbt_sp();
[0m17:27:21.877379 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:27:27.959683 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 6.0 seconds
[0m17:27:27.998919 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.try_source (execute): 17:27:21.845665 => 17:27:27.998919
[0m17:27:27.999922 [debug] [Thread-1 (]: On model.snowflake_dbt1.try_source: Close
[0m17:27:28.071268 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bad4d358-774e-45aa-ba17-a1d21e524a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C8F57710>]}
[0m17:27:28.071268 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.try_source .................... [[32mSUCCESS 1[0m in 6.27s]
[0m17:27:28.071268 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.try_source
[0m17:27:28.071268 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:27:28.071268 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m17:27:28.071268 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m17:27:28.071268 [debug] [MainThread]: Connection 'model.snowflake_dbt1.try_source' was properly closed.
[0m17:27:28.080308 [info ] [MainThread]: 
[0m17:27:28.080308 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.20 seconds (8.20s).
[0m17:27:28.083179 [debug] [MainThread]: Command end result
[0m17:27:28.098208 [info ] [MainThread]: 
[0m17:27:28.099033 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:27:28.100044 [info ] [MainThread]: 
[0m17:27:28.101044 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:27:28.102302 [debug] [MainThread]: Command `dbt run` succeeded at 17:27:28.102302 after 8.86 seconds
[0m17:27:28.102302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6EFDF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C6550590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283C7478F10>]}
[0m17:27:28.102302 [debug] [MainThread]: Flushing usage events
[0m18:16:13.347214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF26A1F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF1F0ED90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF1F96D10>]}


============================== 18:16:13.347214 | b24618e3-7600-4aa0-8f01-12a3f78efb94 ==============================
[0m18:16:13.347214 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:16:13.362807 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select insert', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:16:13.740500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b24618e3-7600-4aa0-8f01-12a3f78efb94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF21FA3D0>]}
[0m18:16:13.762666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b24618e3-7600-4aa0-8f01-12a3f78efb94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF2694D10>]}
[0m18:16:13.762666 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:16:13.783026 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:16:13.909848 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m18:16:13.909848 [debug] [MainThread]: Partial parsing: added file: snowflake_dbt1://models\example\stg_emp.py
[0m18:16:13.909848 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\insert.py
[0m18:16:13.962912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b24618e3-7600-4aa0-8f01-12a3f78efb94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF1EEBC90>]}
[0m18:16:13.978585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b24618e3-7600-4aa0-8f01-12a3f78efb94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF24E9290>]}
[0m18:16:13.978585 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:16:13.978585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b24618e3-7600-4aa0-8f01-12a3f78efb94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF1EAAE10>]}
[0m18:16:13.978585 [info ] [MainThread]: 
[0m18:16:13.994203 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:16:13.994203 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:16:14.014511 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:16:14.015738 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:16:14.015738 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:16:14.964527 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:16:14.964527 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:16:15.343379 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:16:15.343379 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:16:15.359035 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:16:15.359035 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:16:16.147114 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m18:16:16.147114 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:16:16.246283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b24618e3-7600-4aa0-8f01-12a3f78efb94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF12B4890>]}
[0m18:16:16.246283 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:16:16.246283 [info ] [MainThread]: 
[0m18:16:16.263578 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m18:16:16.264579 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m18:16:16.266579 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m18:16:16.267801 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m18:16:16.298717 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m18:16:16.298717 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 18:16:16.268308 => 18:16:16.298717
[0m18:16:16.298717 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m18:16:16.343490 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m18:16:16.346488 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m18:16:16.347489 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = f"insert into {table} values (7,'adad',6666);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m18:16:16.347489 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:16:23.650431 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0749e-0001-0d24-0000-000299e6e919
[0m18:16:23.650431 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b0749e-0001-0d24-0000-000299e6e929: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m18:16:23.650431 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 18:16:16.298717 => 18:16:23.650431
[0m18:16:23.665851 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m18:16:23.725179 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b0749e-0001-0d24-0000-000299e6e929: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m18:16:23.740805 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b24618e3-7600-4aa0-8f01-12a3f78efb94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF4574B90>]}
[0m18:16:23.740805 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 7.48s]
[0m18:16:23.740805 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m18:16:23.740805 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:16:23.740805 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:16:23.740805 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:16:23.740805 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m18:16:23.740805 [info ] [MainThread]: 
[0m18:16:23.740805 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.75 seconds (9.75s).
[0m18:16:23.753927 [debug] [MainThread]: Command end result
[0m18:16:23.760410 [info ] [MainThread]: 
[0m18:16:23.760410 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:16:23.770452 [info ] [MainThread]: 
[0m18:16:23.771463 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b0749e-0001-0d24-0000-000299e6e929: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m18:16:23.779104 [info ] [MainThread]: 
[0m18:16:23.781623 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:16:23.782623 [debug] [MainThread]: Command `dbt run` failed at 18:16:23.782623 after 10.45 seconds
[0m18:16:23.783622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF1EAB250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF2197B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DAF2196910>]}
[0m18:16:23.783622 [debug] [MainThread]: Flushing usage events
[0m18:19:22.640494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E25EAE10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E213DAD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E1AB0110>]}


============================== 18:19:22.640494 | a8d148d7-48b7-4aef-bb41-320364b1b723 ==============================
[0m18:19:22.640494 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:19:22.640494 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_emp', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:19:23.025232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8d148d7-48b7-4aef-bb41-320364b1b723', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E2601290>]}
[0m18:19:23.040897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8d148d7-48b7-4aef-bb41-320364b1b723', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E1E579D0>]}
[0m18:19:23.040897 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:19:23.056494 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:19:23.188349 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:19:23.188349 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:19:23.241745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a8d148d7-48b7-4aef-bb41-320364b1b723', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E30963D0>]}
[0m18:19:23.257401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a8d148d7-48b7-4aef-bb41-320364b1b723', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E40DFED0>]}
[0m18:19:23.257401 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:19:23.272999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8d148d7-48b7-4aef-bb41-320364b1b723', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E1F23410>]}
[0m18:19:23.272999 [info ] [MainThread]: 
[0m18:19:23.272999 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:19:23.272999 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:19:23.295310 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:19:23.296327 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:19:23.297327 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:19:24.243794 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:19:24.243794 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:19:24.306486 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:19:24.328435 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:19:24.328435 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:19:24.328435 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:19:25.346629 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m18:19:25.346629 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:19:25.731549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8d148d7-48b7-4aef-bb41-320364b1b723', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DFB01A10>]}
[0m18:19:25.731549 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:19:25.731549 [info ] [MainThread]: 
[0m18:19:25.748572 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:19:25.748572 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:19:25.757214 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:19:25.758216 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:19:25.783057 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:19:25.794411 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:19:25.758216 => 18:19:25.793460
[0m18:19:25.796425 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:19:25.831785 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:19:25.831785 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:19:25.831785 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):

    
    stg_emp= dbt.ref("src_emp").to_pandas()

    # drop duplicate customer_name and their ids.
    # as as an ultra fancy shop, we only allow one customer per name.
    int_customers = src_emp.drop_duplicates(
        subset=["empname".upper()], keep="first"
    )

    return int_customers


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:19:25.831785 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:19:30.010860 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074a1-0001-0d23-0000-000299e6f8f5
[0m18:19:30.010860 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:19:30.010860 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:19:25.796425 => 18:19:30.010860
[0m18:19:30.010860 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:19:30.089925 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:19:30.089925 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d148d7-48b7-4aef-bb41-320364b1b723', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E46280D0>]}
[0m18:19:30.089925 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 4.34s]
[0m18:19:30.089925 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:19:30.089925 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:19:30.089925 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:19:30.089925 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:19:30.089925 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:19:30.089925 [info ] [MainThread]: 
[0m18:19:30.089925 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.82 seconds (6.82s).
[0m18:19:30.106374 [debug] [MainThread]: Command end result
[0m18:19:30.118328 [info ] [MainThread]: 
[0m18:19:30.118328 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:19:30.118328 [info ] [MainThread]: 
[0m18:19:30.118328 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:19:30.131428 [info ] [MainThread]: 
[0m18:19:30.132431 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:19:30.134375 [debug] [MainThread]: Command `dbt run` failed at 18:19:30.134375 after 7.52 seconds
[0m18:19:30.134375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E1E57390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E41D4C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E1747750>]}
[0m18:19:30.134375 [debug] [MainThread]: Flushing usage events
[0m18:27:45.282667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200E98EBC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200E9B1F050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200E991ED50>]}


============================== 18:27:45.282667 | 2a1d685a-5e01-43e5-b838-56bcf93589f8 ==============================
[0m18:27:45.282667 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:27:45.282667 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_emp', 'send_anonymous_usage_stats': 'True'}
[0m18:27:45.680626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2a1d685a-5e01-43e5-b838-56bcf93589f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200EA898A90>]}
[0m18:27:45.711877 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2a1d685a-5e01-43e5-b838-56bcf93589f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200E9637D10>]}
[0m18:27:45.711877 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:27:45.711877 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:27:45.858264 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:27:45.858264 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:27:45.858264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2a1d685a-5e01-43e5-b838-56bcf93589f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200EA832710>]}
[0m18:27:45.889485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2a1d685a-5e01-43e5-b838-56bcf93589f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200EB8DC050>]}
[0m18:27:45.889485 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:27:45.889485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a1d685a-5e01-43e5-b838-56bcf93589f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200EA8A7ED0>]}
[0m18:27:45.889485 [info ] [MainThread]: 
[0m18:27:45.889485 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:27:45.889485 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:27:45.911284 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:27:45.911284 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:27:45.911284 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:27:46.895830 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:27:46.911529 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:27:46.989656 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:27:46.996225 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:27:46.996225 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:27:46.996225 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:27:48.045777 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m18:27:48.045777 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:27:48.130319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a1d685a-5e01-43e5-b838-56bcf93589f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200EA8C2490>]}
[0m18:27:48.130319 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:27:48.130319 [info ] [MainThread]: 
[0m18:27:48.145938 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:27:48.146943 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:27:48.148943 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:27:48.150955 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:27:48.185373 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:27:48.185373 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:27:48.150955 => 18:27:48.185373
[0m18:27:48.185373 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:27:48.224321 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:27:48.227321 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:27:48.228321 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):

    
    stg_emp= dbt.ref("src_emp").to_pandas()

    # drop duplicate customer_name and their ids.
    # as as an ultra fancy shop, we only allow one customer per name.
    int_customers = src_emp.drop_duplicates()
    

    return int_customers


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:27:48.229323 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:27:50.467269 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074a9-0001-0d24-0000-000299e6e93d
[0m18:27:50.467269 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 106, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:27:50.467269 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:27:48.185373 => 18:27:50.467269
[0m18:27:50.467269 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:27:51.539083 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:27:51.554461 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a1d685a-5e01-43e5-b838-56bcf93589f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200EB94DB90>]}
[0m18:27:51.554461 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 3.41s]
[0m18:27:51.554461 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:27:51.554461 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:27:51.554461 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:27:51.554461 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:27:51.554461 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:27:51.554461 [info ] [MainThread]: 
[0m18:27:51.554461 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.66 seconds (5.66s).
[0m18:27:51.565468 [debug] [MainThread]: Command end result
[0m18:27:51.570358 [info ] [MainThread]: 
[0m18:27:51.570358 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:27:51.581633 [info ] [MainThread]: 
[0m18:27:51.582644 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:27:51.592272 [info ] [MainThread]: 
[0m18:27:51.592272 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:27:51.592272 [debug] [MainThread]: Command `dbt run` failed at 18:27:51.592272 after 6.34 seconds
[0m18:27:51.592272 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200E9DC7610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200E9DC54D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200E9DC5390>]}
[0m18:27:51.592272 [debug] [MainThread]: Flushing usage events
[0m18:28:32.817088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA58B350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA589810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA224890>]}


============================== 18:28:32.817088 | b5a34217-41a0-4be6-b1c6-21203433637c ==============================
[0m18:28:32.817088 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:28:32.817088 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_emp', 'send_anonymous_usage_stats': 'True'}
[0m18:28:45.303023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b5a34217-41a0-4be6-b1c6-21203433637c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AD2834B90>]}
[0m18:28:45.318679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b5a34217-41a0-4be6-b1c6-21203433637c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA2E94D0>]}
[0m18:28:45.318679 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:28:45.342024 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:28:45.419792 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:28:45.419792 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:28:45.435453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b5a34217-41a0-4be6-b1c6-21203433637c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA51E850>]}
[0m18:28:45.451047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b5a34217-41a0-4be6-b1c6-21203433637c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AD2870E90>]}
[0m18:28:45.451047 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:28:45.451047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b5a34217-41a0-4be6-b1c6-21203433637c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AC9F407D0>]}
[0m18:28:45.451047 [info ] [MainThread]: 
[0m18:28:45.451047 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:28:45.451047 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:28:45.473728 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:28:45.473728 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:28:45.473728 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:28:46.405966 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:28:46.405966 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:28:46.474706 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:28:46.506783 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:28:46.506783 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:28:46.506783 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:28:47.276108 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m18:28:47.276108 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:28:47.356608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b5a34217-41a0-4be6-b1c6-21203433637c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AD2AC0310>]}
[0m18:28:47.356608 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:28:47.369833 [info ] [MainThread]: 
[0m18:28:47.377460 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:28:47.378496 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:28:47.380471 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:28:47.381471 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:28:47.411259 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:28:47.411259 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:28:47.382471 => 18:28:47.411259
[0m18:28:47.420678 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:28:47.457020 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:28:47.461020 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:28:47.461020 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):

    
    stg_emp= dbt.ref("src_emp").to_pandas()

    # drop duplicate customer_name and their ids.
    # as as an ultra fancy shop, we only allow one customer per name.
    int_customers = src_emp.drop_duplicates()
    

    return int_customers


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:28:47.462021 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:28:49.444949 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074aa-0001-0d23-0000-000299e6f909
[0m18:28:49.444949 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 106, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:28:49.444949 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:28:47.421672 => 18:28:49.444949
[0m18:28:49.444949 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:28:49.519201 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:28:49.519201 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b5a34217-41a0-4be6-b1c6-21203433637c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AD2D4DDD0>]}
[0m18:28:49.519201 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 2.14s]
[0m18:28:49.519201 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:28:49.519201 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:28:49.519201 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:28:49.519201 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:28:49.519201 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:28:49.519201 [info ] [MainThread]: 
[0m18:28:49.534804 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.07 seconds (4.07s).
[0m18:28:49.537045 [debug] [MainThread]: Command end result
[0m18:28:49.550045 [info ] [MainThread]: 
[0m18:28:49.551047 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:28:49.552278 [info ] [MainThread]: 
[0m18:28:49.554295 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:28:49.563033 [info ] [MainThread]: 
[0m18:28:49.564034 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:28:49.565279 [debug] [MainThread]: Command `dbt run` failed at 18:28:49.565279 after 16.77 seconds
[0m18:28:49.565279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA51C590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA4E87D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016ACA9D0850>]}
[0m18:28:49.565279 [debug] [MainThread]: Flushing usage events
[0m18:29:23.574901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95FBE2650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95F3E79D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95F7A6450>]}


============================== 18:29:23.574901 | e4772d12-11a4-4198-8d90-940d04025255 ==============================
[0m18:29:23.574901 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:29:23.574901 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_emp', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:29:24.091581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e4772d12-11a4-4198-8d90-940d04025255', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95FE71410>]}
[0m18:29:24.113718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e4772d12-11a4-4198-8d90-940d04025255', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95FE71410>]}
[0m18:29:24.113718 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:29:24.129356 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:29:24.214033 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:29:24.214033 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:29:24.276584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e4772d12-11a4-4198-8d90-940d04025255', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E967A27750>]}
[0m18:29:24.292204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e4772d12-11a4-4198-8d90-940d04025255', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E967A78650>]}
[0m18:29:24.292204 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:29:24.292204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4772d12-11a4-4198-8d90-940d04025255', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E965F65150>]}
[0m18:29:24.292204 [info ] [MainThread]: 
[0m18:29:24.292204 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:29:24.308624 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:29:24.323457 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:29:24.323457 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:29:24.323457 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:29:25.316269 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:29:25.316269 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:29:25.648092 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:29:25.648092 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:29:25.648092 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:29:25.648092 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:29:27.704837 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 2.0 seconds
[0m18:29:27.720276 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:29:28.046229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4772d12-11a4-4198-8d90-940d04025255', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E967B882D0>]}
[0m18:29:28.061644 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:29:28.061644 [info ] [MainThread]: 
[0m18:29:28.068154 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:29:28.068154 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:29:28.073302 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:29:28.074303 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:29:28.107384 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:29:28.107384 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:29:28.075303 => 18:29:28.107384
[0m18:29:28.107384 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:29:28.147267 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:29:28.150267 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:29:28.151265 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F
import pyarrow

def model(dbt, session):

    
    stg_emp= dbt.ref("src_emp").to_pandas()

    # drop duplicate customer_name and their ids.
    # as as an ultra fancy shop, we only allow one customer per name.
    int_customers = src_emp.drop_duplicates()
    

    return int_customers


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:29:28.152266 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:29:29.665364 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074ab-0001-0d23-0000-000299e6f919
[0m18:29:29.665364 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 10, in <module>
ModuleNotFoundError: No module named 'pyarrow'
 in function STG_EMP__DBT_SP with handler main
[0m18:29:29.665364 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:29:28.107384 => 18:29:29.665364
[0m18:29:29.665364 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:29:30.119840 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 10, in <module>
  ModuleNotFoundError: No module named 'pyarrow'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:29:30.119840 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e4772d12-11a4-4198-8d90-940d04025255', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E967A12410>]}
[0m18:29:30.119840 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 2.05s]
[0m18:29:30.119840 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:29:30.119840 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:29:30.119840 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:29:30.119840 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:29:30.119840 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:29:30.119840 [info ] [MainThread]: 
[0m18:29:30.135430 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.83 seconds (5.83s).
[0m18:29:30.136894 [debug] [MainThread]: Command end result
[0m18:29:30.141153 [info ] [MainThread]: 
[0m18:29:30.141153 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:29:30.154161 [info ] [MainThread]: 
[0m18:29:30.155133 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 10, in <module>
  ModuleNotFoundError: No module named 'pyarrow'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:29:30.158575 [info ] [MainThread]: 
[0m18:29:30.158575 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:29:30.158575 [debug] [MainThread]: Command `dbt run` failed at 18:29:30.158575 after 6.61 seconds
[0m18:29:30.158575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95F444710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95FBD1BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E95FC01810>]}
[0m18:29:30.158575 [debug] [MainThread]: Flushing usage events
[0m18:30:47.258747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFC556610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFC575E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFC575990>]}


============================== 18:30:47.258747 | bab65255-0c6a-4d08-947f-6f7d63a4ae51 ==============================
[0m18:30:47.258747 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:30:47.258747 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_emp', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:30:47.791021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bab65255-0c6a-4d08-947f-6f7d63a4ae51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFED06E90>]}
[0m18:30:47.813163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bab65255-0c6a-4d08-947f-6f7d63a4ae51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFCA0F590>]}
[0m18:30:47.813163 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:30:47.813163 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:30:47.913145 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:30:47.913145 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:30:47.960027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bab65255-0c6a-4d08-947f-6f7d63a4ae51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFBC5DB10>]}
[0m18:30:47.975649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bab65255-0c6a-4d08-947f-6f7d63a4ae51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010F8492F010>]}
[0m18:30:47.975649 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:30:47.975649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bab65255-0c6a-4d08-947f-6f7d63a4ae51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010F84824810>]}
[0m18:30:47.991273 [info ] [MainThread]: 
[0m18:30:47.991273 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:30:47.991273 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:30:47.997816 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:30:47.997816 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:30:47.997816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:48.930905 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:30:48.930905 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:30:49.695566 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:30:49.710990 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:30:49.710990 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:30:49.710990 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:50.497341 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m18:30:50.512751 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:30:51.985674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bab65255-0c6a-4d08-947f-6f7d63a4ae51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010F84824810>]}
[0m18:30:51.985674 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:30:51.985674 [info ] [MainThread]: 
[0m18:30:51.985674 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:30:51.985674 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:30:52.002049 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:30:52.003050 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:30:52.027535 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:30:52.039081 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:30:52.004062 => 18:30:52.039081
[0m18:30:52.039081 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:30:52.077485 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:30:52.081484 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:30:52.082484 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):

    
    stg_emp= dbt.ref("src_emp").to_pandas()

    # drop duplicate customer_name and their ids.
    # as as an ultra fancy shop, we only allow one customer per name.
    int_customers = stg_emp.drop_duplicates()
    

    return int_customers


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:30:52.083485 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:30:54.525952 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074ac-0001-0d23-0000-000299e6f921
[0m18:30:54.525952 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 106, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:30:54.525952 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:30:52.041794 => 18:30:54.525952
[0m18:30:54.525952 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:30:54.605598 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:30:54.605598 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bab65255-0c6a-4d08-947f-6f7d63a4ae51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010F84F8ED10>]}
[0m18:30:54.605598 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 2.60s]
[0m18:30:54.605598 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:30:54.605598 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:30:54.605598 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:30:54.605598 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:30:54.605598 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:30:54.605598 [info ] [MainThread]: 
[0m18:30:54.621184 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.61 seconds (6.61s).
[0m18:30:54.623311 [debug] [MainThread]: Command end result
[0m18:30:54.627604 [info ] [MainThread]: 
[0m18:30:54.627604 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:30:54.641498 [info ] [MainThread]: 
[0m18:30:54.643501 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:30:54.652828 [info ] [MainThread]: 
[0m18:30:54.654005 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:30:54.656437 [debug] [MainThread]: Command `dbt run` failed at 18:30:54.656017 after 7.42 seconds
[0m18:30:54.656437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFC317CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFC25C310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000010FFC51AD10>]}
[0m18:30:54.656437 [debug] [MainThread]: Flushing usage events
[0m18:32:08.474850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A2A64EB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A2A27CDD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A29F626D0>]}


============================== 18:32:08.474850 | 809fd9a7-a727-427f-9dab-4396050168fa ==============================
[0m18:32:08.474850 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:32:08.474850 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_emp', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:32:09.007053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '809fd9a7-a727-427f-9dab-4396050168fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A309BE6D0>]}
[0m18:32:09.022679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '809fd9a7-a727-427f-9dab-4396050168fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A2A1B5710>]}
[0m18:32:09.022679 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:32:09.045336 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:32:09.124871 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:32:09.124871 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:32:09.176432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '809fd9a7-a727-427f-9dab-4396050168fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A3256E690>]}
[0m18:32:09.207708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '809fd9a7-a727-427f-9dab-4396050168fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A32533E90>]}
[0m18:32:09.207708 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:32:09.207708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '809fd9a7-a727-427f-9dab-4396050168fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A32595650>]}
[0m18:32:09.207708 [info ] [MainThread]: 
[0m18:32:09.207708 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:32:09.207708 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:32:09.232805 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:32:09.233799 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:32:09.233799 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:32:10.441767 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:32:10.441767 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:32:10.827526 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:32:10.842978 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:32:10.842978 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:32:10.842978 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:32:13.504240 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 3.0 seconds
[0m18:32:13.520796 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:32:13.989843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '809fd9a7-a727-427f-9dab-4396050168fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A3251C9D0>]}
[0m18:32:13.989843 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:32:13.989843 [info ] [MainThread]: 
[0m18:32:13.989843 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:32:13.989843 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:32:14.003384 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:32:14.003893 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:32:14.029233 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:32:14.029233 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:32:14.004903 => 18:32:14.029233
[0m18:32:14.029233 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:32:14.080421 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:32:14.083422 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:32:14.084393 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp").to_pandas()

    # drop duplicate customer_name and their ids.
    # as as an ultra fancy shop, we only allow one customer per name.
    int_customers = stg_emp.drop_duplicates()
    

    return int_customers


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:32:14.084393 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:32:15.709666 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074ae-0001-0d23-0000-000299e6f96d
[0m18:32:15.709666 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 106, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:32:15.709666 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:32:14.029233 => 18:32:15.709666
[0m18:32:15.709666 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:32:16.011151 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:32:16.011151 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '809fd9a7-a727-427f-9dab-4396050168fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A32B207D0>]}
[0m18:32:16.011151 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 2.02s]
[0m18:32:16.011151 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:32:16.011151 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:32:16.011151 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:32:16.011151 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:32:16.026791 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:32:16.027580 [info ] [MainThread]: 
[0m18:32:16.029580 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.82 seconds (6.82s).
[0m18:32:16.031583 [debug] [MainThread]: Command end result
[0m18:32:16.047949 [info ] [MainThread]: 
[0m18:32:16.049946 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:32:16.050806 [info ] [MainThread]: 
[0m18:32:16.051816 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:32:16.060699 [info ] [MainThread]: 
[0m18:32:16.063008 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:32:16.063008 [debug] [MainThread]: Command `dbt run` failed at 18:32:16.063008 after 7.61 seconds
[0m18:32:16.063008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A2749FAD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A2A3B6250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013A2A64E850>]}
[0m18:32:16.063008 [debug] [MainThread]: Flushing usage events
[0m18:32:21.788742 [debug] [MainThread]: Error sending anonymous usage statistics. Disabling tracking for this execution. If you wish to permanently disable tracking, see: https://docs.getdbt.com/reference/global-configs#send-anonymous-usage-stats.
[0m18:33:39.257397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C53287C2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C532630990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C52F8E3810>]}


============================== 18:33:39.273020 | 59e7187f-51ba-4547-880a-ce67f3d8213d ==============================
[0m18:33:39.273020 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:33:39.273020 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_emp', 'send_anonymous_usage_stats': 'True'}
[0m18:33:39.802198 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '59e7187f-51ba-4547-880a-ce67f3d8213d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C538FE9250>]}
[0m18:33:39.814331 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '59e7187f-51ba-4547-880a-ce67f3d8213d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C532D4A210>]}
[0m18:33:39.814331 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:33:39.832490 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:33:39.911652 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:33:39.911652 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:33:39.969117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '59e7187f-51ba-4547-880a-ce67f3d8213d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C53AB2B610>]}
[0m18:33:39.984744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '59e7187f-51ba-4547-880a-ce67f3d8213d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C53AC11F10>]}
[0m18:33:39.984744 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:33:39.984744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '59e7187f-51ba-4547-880a-ce67f3d8213d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C539203310>]}
[0m18:33:39.984744 [info ] [MainThread]: 
[0m18:33:39.984744 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:33:40.000364 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:33:40.016667 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:33:40.017653 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:33:40.018658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:33:41.272490 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:33:41.272490 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:33:41.704765 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:33:41.704765 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:33:41.704765 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:33:41.720424 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:33:43.466949 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 2.0 seconds
[0m18:33:43.466949 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:33:44.855337 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '59e7187f-51ba-4547-880a-ce67f3d8213d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C532D4AC10>]}
[0m18:33:44.855337 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:33:44.855337 [info ] [MainThread]: 
[0m18:33:44.855337 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:33:44.855337 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:33:44.871284 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:33:44.872287 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:33:44.898561 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:33:44.898561 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:33:44.873284 => 18:33:44.898561
[0m18:33:44.908574 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:33:44.944249 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:33:44.947253 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:33:44.948277 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F
import pandas

def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.drop_duplicates()
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:33:44.949283 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:33:46.713377 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074af-0001-0d24-0000-000299e6e9ad
[0m18:33:46.713377 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 10, in <module>
ModuleNotFoundError: No module named 'pandas'
 in function STG_EMP__DBT_SP with handler main
[0m18:33:46.713377 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:33:44.908574 => 18:33:46.713377
[0m18:33:46.713377 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:33:47.092246 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 10, in <module>
  ModuleNotFoundError: No module named 'pandas'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:33:47.092246 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '59e7187f-51ba-4547-880a-ce67f3d8213d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C53B0AEC50>]}
[0m18:33:47.092246 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 2.24s]
[0m18:33:47.092246 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:33:47.107859 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:33:47.107859 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:33:47.107859 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:33:47.107859 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:33:47.107859 [info ] [MainThread]: 
[0m18:33:47.107859 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.12 seconds (7.12s).
[0m18:33:47.113044 [debug] [MainThread]: Command end result
[0m18:33:47.127040 [info ] [MainThread]: 
[0m18:33:47.128041 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:33:47.129042 [info ] [MainThread]: 
[0m18:33:47.130138 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 10, in <module>
  ModuleNotFoundError: No module named 'pandas'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:33:47.130138 [info ] [MainThread]: 
[0m18:33:47.130138 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:33:47.135885 [debug] [MainThread]: Command `dbt run` failed at 18:33:47.135885 after 7.89 seconds
[0m18:33:47.136896 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C532D21C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C53AAF8310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C531DF4D10>]}
[0m18:33:47.136896 [debug] [MainThread]: Flushing usage events
[0m18:34:00.846500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021684711F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021683F90090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021684239CD0>]}


============================== 18:34:00.846500 | e32bb346-8fbe-45b3-a7c5-1d0435bce6d9 ==============================
[0m18:34:00.846500 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:34:00.846500 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_emp', 'send_anonymous_usage_stats': 'True'}
[0m18:34:01.388807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e32bb346-8fbe-45b3-a7c5-1d0435bce6d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168425FCD0>]}
[0m18:34:01.404464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e32bb346-8fbe-45b3-a7c5-1d0435bce6d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021684731010>]}
[0m18:34:01.404464 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:34:01.404464 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:34:01.495522 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:34:01.511116 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:34:01.557992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e32bb346-8fbe-45b3-a7c5-1d0435bce6d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168425D290>]}
[0m18:34:01.574157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e32bb346-8fbe-45b3-a7c5-1d0435bce6d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168C5F8AD0>]}
[0m18:34:01.574157 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:34:01.574157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e32bb346-8fbe-45b3-a7c5-1d0435bce6d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021683FF1B90>]}
[0m18:34:01.574157 [info ] [MainThread]: 
[0m18:34:01.574157 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:34:01.574157 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:34:01.599171 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:34:01.599171 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:34:01.599171 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:34:02.808084 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:34:02.823706 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:34:02.877054 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:34:02.908326 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:34:02.908326 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:34:02.908326 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:34:03.900562 [debug] [ThreadPool]: SQL status: SUCCESS 39 in 1.0 seconds
[0m18:34:03.900562 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:34:04.000537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e32bb346-8fbe-45b3-a7c5-1d0435bce6d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021683F81750>]}
[0m18:34:04.000537 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:34:04.000537 [info ] [MainThread]: 
[0m18:34:04.016989 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:34:04.017990 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:34:04.018988 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:34:04.019991 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:34:04.053665 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:34:04.053665 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:34:04.020991 => 18:34:04.053665
[0m18:34:04.053665 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:34:04.081688 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:34:04.097356 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:34:04.098363 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.drop_duplicates()
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:34:04.099361 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:34:08.082295 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m18:34:08.113598 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:34:04.053665 => 18:34:08.113598
[0m18:34:08.113598 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:34:08.182419 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e32bb346-8fbe-45b3-a7c5-1d0435bce6d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168CAEDED0>]}
[0m18:34:08.182419 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.stg_emp ....................... [[32mSUCCESS 1[0m in 4.16s]
[0m18:34:08.182419 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:34:08.182419 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:34:08.182419 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:34:08.182419 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:34:08.182419 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:34:08.182419 [info ] [MainThread]: 
[0m18:34:08.182419 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.61 seconds (6.61s).
[0m18:34:08.193729 [debug] [MainThread]: Command end result
[0m18:34:08.204442 [info ] [MainThread]: 
[0m18:34:08.204442 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:34:08.211599 [info ] [MainThread]: 
[0m18:34:08.212598 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:34:08.214610 [debug] [MainThread]: Command `dbt run` succeeded at 18:34:08.214610 after 7.39 seconds
[0m18:34:08.216793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021683F5EF90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021683B4E950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021684330F50>]}
[0m18:34:08.216793 [debug] [MainThread]: Flushing usage events
[0m18:36:16.957799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B50B3D0650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B50AF8AD10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5089F9350>]}


============================== 18:36:16.973458 | 77533406-effd-4f4b-b3c0-befeedff98dc ==============================
[0m18:36:16.973458 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:36:16.973458 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_emp', 'send_anonymous_usage_stats': 'True'}
[0m18:36:17.496693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '77533406-effd-4f4b-b3c0-befeedff98dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5117E1250>]}
[0m18:36:17.512321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '77533406-effd-4f4b-b3c0-befeedff98dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B50AC34AD0>]}
[0m18:36:17.512321 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:36:17.527946 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:36:17.616449 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:36:17.616449 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:36:17.678951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '77533406-effd-4f4b-b3c0-befeedff98dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B51321D790>]}
[0m18:36:17.681962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '77533406-effd-4f4b-b3c0-befeedff98dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5132ADDD0>]}
[0m18:36:17.697600 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:36:17.697600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '77533406-effd-4f4b-b3c0-befeedff98dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B50B3C2ED0>]}
[0m18:36:17.697600 [info ] [MainThread]: 
[0m18:36:17.697600 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:36:17.697600 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:36:17.720777 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:36:17.721809 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:36:17.721809 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:36:18.683029 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:36:18.683029 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:36:18.745776 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:36:18.761201 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:36:18.761201 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:36:18.761201 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:36:19.397391 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m18:36:19.397391 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:36:19.481833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '77533406-effd-4f4b-b3c0-befeedff98dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B51329F990>]}
[0m18:36:19.481833 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:36:19.497428 [info ] [MainThread]: 
[0m18:36:19.497428 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:36:19.497428 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:36:19.513628 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:36:19.515626 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:36:19.551004 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:36:19.551004 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:36:19.517628 => 18:36:19.551004
[0m18:36:19.551004 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:36:19.590386 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:36:19.593386 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:36:19.594386 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.drop_duplicates(
         subset=["customer_name".upper()], keep="first"
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:36:19.595386 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:36:21.289835 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074b2-0001-0d24-0000-000299e6e9fd
[0m18:36:21.291797 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 18, in model
TypeError: drop_duplicates() got an unexpected keyword argument 'subset'
 in function STG_EMP__DBT_SP with handler main
[0m18:36:21.292799 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:36:19.551004 => 18:36:21.291797
[0m18:36:21.292799 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:36:21.362135 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 18, in model
  TypeError: drop_duplicates() got an unexpected keyword argument 'subset'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:36:21.363135 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77533406-effd-4f4b-b3c0-befeedff98dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B513911850>]}
[0m18:36:21.364135 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 1.85s]
[0m18:36:21.366135 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:36:21.370135 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:36:21.370135 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:36:21.371135 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:36:21.372136 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:36:21.373135 [info ] [MainThread]: 
[0m18:36:21.374136 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.67 seconds (3.67s).
[0m18:36:21.375137 [debug] [MainThread]: Command end result
[0m18:36:21.386775 [info ] [MainThread]: 
[0m18:36:21.386775 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:36:21.392728 [info ] [MainThread]: 
[0m18:36:21.393738 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 18, in model
  TypeError: drop_duplicates() got an unexpected keyword argument 'subset'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:36:21.395740 [info ] [MainThread]: 
[0m18:36:21.396739 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:36:21.397907 [debug] [MainThread]: Command `dbt run` failed at 18:36:21.397907 after 4.46 seconds
[0m18:36:21.400136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B506911050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B50ACC5B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B50AC3D110>]}
[0m18:36:21.401134 [debug] [MainThread]: Flushing usage events
[0m18:36:43.400724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7F79A7FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7F79A7A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7F7EAD750>]}


============================== 18:36:43.400724 | 1e0bbf79-286d-4974-ae54-16109aaf7bf5 ==============================
[0m18:36:43.400724 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:36:43.400724 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_emp', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:36:43.932797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1e0bbf79-286d-4974-ae54-16109aaf7bf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7FE162D50>]}
[0m18:36:43.953027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1e0bbf79-286d-4974-ae54-16109aaf7bf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7FE162D50>]}
[0m18:36:43.953027 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:36:43.968722 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:36:44.048800 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:36:44.048800 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:36:44.103366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1e0bbf79-286d-4974-ae54-16109aaf7bf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7FFEB5B10>]}
[0m18:36:44.119004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1e0bbf79-286d-4974-ae54-16109aaf7bf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7FFD9B350>]}
[0m18:36:44.119004 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:36:44.119004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e0bbf79-286d-4974-ae54-16109aaf7bf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7FFD19390>]}
[0m18:36:44.119004 [info ] [MainThread]: 
[0m18:36:44.119004 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:36:44.134628 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:36:44.152168 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:36:44.152168 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:36:44.152168 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:36:45.051633 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:36:45.067065 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:36:45.120767 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:36:45.136169 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:36:45.136169 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:36:45.136169 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:36:45.953810 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m18:36:45.953810 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:36:46.032913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e0bbf79-286d-4974-ae54-16109aaf7bf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7F77885D0>]}
[0m18:36:46.032913 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:36:46.032913 [info ] [MainThread]: 
[0m18:36:46.052531 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:36:46.053527 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:36:46.055505 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:36:46.056530 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:36:46.090857 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:36:46.090857 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:36:46.057530 => 18:36:46.090857
[0m18:36:46.090857 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:36:46.118738 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:36:46.134387 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:36:46.134387 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.drop_duplicates(
         subset=["empname".upper()], keep="first"
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:36:46.134387 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:36:47.600555 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074b2-0001-0d24-0000-000299e6ea09
[0m18:36:47.600555 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 18, in model
TypeError: drop_duplicates() got an unexpected keyword argument 'subset'
 in function STG_EMP__DBT_SP with handler main
[0m18:36:47.600555 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:36:46.090857 => 18:36:47.600555
[0m18:36:47.600555 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:36:47.663300 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 18, in model
  TypeError: drop_duplicates() got an unexpected keyword argument 'subset'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:36:47.663300 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e0bbf79-286d-4974-ae54-16109aaf7bf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7800637D0>]}
[0m18:36:47.663300 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 1.61s]
[0m18:36:47.678681 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:36:47.680689 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:36:47.680689 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:36:47.680689 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:36:47.680689 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:36:47.680689 [info ] [MainThread]: 
[0m18:36:47.680689 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.56 seconds (3.56s).
[0m18:36:47.686994 [debug] [MainThread]: Command end result
[0m18:36:47.703297 [info ] [MainThread]: 
[0m18:36:47.704295 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:36:47.705330 [info ] [MainThread]: 
[0m18:36:47.707294 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 18, in model
  TypeError: drop_duplicates() got an unexpected keyword argument 'subset'
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:36:47.708499 [info ] [MainThread]: 
[0m18:36:47.711516 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:36:47.712504 [debug] [MainThread]: Command `dbt run` failed at 18:36:47.712504 after 4.34 seconds
[0m18:36:47.713518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7F76D6710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7F6B46F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7F6B475D0>]}
[0m18:36:47.714503 [debug] [MainThread]: Flushing usage events
[0m18:37:43.740771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A5D31350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A5DCA810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A5A49F10>]}


============================== 18:37:43.740771 | caae4276-e57a-4a4f-acd1-5bcdbc4b34a7 ==============================
[0m18:37:43.740771 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:37:43.740771 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_emp', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:37:44.273246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'caae4276-e57a-4a4f-acd1-5bcdbc4b34a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A5D33810>]}
[0m18:37:44.289539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'caae4276-e57a-4a4f-acd1-5bcdbc4b34a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129AE004C10>]}
[0m18:37:44.289539 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:37:44.310717 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:37:44.400715 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:37:44.400715 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:37:44.457648 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'caae4276-e57a-4a4f-acd1-5bcdbc4b34a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129AE049750>]}
[0m18:37:44.473269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'caae4276-e57a-4a4f-acd1-5bcdbc4b34a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129AE10C990>]}
[0m18:37:44.473269 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:37:44.473269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'caae4276-e57a-4a4f-acd1-5bcdbc4b34a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A17F6A50>]}
[0m18:37:44.473269 [info ] [MainThread]: 
[0m18:37:44.473269 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:37:44.473269 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:37:44.494834 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:37:44.494834 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:37:44.501490 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:37:45.428002 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:37:45.429999 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:37:45.497672 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:37:45.497672 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:37:45.497672 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:37:45.513319 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:37:46.247726 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m18:37:46.247726 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:37:46.332343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'caae4276-e57a-4a4f-acd1-5bcdbc4b34a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129AC643650>]}
[0m18:37:46.332343 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:37:46.332343 [info ] [MainThread]: 
[0m18:37:46.347960 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:37:46.348925 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:37:46.350927 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:37:46.351926 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:37:46.386869 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:37:46.388866 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:37:46.352925 => 18:37:46.387864
[0m18:37:46.389866 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:37:46.420390 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:37:46.420390 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:37:46.420390 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp").to_pandas()

    
    int_emp = stg_emp.drop_duplicates(
         subset=["empname".upper()], keep="first"
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:37:46.420390 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:37:48.100993 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074b3-0001-0d24-0000-000299e6ea19
[0m18:37:48.102168 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:37:48.102168 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:37:46.389866 => 18:37:48.102168
[0m18:37:48.102168 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:37:48.169129 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:37:48.169129 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'caae4276-e57a-4a4f-acd1-5bcdbc4b34a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129AE0E3010>]}
[0m18:37:48.184551 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 1.82s]
[0m18:37:48.184551 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:37:48.184551 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:37:48.184551 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:37:48.184551 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:37:48.184551 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:37:48.184551 [info ] [MainThread]: 
[0m18:37:48.184551 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.71 seconds (3.71s).
[0m18:37:48.198069 [debug] [MainThread]: Command end result
[0m18:37:48.203645 [info ] [MainThread]: 
[0m18:37:48.203645 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:37:48.203645 [info ] [MainThread]: 
[0m18:37:48.203645 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:37:48.226278 [info ] [MainThread]: 
[0m18:37:48.227278 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:37:48.228365 [debug] [MainThread]: Command `dbt run` failed at 18:37:48.228365 after 4.51 seconds
[0m18:37:48.228365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A5E201D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A5AE7610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000129A62117D0>]}
[0m18:37:48.228365 [debug] [MainThread]: Flushing usage events
[0m18:38:48.681894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D83CB0A850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D83CB37ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D83CC2BC90>]}


============================== 18:38:48.697521 | e7ca23a3-e641-4ce6-81aa-17c1774d9006 ==============================
[0m18:38:48.697521 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:38:48.697521 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_emp', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:39:00.745542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7ca23a3-e641-4ce6-81aa-17c1774d9006', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D83CB43F10>]}
[0m18:39:00.761174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7ca23a3-e641-4ce6-81aa-17c1774d9006', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D84547F8D0>]}
[0m18:39:00.761174 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:39:00.783335 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:39:00.868913 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:39:00.868913 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:39:00.868913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7ca23a3-e641-4ce6-81aa-17c1774d9006', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D845EFF450>]}
[0m18:39:00.883455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7ca23a3-e641-4ce6-81aa-17c1774d9006', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D845E2FC50>]}
[0m18:39:00.883455 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:39:00.883455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7ca23a3-e641-4ce6-81aa-17c1774d9006', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D845E1D290>]}
[0m18:39:00.899095 [info ] [MainThread]: 
[0m18:39:00.899095 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:39:00.899095 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:39:00.920422 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:39:00.922172 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:39:00.922172 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:39:01.949181 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:39:01.949181 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:39:02.018486 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:39:02.033901 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:39:02.033901 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:39:02.033901 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:39:02.687979 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m18:39:02.687979 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:39:02.781774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7ca23a3-e641-4ce6-81aa-17c1774d9006', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D845F80710>]}
[0m18:39:02.781774 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:39:02.781774 [info ] [MainThread]: 
[0m18:39:02.788319 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:39:02.788319 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:39:02.796237 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:39:02.797236 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:39:02.822630 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:39:02.822630 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:39:02.798246 => 18:39:02.822630
[0m18:39:02.822630 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:39:02.870239 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:39:02.870239 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:39:02.870239 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp").to_pandas()

    
    int_emp = stg_emp.drop_duplicates(
         subset=["empname".upper()], keep="first"
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:39:02.870239 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:39:04.623552 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074b5-0001-0d24-0000-000299e6ea2d
[0m18:39:04.623552 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:39:04.623552 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:39:02.822630 => 18:39:04.623552
[0m18:39:04.623552 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:39:04.692310 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:39:04.692310 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7ca23a3-e641-4ce6-81aa-17c1774d9006', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D845E2DF10>]}
[0m18:39:04.692310 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 1.90s]
[0m18:39:04.692310 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:39:04.692310 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:39:04.707984 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:39:04.709460 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:39:04.711459 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:39:04.712460 [info ] [MainThread]: 
[0m18:39:04.714458 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.81 seconds (3.81s).
[0m18:39:04.715688 [debug] [MainThread]: Command end result
[0m18:39:04.729033 [info ] [MainThread]: 
[0m18:39:04.729033 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:39:04.733280 [info ] [MainThread]: 
[0m18:39:04.734291 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:39:04.739992 [info ] [MainThread]: 
[0m18:39:04.744470 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:39:04.746182 [debug] [MainThread]: Command `dbt run` failed at 18:39:04.745140 after 16.08 seconds
[0m18:39:04.746182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D83C85CC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D83C85A0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D83C813D90>]}
[0m18:39:04.747182 [debug] [MainThread]: Flushing usage events
[0m18:43:54.452823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD8CC90850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD8C7B7210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD8C4DAC50>]}


============================== 18:43:54.452823 | 7bdb27fe-4c75-40d1-a4ad-a945ac40eb84 ==============================
[0m18:43:54.452823 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:43:54.452823 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_emp', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:43:55.433682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7bdb27fe-4c75-40d1-a4ad-a945ac40eb84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD95A48050>]}
[0m18:43:55.445977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7bdb27fe-4c75-40d1-a4ad-a945ac40eb84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD94FAF150>]}
[0m18:43:55.454019 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:43:55.465778 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:43:55.542520 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:43:55.542520 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:43:55.609069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7bdb27fe-4c75-40d1-a4ad-a945ac40eb84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD95A79410>]}
[0m18:43:55.624722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7bdb27fe-4c75-40d1-a4ad-a945ac40eb84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD95B2C510>]}
[0m18:43:55.624722 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:43:55.624722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7bdb27fe-4c75-40d1-a4ad-a945ac40eb84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD881FEB10>]}
[0m18:43:55.624722 [info ] [MainThread]: 
[0m18:43:55.624722 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:43:55.624722 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:43:55.646289 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:43:55.646289 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:43:55.646289 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:56.766767 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:43:56.766767 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:43:56.820425 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:43:56.835842 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:43:56.835842 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:43:56.835842 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:57.606353 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m18:43:57.621776 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:43:57.690530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7bdb27fe-4c75-40d1-a4ad-a945ac40eb84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD95AA40D0>]}
[0m18:43:57.690530 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:43:57.690530 [info ] [MainThread]: 
[0m18:43:57.709618 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:43:57.710617 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:43:57.712802 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:43:57.712802 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:43:57.745878 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:43:57.745878 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:43:57.712802 => 18:43:57.745878
[0m18:43:57.745878 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:43:57.787197 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:43:57.790198 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:43:57.791200 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp").to_pandas()

    
    int_emp = stg_emp.drop_duplicates(
      
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:43:57.792199 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:43:59.441898 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074b9-0001-0d23-0000-000299e6f9cd
[0m18:43:59.441898 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
    results_cursor.fetch_pandas_all(), results_cursor
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
    self.check_can_use_pandas()
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 15, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
    result = self._session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
    return self._to_data_or_iter(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
    raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
 in function STG_EMP__DBT_SP with handler main
[0m18:43:59.441898 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:43:57.745878 => 18:43:59.441898
[0m18:43:59.441898 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:43:59.511118 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:43:59.511118 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bdb27fe-4c75-40d1-a4ad-a945ac40eb84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD960870D0>]}
[0m18:43:59.511118 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 1.80s]
[0m18:43:59.511118 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:43:59.526497 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:43:59.526497 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:43:59.526497 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:43:59.526497 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:43:59.526497 [info ] [MainThread]: 
[0m18:43:59.526497 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.90 seconds (3.90s).
[0m18:43:59.536027 [debug] [MainThread]: Command end result
[0m18:43:59.550343 [info ] [MainThread]: 
[0m18:43:59.551661 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:43:59.553498 [info ] [MainThread]: 
[0m18:43:59.554509 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 408, in _to_data_or_iter
      results_cursor.fetch_pandas_all(), results_cursor
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 1015, in fetch_pandas_all
      self.check_can_use_pandas()
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 946, in check_can_use_pandas
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.connector.errors.ProgrammingError: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 15, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 139, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 766, in to_pandas
      result = self._session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 374, in run_query
      return self._to_data_or_iter(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 418, in _to_data_or_iter
      raise SnowparkClientExceptionMessages.SERVER_FAILED_FETCH_PANDAS(
  snowflake.snowpark.exceptions.SnowparkFetchDataException: (1406): Failed to fetch a Pandas Dataframe. The error is: 255002: Optional dependency: 'pyarrow' is not installed, please see the following link for install instructions: https://docs.snowflake.com/en/user-guide/python-connector-pandas.html#installation
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m18:43:59.563425 [info ] [MainThread]: 
[0m18:43:59.564442 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:43:59.566436 [debug] [MainThread]: Command `dbt run` failed at 18:43:59.566436 after 5.13 seconds
[0m18:43:59.567423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD8C85A9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD8CCA2650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CD8C896290>]}
[0m18:43:59.568423 [debug] [MainThread]: Flushing usage events
[0m18:44:15.234642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002161ED83F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002161ED111D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002161ED01ED0>]}


============================== 18:44:15.234642 | 015e3d91-455f-43c2-a41b-8c0c9844d88f ==============================
[0m18:44:15.234642 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:44:15.234642 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_emp', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:44:16.207244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '015e3d91-455f-43c2-a41b-8c0c9844d88f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021627EC86D0>]}
[0m18:44:16.225384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '015e3d91-455f-43c2-a41b-8c0c9844d88f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021626AF7150>]}
[0m18:44:16.227448 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:44:16.235574 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:44:16.327412 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:44:16.327412 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:44:16.382278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '015e3d91-455f-43c2-a41b-8c0c9844d88f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021627FB0910>]}
[0m18:44:16.397911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '015e3d91-455f-43c2-a41b-8c0c9844d88f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021628079DD0>]}
[0m18:44:16.397911 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:44:16.397911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '015e3d91-455f-43c2-a41b-8c0c9844d88f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002161A75EB90>]}
[0m18:44:16.397911 [info ] [MainThread]: 
[0m18:44:16.397911 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:44:16.397911 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:44:16.420517 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:44:16.420517 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:44:16.420517 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:44:17.542668 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:44:17.542668 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:44:17.616194 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:44:17.631843 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:44:17.631843 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:44:17.631843 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:44:18.403647 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m18:44:18.419090 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:44:18.503704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '015e3d91-455f-43c2-a41b-8c0c9844d88f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216281BAAD0>]}
[0m18:44:18.503704 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:44:18.503704 [info ] [MainThread]: 
[0m18:44:18.519276 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:44:18.519276 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:44:18.525852 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:44:18.526853 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:44:18.544977 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:44:18.562041 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:44:18.527852 => 18:44:18.562041
[0m18:44:18.563043 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:44:18.594597 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:44:18.594597 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:44:18.594597 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.drop_duplicates(
      
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:44:18.594597 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:44:21.426970 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m18:44:21.458025 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:44:18.564042 => 18:44:21.458025
[0m18:44:21.458025 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:44:21.542990 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '015e3d91-455f-43c2-a41b-8c0c9844d88f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021628008C90>]}
[0m18:44:21.542990 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.stg_emp ....................... [[32mSUCCESS 1[0m in 3.02s]
[0m18:44:21.542990 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:44:21.542990 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:44:21.542990 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:44:21.542990 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:44:21.542990 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:44:21.542990 [info ] [MainThread]: 
[0m18:44:21.558568 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.15 seconds (5.15s).
[0m18:44:21.560242 [debug] [MainThread]: Command end result
[0m18:44:21.564513 [info ] [MainThread]: 
[0m18:44:21.564513 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:44:21.575362 [info ] [MainThread]: 
[0m18:44:21.576503 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:44:21.579514 [debug] [MainThread]: Command `dbt run` succeeded at 18:44:21.579514 after 6.37 seconds
[0m18:44:21.580546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002161ED83950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002161EAB9D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002161F1AF1D0>]}
[0m18:44:21.580820 [debug] [MainThread]: Flushing usage events
[0m18:53:06.151707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024946DD3610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024946B06FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024946B05F50>]}


============================== 18:53:06.151707 | 282958d2-7772-49c1-b00f-1e5fca6b7f8c ==============================
[0m18:53:06.151707 [info ] [MainThread]: Running with dbt=1.6.6
[0m18:53:06.151707 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_emp', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:53:07.130850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '282958d2-7772-49c1-b00f-1e5fca6b7f8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249472C5750>]}
[0m18:53:07.143169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '282958d2-7772-49c1-b00f-1e5fca6b7f8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024947511C50>]}
[0m18:53:07.143169 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m18:53:07.151226 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m18:53:07.239391 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:53:07.239391 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m18:53:07.298347 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '282958d2-7772-49c1-b00f-1e5fca6b7f8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249472BD690>]}
[0m18:53:07.313975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '282958d2-7772-49c1-b00f-1e5fca6b7f8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002495011F110>]}
[0m18:53:07.313975 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m18:53:07.313975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '282958d2-7772-49c1-b00f-1e5fca6b7f8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000249427DEB90>]}
[0m18:53:07.313975 [info ] [MainThread]: 
[0m18:53:07.313975 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:53:07.313975 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m18:53:07.343135 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m18:53:07.344135 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m18:53:07.345136 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:53:08.385886 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m18:53:08.385886 [debug] [ThreadPool]: On list_demo_database: Close
[0m18:53:08.462303 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m18:53:08.474296 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m18:53:08.475295 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m18:53:08.476297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:53:09.269937 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m18:53:09.285638 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m18:53:09.370286 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '282958d2-7772-49c1-b00f-1e5fca6b7f8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002495057CC50>]}
[0m18:53:09.370286 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m18:53:09.370286 [info ] [MainThread]: 
[0m18:53:09.386971 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m18:53:09.388971 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m18:53:09.390987 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m18:53:09.391972 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m18:53:09.425575 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m18:53:09.427579 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 18:53:09.391972 => 18:53:09.427579
[0m18:53:09.428824 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m18:53:09.456964 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m18:53:09.456964 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m18:53:09.471103 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.limit(4
      
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m18:53:09.472810 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:53:13.456688 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m18:53:13.489121 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 18:53:09.428824 => 18:53:13.479894
[0m18:53:13.489121 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m18:53:13.555814 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '282958d2-7772-49c1-b00f-1e5fca6b7f8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002494F808490>]}
[0m18:53:13.555814 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.stg_emp ....................... [[32mSUCCESS 1[0m in 4.17s]
[0m18:53:13.555814 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m18:53:13.555814 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:53:13.555814 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m18:53:13.555814 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m18:53:13.555814 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m18:53:13.555814 [info ] [MainThread]: 
[0m18:53:13.555814 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.24 seconds (6.24s).
[0m18:53:13.569578 [debug] [MainThread]: Command end result
[0m18:53:13.579841 [info ] [MainThread]: 
[0m18:53:13.587834 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:53:13.589837 [info ] [MainThread]: 
[0m18:53:13.591833 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:53:13.594781 [debug] [MainThread]: Command `dbt run` succeeded at 18:53:13.593752 after 7.46 seconds
[0m18:53:13.594781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024946E02450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024946DEEAD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002494727F0D0>]}
[0m18:53:13.595754 [debug] [MainThread]: Flushing usage events
[0m19:15:08.083126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EF9989C2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EF99C701D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EF99B47210>]}


============================== 19:15:08.087127 | a5a17d6f-fdb2-415e-8122-6ba6ea75570e ==============================
[0m19:15:08.087127 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:15:08.088096 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select insert', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:15:09.154392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a5a17d6f-fdb2-415e-8122-6ba6ea75570e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EF99B77E50>]}
[0m19:15:09.172427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a5a17d6f-fdb2-415e-8122-6ba6ea75570e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EFA1BA0DD0>]}
[0m19:15:09.174394 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:15:09.186423 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:15:09.286427 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:15:09.287425 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:15:09.294394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a5a17d6f-fdb2-415e-8122-6ba6ea75570e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EFA2F7F490>]}
[0m19:15:09.309427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a5a17d6f-fdb2-415e-8122-6ba6ea75570e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EFA2EAAC50>]}
[0m19:15:09.310428 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:15:09.311407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a5a17d6f-fdb2-415e-8122-6ba6ea75570e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EFA2E9E410>]}
[0m19:15:09.313426 [info ] [MainThread]: 
[0m19:15:09.314407 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:15:09.316395 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:15:09.335434 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:15:09.336399 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:15:09.337433 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:10.416234 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:15:10.420227 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:15:10.494885 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:15:10.508851 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:15:10.509881 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:15:10.511879 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:11.184182 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m19:15:11.192129 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:15:11.273309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a5a17d6f-fdb2-415e-8122-6ba6ea75570e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EFA3000190>]}
[0m19:15:11.274308 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:15:11.276306 [info ] [MainThread]: 
[0m19:15:11.285306 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m19:15:11.286308 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m19:15:11.289309 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m19:15:11.291307 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m19:15:11.336311 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m19:15:11.338310 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 19:15:11.291307 => 19:15:11.338310
[0m19:15:11.340316 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m19:15:11.381309 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m19:15:11.384332 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m19:15:11.385337 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = f"insert into {table} values (7,'adad',6666);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m19:15:11.386339 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:15:14.802169 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074d9-0001-0d23-0000-000299e6fa19
[0m19:15:14.803203 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b074d9-0001-0d23-0000-000299e6fa29: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m19:15:14.804199 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 19:15:11.341310 => 19:15:14.804199
[0m19:15:14.805206 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m19:15:14.886813 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b074d9-0001-0d23-0000-000299e6fa29: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m19:15:14.887811 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a5a17d6f-fdb2-415e-8122-6ba6ea75570e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EFA1837190>]}
[0m19:15:14.888814 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 3.60s]
[0m19:15:14.890810 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m19:15:14.893813 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:15:14.894813 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:15:14.895813 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:15:14.895813 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m19:15:14.896812 [info ] [MainThread]: 
[0m19:15:14.897814 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.58 seconds (5.58s).
[0m19:15:14.899813 [debug] [MainThread]: Command end result
[0m19:15:14.913812 [info ] [MainThread]: 
[0m19:15:14.928815 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:15:14.935813 [info ] [MainThread]: 
[0m19:15:14.937815 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b074d9-0001-0d23-0000-000299e6fa29: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m19:15:14.945812 [info ] [MainThread]: 
[0m19:15:14.947812 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:15:14.952814 [debug] [MainThread]: Command `dbt run` failed at 19:15:14.952814 after 6.90 seconds
[0m19:15:14.953814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EF998B4DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EF99B779D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EF9989AD10>]}
[0m19:15:14.954817 [debug] [MainThread]: Flushing usage events
[0m19:15:56.066869 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9BC4B3950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9BC7E01D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9BC6F90D0>]}


============================== 19:15:56.071870 | f85eb05c-bde7-433e-9fc8-0ab33bbff1b8 ==============================
[0m19:15:56.071870 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:15:56.073868 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select insert', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:15:57.197562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f85eb05c-bde7-433e-9fc8-0ab33bbff1b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9BCBD8450>]}
[0m19:15:57.218561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f85eb05c-bde7-433e-9fc8-0ab33bbff1b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9C59C8810>]}
[0m19:15:57.220562 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:15:57.236567 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:15:57.336564 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:15:57.337564 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:15:57.344563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f85eb05c-bde7-433e-9fc8-0ab33bbff1b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9C4541790>]}
[0m19:15:57.360565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f85eb05c-bde7-433e-9fc8-0ab33bbff1b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9C5A05C50>]}
[0m19:15:57.361565 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:15:57.362565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f85eb05c-bde7-433e-9fc8-0ab33bbff1b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B814EB90>]}
[0m19:15:57.364564 [info ] [MainThread]: 
[0m19:15:57.365566 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:15:57.367566 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:15:57.385567 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:15:57.387568 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:15:57.387568 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:58.393532 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:15:58.395530 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:15:58.459500 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:15:58.470532 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:15:58.471532 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:15:58.472532 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:59.294146 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m19:15:59.297146 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:15:59.362116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f85eb05c-bde7-433e-9fc8-0ab33bbff1b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9C5E8A810>]}
[0m19:15:59.364117 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:15:59.365117 [info ] [MainThread]: 
[0m19:15:59.373116 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m19:15:59.374142 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m19:15:59.376119 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m19:15:59.377149 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m19:15:59.415147 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m19:15:59.420118 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 19:15:59.377149 => 19:15:59.419119
[0m19:15:59.421118 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m19:15:59.464117 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m19:15:59.467118 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m19:15:59.468118 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = f"insert into {table} values (7,'adad',6666);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m19:15:59.469119 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:16:01.827156 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074da-0001-0d24-0000-000299e6ea7d
[0m19:16:01.828156 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b074da-0001-0d24-0000-000299e6ea8d: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m19:16:01.830167 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 19:15:59.421118 => 19:16:01.830167
[0m19:16:01.831157 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m19:16:01.892629 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b074da-0001-0d24-0000-000299e6ea8d: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m19:16:01.893645 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f85eb05c-bde7-433e-9fc8-0ab33bbff1b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9C59FE050>]}
[0m19:16:01.894598 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 2.52s]
[0m19:16:01.896630 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m19:16:01.899629 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:16:01.899629 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:16:01.900598 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:16:01.901598 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m19:16:01.901598 [info ] [MainThread]: 
[0m19:16:01.903603 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.54 seconds (4.54s).
[0m19:16:01.905599 [debug] [MainThread]: Command end result
[0m19:16:01.921599 [info ] [MainThread]: 
[0m19:16:01.922604 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:16:01.924601 [info ] [MainThread]: 
[0m19:16:01.925650 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b074da-0001-0d24-0000-000299e6ea8d: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m19:16:01.931599 [info ] [MainThread]: 
[0m19:16:01.933608 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:16:01.935606 [debug] [MainThread]: Command `dbt run` failed at 19:16:01.934614 after 5.90 seconds
[0m19:16:01.936605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9BC6F1550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9BC7C6A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D9B9A4F990>]}
[0m19:16:01.937601 [debug] [MainThread]: Flushing usage events
[0m19:25:05.148338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349EC010D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349E7A5F50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349E4EFF10>]}


============================== 19:25:05.153307 | 577affbb-2177-4abe-a283-5a930b970039 ==============================
[0m19:25:05.153307 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:25:05.155338 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_emp', 'send_anonymous_usage_stats': 'True'}
[0m19:25:06.232053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '577affbb-2177-4abe-a283-5a930b970039', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234A7A2FF10>]}
[0m19:25:06.250053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '577affbb-2177-4abe-a283-5a930b970039', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349EC1F8D0>]}
[0m19:25:06.252055 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:25:06.265056 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:25:06.365663 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:25:06.366665 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m19:25:06.422701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '577affbb-2177-4abe-a283-5a930b970039', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349EBF2890>]}
[0m19:25:06.439667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '577affbb-2177-4abe-a283-5a930b970039', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234A7A50050>]}
[0m19:25:06.440668 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:25:06.441666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '577affbb-2177-4abe-a283-5a930b970039', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234A6F8E8D0>]}
[0m19:25:06.443668 [info ] [MainThread]: 
[0m19:25:06.445704 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:25:06.447216 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:25:06.465261 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:25:06.466227 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:25:06.467260 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:25:07.556953 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:25:07.562940 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:25:07.649188 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:25:07.666223 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:25:07.668221 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:25:07.669186 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:25:08.468179 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m19:25:08.473178 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:25:08.561636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '577affbb-2177-4abe-a283-5a930b970039', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234A73DEA50>]}
[0m19:25:08.563637 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:25:08.565064 [info ] [MainThread]: 
[0m19:25:08.576625 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m19:25:08.577656 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m19:25:08.579626 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m19:25:08.579626 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m19:25:08.616662 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m19:25:08.618659 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 19:25:08.580625 => 19:25:08.618659
[0m19:25:08.619660 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m19:25:08.664625 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m19:25:08.668140 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m19:25:08.668140 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.drop_dublicates(
      
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m19:25:08.669141 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:25:11.603304 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074e3-0001-0d24-0000-000299e6eb55
[0m19:25:11.604305 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 107, in main
  File "_udf_code.py", line 18, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute drop_dublicates
 in function STG_EMP__DBT_SP with handler main
[0m19:25:11.605304 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 19:25:08.620626 => 19:25:11.605304
[0m19:25:11.607269 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m19:25:11.684266 [debug] [Thread-1 (]: Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 18, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute drop_dublicates
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m19:25:11.684266 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '577affbb-2177-4abe-a283-5a930b970039', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234A8052B90>]}
[0m19:25:11.685267 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.stg_emp ................... [[31mERROR[0m in 3.11s]
[0m19:25:11.687269 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m19:25:11.690268 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:25:11.691268 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:25:11.692269 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:25:11.692269 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m19:25:11.693268 [info ] [MainThread]: 
[0m19:25:11.695271 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.25 seconds (5.25s).
[0m19:25:11.697271 [debug] [MainThread]: Command end result
[0m19:25:11.715267 [info ] [MainThread]: 
[0m19:25:11.716271 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:25:11.718297 [info ] [MainThread]: 
[0m19:25:11.719274 [error] [MainThread]:   Database Error in model stg_emp (models\example\stg_emp.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 107, in main
    File "_udf_code.py", line 18, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute drop_dublicates
   in function STG_EMP__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\stg_emp.py
[0m19:25:11.722270 [info ] [MainThread]: 
[0m19:25:11.723276 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:25:11.726271 [debug] [MainThread]: Command `dbt run` failed at 19:25:11.725282 after 6.61 seconds
[0m19:25:11.729308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349E718090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349E44F010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002349E444D10>]}
[0m19:25:11.730270 [debug] [MainThread]: Flushing usage events
[0m19:25:53.884812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A425828BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A425D02A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A4258F6F50>]}


============================== 19:25:53.888813 | 995c82bf-e880-414d-9806-b596d787f50c ==============================
[0m19:25:53.888813 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:25:53.889815 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_emp', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:25:54.942076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '995c82bf-e880-414d-9806-b596d787f50c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A42E4EE5D0>]}
[0m19:25:54.960111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '995c82bf-e880-414d-9806-b596d787f50c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A42EB5C650>]}
[0m19:25:54.962078 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:25:54.975108 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:25:55.081125 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:25:55.082082 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\stg_emp.py
[0m19:25:55.139080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '995c82bf-e880-414d-9806-b596d787f50c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A42EB4B390>]}
[0m19:25:55.154087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '995c82bf-e880-414d-9806-b596d787f50c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A42EC1DFD0>]}
[0m19:25:55.155091 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:25:55.157113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '995c82bf-e880-414d-9806-b596d787f50c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A4212DEB50>]}
[0m19:25:55.158082 [info ] [MainThread]: 
[0m19:25:55.160435 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:25:55.162402 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:25:55.182433 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:25:55.183441 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:25:55.184436 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:25:56.205951 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:25:56.207982 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:25:56.267698 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:25:56.278694 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:25:56.279663 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:25:56.279663 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:25:56.925859 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m19:25:56.933853 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:25:57.007812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '995c82bf-e880-414d-9806-b596d787f50c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A425820E10>]}
[0m19:25:57.008826 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:25:57.009834 [info ] [MainThread]: 
[0m19:25:57.019282 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.stg_emp
[0m19:25:57.020283 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.stg_emp ............................ [RUN]
[0m19:25:57.022285 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.stg_emp'
[0m19:25:57.023317 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.stg_emp
[0m19:25:57.063283 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.stg_emp"
[0m19:25:57.066284 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (compile): 19:25:57.024315 => 19:25:57.065316
[0m19:25:57.066284 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.stg_emp
[0m19:25:57.108314 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.stg_emp"
[0m19:25:57.112284 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.stg_emp"
[0m19:25:57.113283 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.stg_emp"} */
WITH stg_emp__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")
    
    stg_emp= dbt.ref("src_emp")

    
    int_emp = stg_emp.drop_duplicates(
      
    )
    

    return int_emp


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "stg_emp"
    
    def __repr__(self):
        return 'demo_database.demo_schema.stg_emp'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.stg_emp', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL stg_emp__dbt_sp();
[0m19:25:57.114313 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:26:00.646146 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m19:26:00.680130 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.stg_emp (execute): 19:25:57.067282 => 19:26:00.679130
[0m19:26:00.681144 [debug] [Thread-1 (]: On model.snowflake_dbt1.stg_emp: Close
[0m19:26:00.764157 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '995c82bf-e880-414d-9806-b596d787f50c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A42EB4B7D0>]}
[0m19:26:00.766199 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.stg_emp ....................... [[32mSUCCESS 1[0m in 3.74s]
[0m19:26:00.769196 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.stg_emp
[0m19:26:00.776198 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:26:00.777203 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:26:00.779157 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:26:00.781197 [debug] [MainThread]: Connection 'model.snowflake_dbt1.stg_emp' was properly closed.
[0m19:26:00.783200 [info ] [MainThread]: 
[0m19:26:00.785155 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.62 seconds (5.62s).
[0m19:26:00.788154 [debug] [MainThread]: Command end result
[0m19:26:00.804151 [info ] [MainThread]: 
[0m19:26:00.805148 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:26:00.806150 [info ] [MainThread]: 
[0m19:26:00.808181 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:26:00.809150 [debug] [MainThread]: Command `dbt run` succeeded at 19:26:00.809150 after 6.95 seconds
[0m19:26:00.810149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A424F0C690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A422913B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A425CEF090>]}
[0m19:26:00.812150 [debug] [MainThread]: Flushing usage events
[0m19:30:00.178020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD795E6CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD79540050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD78BC0C10>]}


============================== 19:30:00.183018 | 1e817b2b-5351-4984-a0ab-19c0e04e3840 ==============================
[0m19:30:00.183018 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:30:00.185014 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:30:01.290934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1e817b2b-5351-4984-a0ab-19c0e04e3840', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD022265D0>]}
[0m19:30:01.309934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1e817b2b-5351-4984-a0ab-19c0e04e3840', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD02895310>]}
[0m19:30:01.310931 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:30:01.322934 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:30:01.422937 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:30:01.423936 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:30:01.430937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1e817b2b-5351-4984-a0ab-19c0e04e3840', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD012B7310>]}
[0m19:30:01.446907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1e817b2b-5351-4984-a0ab-19c0e04e3840', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD028DA650>]}
[0m19:30:01.448909 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:30:01.450907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e817b2b-5351-4984-a0ab-19c0e04e3840', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD7501EB10>]}
[0m19:30:01.452905 [info ] [MainThread]: 
[0m19:30:01.454906 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:30:01.456906 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:30:01.475907 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:30:01.476907 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:30:01.476907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:30:02.574227 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:30:02.581258 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:30:02.648619 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:30:02.665618 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:30:02.666616 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:30:02.667617 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:30:03.454286 [debug] [ThreadPool]: SQL status: SUCCESS 40 in 1.0 seconds
[0m19:30:03.458283 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:30:03.541273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e817b2b-5351-4984-a0ab-19c0e04e3840', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD02908E10>]}
[0m19:30:03.542278 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:30:03.543276 [info ] [MainThread]: 
[0m19:30:03.552275 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:30:03.553310 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:30:03.556277 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:30:03.557279 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:30:03.595274 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:30:03.598277 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:30:03.558276 => 19:30:03.597275
[0m19:30:03.600287 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:30:03.641276 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:30:03.644274 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:30:03.645275 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    

    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:30:03.645275 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:30:08.822377 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 5.0 seconds
[0m19:30:08.863355 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:30:03.601323 => 19:30:08.863355
[0m19:30:08.864354 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:30:08.936050 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e817b2b-5351-4984-a0ab-19c0e04e3840', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD028ABDD0>]}
[0m19:30:08.937058 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 5.38s]
[0m19:30:08.939050 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:30:08.943050 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:30:08.944050 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:30:08.945050 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:30:08.946049 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:30:08.947052 [info ] [MainThread]: 
[0m19:30:08.949053 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.49 seconds (7.49s).
[0m19:30:08.951055 [debug] [MainThread]: Command end result
[0m19:30:08.966050 [info ] [MainThread]: 
[0m19:30:08.968063 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:30:08.970090 [info ] [MainThread]: 
[0m19:30:08.972053 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:30:08.974055 [debug] [MainThread]: Command `dbt run` succeeded at 19:30:08.974055 after 8.83 seconds
[0m19:30:08.975049 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD792FB1D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD791A0890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BD7925AB50>]}
[0m19:30:08.976049 [debug] [MainThread]: Flushing usage events
[0m19:31:11.459838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028737EEA6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028737F932D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028737EEAD10>]}


============================== 19:31:11.464807 | d2f2f6a0-ac05-4093-a86d-e129bd035dca ==============================
[0m19:31:11.464807 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:31:11.465807 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:31:12.572448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd2f2f6a0-ac05-4093-a86d-e129bd035dca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002874019C4D0>]}
[0m19:31:12.591450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd2f2f6a0-ac05-4093-a86d-e129bd035dca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002874019F490>]}
[0m19:31:12.593418 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:31:12.607431 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:31:12.705069 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:31:12.706071 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:31:12.762039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd2f2f6a0-ac05-4093-a86d-e129bd035dca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000287414E9E50>]}
[0m19:31:12.777044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd2f2f6a0-ac05-4093-a86d-e129bd035dca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002874151C790>]}
[0m19:31:12.777044 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:31:12.779039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd2f2f6a0-ac05-4093-a86d-e129bd035dca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028733BEEB10>]}
[0m19:31:12.780040 [info ] [MainThread]: 
[0m19:31:12.782040 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:31:12.783924 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:31:12.803940 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:31:12.804973 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:31:12.805973 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:31:13.881281 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:31:13.883270 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:31:13.949481 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:31:13.965447 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:31:13.966446 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:31:13.967446 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:31:14.651772 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:31:14.660774 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:31:14.769025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd2f2f6a0-ac05-4093-a86d-e129bd035dca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002874197CC50>]}
[0m19:31:14.772027 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:31:14.773621 [info ] [MainThread]: 
[0m19:31:14.783618 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:31:14.784622 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:31:14.786641 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:31:14.787645 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:31:14.824647 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:31:14.827620 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:31:14.787645 => 19:31:14.826625
[0m19:31:14.827620 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:31:14.869648 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:31:14.873648 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:31:14.874653 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    result=info(1,1)

    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:31:14.874653 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:31:18.369927 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074e9-0001-0d23-0000-000299e6fb7d
[0m19:31:18.370958 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 104, in main
  File "_udf_code.py", line 16, in model
TypeError: 'DataFrame' object is not callable
 in function DESCRIBE__DBT_SP with handler main
[0m19:31:18.372926 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:31:14.828617 => 19:31:18.371959
[0m19:31:18.373923 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:31:18.434988 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 16, in model
  TypeError: 'DataFrame' object is not callable
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:31:18.435988 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2f2f6a0-ac05-4093-a86d-e129bd035dca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028741A72650>]}
[0m19:31:18.436988 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 3.65s]
[0m19:31:18.439023 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:31:18.441988 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:31:18.441988 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:31:18.442988 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:31:18.442988 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:31:18.443989 [info ] [MainThread]: 
[0m19:31:18.445991 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.66 seconds (5.66s).
[0m19:31:18.450990 [debug] [MainThread]: Command end result
[0m19:31:18.462990 [info ] [MainThread]: 
[0m19:31:18.464511 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:31:18.468525 [info ] [MainThread]: 
[0m19:31:18.470558 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 16, in model
  TypeError: 'DataFrame' object is not callable
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:31:18.472521 [info ] [MainThread]: 
[0m19:31:18.474554 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:31:18.476554 [debug] [MainThread]: Command `dbt run` failed at 19:31:18.475524 after 7.05 seconds
[0m19:31:18.476554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028738204150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028738206950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028737F0FC90>]}
[0m19:31:18.477523 [debug] [MainThread]: Flushing usage events
[0m19:31:38.740862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F65AD1750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F653AB510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F655F81D0>]}


============================== 19:31:38.744847 | bed758d8-07a1-4cc2-a903-f576677ea447 ==============================
[0m19:31:38.744847 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:31:38.746849 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:31:39.817766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bed758d8-07a1-4cc2-a903-f576677ea447', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6E8F8290>]}
[0m19:31:39.836766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bed758d8-07a1-4cc2-a903-f576677ea447', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6D650DD0>]}
[0m19:31:39.838769 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:31:39.851796 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:31:39.952806 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:31:39.953805 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:31:40.011800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bed758d8-07a1-4cc2-a903-f576677ea447', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6E92CD10>]}
[0m19:31:40.025771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bed758d8-07a1-4cc2-a903-f576677ea447', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6E9C8810>]}
[0m19:31:40.026772 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:31:40.028777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bed758d8-07a1-4cc2-a903-f576677ea447', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6D7B4D90>]}
[0m19:31:40.029771 [info ] [MainThread]: 
[0m19:31:40.031797 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:31:40.033770 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:31:40.053801 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:31:40.054805 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:31:40.054805 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:31:41.043244 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:31:41.047202 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:31:41.111277 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:31:41.123275 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:31:41.124276 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:31:41.125275 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:31:41.900090 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:31:41.904090 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:31:41.971091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bed758d8-07a1-4cc2-a903-f576677ea447', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6E9975D0>]}
[0m19:31:41.972090 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:31:41.973110 [info ] [MainThread]: 
[0m19:31:41.983093 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:31:41.985096 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:31:41.986094 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:31:41.987092 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:31:42.027126 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:31:42.030092 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:31:41.988091 => 19:31:42.029092
[0m19:31:42.031092 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:31:42.078097 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:31:42.081092 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:31:42.083094 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    result=info[1,1]

    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:31:42.084092 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:31:44.182431 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074e9-0001-0d24-0000-000299e6ebb9
[0m19:31:44.183464 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 104, in main
  File "_udf_code.py", line 16, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 902, in __getitem__
    return self.select(item)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
    r = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1026, in select
    raise TypeError(
TypeError: The input of select() must be Column, column name, TableFunctionCall, or a list of them
 in function DESCRIBE__DBT_SP with handler main
[0m19:31:44.185465 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:31:42.032092 => 19:31:44.185465
[0m19:31:44.186466 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:31:44.259029 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 16, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 902, in __getitem__
      return self.select(item)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1026, in select
      raise TypeError(
  TypeError: The input of select() must be Column, column name, TableFunctionCall, or a list of them
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:31:44.260062 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bed758d8-07a1-4cc2-a903-f576677ea447', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6EE55B50>]}
[0m19:31:44.262030 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 2.27s]
[0m19:31:44.263030 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:31:44.266029 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:31:44.267064 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:31:44.268030 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:31:44.269035 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:31:44.270061 [info ] [MainThread]: 
[0m19:31:44.271029 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.24 seconds (4.24s).
[0m19:31:44.273063 [debug] [MainThread]: Command end result
[0m19:31:44.289027 [info ] [MainThread]: 
[0m19:31:44.289965 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:31:44.290975 [info ] [MainThread]: 
[0m19:31:44.291976 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 16, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 902, in __getitem__
      return self.select(item)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1026, in select
      raise TypeError(
  TypeError: The input of select() must be Column, column name, TableFunctionCall, or a list of them
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:31:44.295814 [info ] [MainThread]: 
[0m19:31:44.297817 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:31:44.299827 [debug] [MainThread]: Command `dbt run` failed at 19:31:44.298817 after 5.59 seconds
[0m19:31:44.300818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F65AC2290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F64CCCA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028F6532F110>]}
[0m19:31:44.302821 [debug] [MainThread]: Flushing usage events
[0m19:32:47.487040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC52CA890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC52C9E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC531B990>]}


============================== 19:32:47.492044 | 7f1b7937-1869-41b6-8cdf-4b96188edc03 ==============================
[0m19:32:47.492044 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:32:47.494013 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select describe', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:32:48.588413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7f1b7937-1869-41b6-8cdf-4b96188edc03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BCBA77210>]}
[0m19:32:48.607443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7f1b7937-1869-41b6-8cdf-4b96188edc03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BCBA77210>]}
[0m19:32:48.608412 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:32:48.622413 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:32:48.719444 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:32:48.720444 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:32:48.776414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7f1b7937-1869-41b6-8cdf-4b96188edc03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC4F48490>]}
[0m19:32:48.793432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7f1b7937-1869-41b6-8cdf-4b96188edc03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BCE60F310>]}
[0m19:32:48.794415 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:32:48.795433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f1b7937-1869-41b6-8cdf-4b96188edc03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC0CDEB90>]}
[0m19:32:48.797446 [info ] [MainThread]: 
[0m19:32:48.799446 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:32:48.800415 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:32:48.822416 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:32:48.823415 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:32:48.824415 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:32:49.886716 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:32:49.888721 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:32:49.953922 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:32:49.965923 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:32:49.966925 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:32:49.966925 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:32:50.622639 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:32:50.630580 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:32:50.706336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f1b7937-1869-41b6-8cdf-4b96188edc03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC5725590>]}
[0m19:32:50.708333 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:32:50.710304 [info ] [MainThread]: 
[0m19:32:50.721646 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:32:50.722645 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:32:50.725647 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:32:50.726650 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:32:50.763677 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:32:50.765644 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:32:50.727645 => 19:32:50.765644
[0m19:32:50.767648 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:32:50.811674 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:32:50.814644 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:32:50.815676 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    result=info.iloc[1,1]

    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:32:50.816674 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:32:53.207442 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074ea-0001-0d24-0000-000299e6ebf1
[0m19:32:53.208443 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 104, in main
  File "_udf_code.py", line 16, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
    raise AttributeError(
AttributeError: DataFrame object has no attribute iloc
 in function DESCRIBE__DBT_SP with handler main
[0m19:32:53.210442 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:32:50.768647 => 19:32:53.210442
[0m19:32:53.211442 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:32:53.273653 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 16, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: DataFrame object has no attribute iloc
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:32:53.274653 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f1b7937-1869-41b6-8cdf-4b96188edc03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC52396D0>]}
[0m19:32:53.275654 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 2.55s]
[0m19:32:53.277655 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:32:53.279653 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:32:53.280653 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:32:53.281655 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:32:53.282658 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:32:53.283656 [info ] [MainThread]: 
[0m19:32:53.284656 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.49 seconds (4.49s).
[0m19:32:53.286655 [debug] [MainThread]: Command end result
[0m19:32:53.301671 [info ] [MainThread]: 
[0m19:32:53.303656 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:32:53.305661 [info ] [MainThread]: 
[0m19:32:53.306655 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 104, in main
    File "_udf_code.py", line 16, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 911, in __getattr__
      raise AttributeError(
  AttributeError: DataFrame object has no attribute iloc
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:32:53.309656 [info ] [MainThread]: 
[0m19:32:53.310655 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:32:53.312655 [debug] [MainThread]: Command `dbt run` failed at 19:32:53.311654 after 5.85 seconds
[0m19:32:53.312655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC4F4AB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC4F4BB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BC4F64990>]}
[0m19:32:53.313654 [debug] [MainThread]: Flushing usage events
[0m19:36:04.279045 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B72325BFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B72325B1D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B723867A90>]}


============================== 19:36:04.283076 | 2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7 ==============================
[0m19:36:04.283076 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:36:04.284044 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:36:05.346817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B723A4BF10>]}
[0m19:36:05.365814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B723CC1C50>]}
[0m19:36:05.366815 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:36:05.379813 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:36:05.480817 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:36:05.481815 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:36:05.540786 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B72C8BEBD0>]}
[0m19:36:05.554785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B72C939750>]}
[0m19:36:05.555788 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:36:05.557819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B723A23050>]}
[0m19:36:05.558816 [info ] [MainThread]: 
[0m19:36:05.560787 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:36:05.562817 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:36:05.580829 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:36:05.581786 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:36:05.581786 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:36:06.654979 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:36:06.660982 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:36:06.739234 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:36:06.750236 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:36:06.751235 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:36:06.752236 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:36:07.566495 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:36:07.569493 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:36:07.645584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B72B418DD0>]}
[0m19:36:07.646554 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:36:07.647561 [info ] [MainThread]: 
[0m19:36:07.657582 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:36:07.657582 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:36:07.659554 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:36:07.661553 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:36:07.699586 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:36:07.702588 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:36:07.662556 => 19:36:07.701570
[0m19:36:07.702588 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:36:07.744582 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:36:07.747553 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:36:07.748553 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F
import pandas as pd  

def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    result=info.iloc[1,1]

    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:36:07.749554 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:36:09.394605 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074ee-0001-0d24-0000-000299e6ec2d
[0m19:36:09.395572 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 10, in <module>
ModuleNotFoundError: No module named 'pandas'
 in function DESCRIBE__DBT_SP with handler main
[0m19:36:09.397567 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:36:07.703566 => 19:36:09.396568
[0m19:36:09.398569 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:36:09.486838 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 10, in <module>
  ModuleNotFoundError: No module named 'pandas'
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:36:09.487840 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2afaf919-c8aa-4fd6-81ff-b0f02ac0fbb7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B72C775210>]}
[0m19:36:09.489840 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 1.83s]
[0m19:36:09.491839 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:36:09.494837 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:36:09.495840 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:36:09.496839 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:36:09.497838 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:36:09.498843 [info ] [MainThread]: 
[0m19:36:09.499838 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.94 seconds (3.94s).
[0m19:36:09.501838 [debug] [MainThread]: Command end result
[0m19:36:09.515839 [info ] [MainThread]: 
[0m19:36:09.517837 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:36:09.518838 [info ] [MainThread]: 
[0m19:36:09.519839 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 10, in <module>
  ModuleNotFoundError: No module named 'pandas'
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:36:09.522842 [info ] [MainThread]: 
[0m19:36:09.525844 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:36:09.527841 [debug] [MainThread]: Command `dbt run` failed at 19:36:09.527841 after 5.28 seconds
[0m19:36:09.528844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B723537B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B723537510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B72354AC90>]}
[0m19:36:09.529839 [debug] [MainThread]: Flushing usage events
[0m19:38:55.311081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6B51D2250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6B4D9A690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6B4DCF210>]}


============================== 19:38:55.316057 | a3fbb2a0-29f9-4057-a74c-c8fc345576ee ==============================
[0m19:38:55.316057 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:38:55.318052 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:38:56.486655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a3fbb2a0-29f9-4057-a74c-c8fc345576ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6BD5EF150>]}
[0m19:38:56.538654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a3fbb2a0-29f9-4057-a74c-c8fc345576ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6BCA27A10>]}
[0m19:38:56.541655 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:38:56.557656 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:38:56.670214 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:38:56.671215 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:38:56.734215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a3fbb2a0-29f9-4057-a74c-c8fc345576ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6BD0E7C50>]}
[0m19:38:56.751215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a3fbb2a0-29f9-4057-a74c-c8fc345576ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6BE01EB50>]}
[0m19:38:56.752216 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:38:56.753214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a3fbb2a0-29f9-4057-a74c-c8fc345576ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6B4D02FD0>]}
[0m19:38:56.755215 [info ] [MainThread]: 
[0m19:38:56.757216 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:38:56.759214 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:38:56.776215 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:38:56.777215 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:38:56.778215 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:39:00.116602 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.0 seconds
[0m19:39:00.119626 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:39:00.206118 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:39:00.221118 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:39:00.222118 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:39:00.222118 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:39:06.162270 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 6.0 seconds
[0m19:39:06.171217 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:40:12.821870 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:40:12.822869 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:40:12.823870 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:40:12.824871 [info ] [MainThread]: 
[0m19:40:12.826870 [info ] [MainThread]: Finished running  in 0 hours 1 minutes and 16.07 seconds (76.07s).
[0m19:40:12.828887 [error] [MainThread]: Encountered an error:

[0m19:40:12.838344 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 87, in wrapper
    result, success = func(*args, **kwargs)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 72, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 143, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 172, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 219, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\requires.py", line 259, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\cli\main.py", line 595, in run
    results = task.run()
              ^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 469, in run
    result = self.execute_with_hooks(selected_uids)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 429, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\run.py", line 447, in before_run
    self.populate_adapter_cache(adapter, required_schemas)
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\task\runnable.py", line 407, in populate_adapter_cache
    adapter.set_relations_cache(self.manifest)
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 473, in set_relations_cache
    self._relations_cache_for_schemas(manifest, required_schemas)
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\site-packages\dbt\adapters\base\impl.py", line 447, in _relations_cache_for_schemas
    for future in as_completed(futures):
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py", line 243, in as_completed
    waiter.event.wait(wait_timeout)
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\threading.py", line 622, in wait
    signaled = self._cond.wait(timeout)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\yashm\AppData\Local\Programs\Python\Python311\Lib\threading.py", line 320, in wait
    waiter.acquire()
KeyboardInterrupt

[0m19:40:12.849343 [debug] [MainThread]: Command `dbt run` failed at 19:40:12.848342 after 77.57 seconds
[0m19:40:12.849343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6B4D00A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6B4CF3DD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6B48967D0>]}
[0m19:40:12.850343 [debug] [MainThread]: Flushing usage events
[0m19:40:28.115650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6438AA710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C640C93A10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C643BAFA50>]}


============================== 19:40:28.119650 | e0b019d6-1289-49ba-9d07-657c7fe268ed ==============================
[0m19:40:28.119650 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:40:28.120652 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:40:29.193145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e0b019d6-1289-49ba-9d07-657c7fe268ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64409A3D0>]}
[0m19:40:29.212177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e0b019d6-1289-49ba-9d07-657c7fe268ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64389CC50>]}
[0m19:40:29.214148 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:40:29.227149 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:40:29.326148 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:40:29.327149 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:40:29.384149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e0b019d6-1289-49ba-9d07-657c7fe268ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64CEBC190>]}
[0m19:40:29.399151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e0b019d6-1289-49ba-9d07-657c7fe268ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64CF7B3D0>]}
[0m19:40:29.400185 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:40:29.401149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0b019d6-1289-49ba-9d07-657c7fe268ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64CECAB50>]}
[0m19:40:29.403150 [info ] [MainThread]: 
[0m19:40:29.403711 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:40:29.405724 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:40:29.426723 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:40:29.427755 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:40:29.428759 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:40:30.448491 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:40:30.456489 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:40:30.541346 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:40:30.553342 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:40:30.554343 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:40:30.555342 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:40:31.217996 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:40:31.222993 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:40:31.315635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0b019d6-1289-49ba-9d07-657c7fe268ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64D3AA810>]}
[0m19:40:31.317636 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:40:31.319635 [info ] [MainThread]: 
[0m19:40:31.333643 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:40:31.335637 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:40:31.339638 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:40:31.340641 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:40:31.385634 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:40:31.387666 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:40:31.341639 => 19:40:31.387666
[0m19:40:31.388669 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:40:31.434665 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:40:31.437635 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:40:31.438667 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    info.show()

    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:40:31.439664 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:40:34.444917 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074f2-0001-0d24-0000-000299e6ec3d
[0m19:40:34.445921 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 105, in main
  File "_udf_code.py", line 21, in model
NameError: name 'result' is not defined
 in function DESCRIBE__DBT_SP with handler main
[0m19:40:34.446927 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:40:31.389636 => 19:40:34.445921
[0m19:40:34.447918 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:40:34.515919 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 105, in main
    File "_udf_code.py", line 21, in model
  NameError: name 'result' is not defined
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:40:34.516919 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0b019d6-1289-49ba-9d07-657c7fe268ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64CF58810>]}
[0m19:40:34.517919 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 3.18s]
[0m19:40:34.519919 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:40:34.522919 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:40:34.523919 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:40:34.524922 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:40:34.525921 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:40:34.525921 [info ] [MainThread]: 
[0m19:40:34.527920 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.12 seconds (5.12s).
[0m19:40:34.528920 [debug] [MainThread]: Command end result
[0m19:40:34.544921 [info ] [MainThread]: 
[0m19:40:34.545921 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:40:34.549921 [info ] [MainThread]: 
[0m19:40:34.551921 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 105, in main
    File "_udf_code.py", line 21, in model
  NameError: name 'result' is not defined
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:40:34.555921 [info ] [MainThread]: 
[0m19:40:34.557923 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:40:34.560923 [debug] [MainThread]: Command `dbt run` failed at 19:40:34.560923 after 6.48 seconds
[0m19:40:34.561950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C6438AC0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C643946D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C64389CC90>]}
[0m19:40:34.563921 [debug] [MainThread]: Flushing usage events
[0m19:40:52.424915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD681142D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD68117D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD683F1650>]}


============================== 19:40:52.428921 | c6809bea-3e6f-4128-aeec-c73d58ce1610 ==============================
[0m19:40:52.428921 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:40:52.430890 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:40:53.495782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c6809bea-3e6f-4128-aeec-c73d58ce1610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD716D4090>]}
[0m19:40:53.514797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c6809bea-3e6f-4128-aeec-c73d58ce1610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD716D4650>]}
[0m19:40:53.516766 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:40:53.529796 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:40:53.644346 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:40:53.645378 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:40:53.702372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c6809bea-3e6f-4128-aeec-c73d58ce1610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD7171D3D0>]}
[0m19:40:53.718350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c6809bea-3e6f-4128-aeec-c73d58ce1610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD7179DE10>]}
[0m19:40:53.719350 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:40:53.721350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6809bea-3e6f-4128-aeec-c73d58ce1610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD68116F90>]}
[0m19:40:53.722380 [info ] [MainThread]: 
[0m19:40:53.724348 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:40:53.726347 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:40:53.742378 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:40:53.744350 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:40:53.746353 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:40:54.742141 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:40:54.746109 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:40:54.809929 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:40:54.821928 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:40:54.822930 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:40:54.823930 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:40:55.658062 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:40:55.662084 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:40:55.738708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6809bea-3e6f-4128-aeec-c73d58ce1610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD71CE0BD0>]}
[0m19:40:55.740708 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:40:55.741672 [info ] [MainThread]: 
[0m19:40:55.751258 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:40:55.752259 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:40:55.753259 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:40:55.754262 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:40:55.794278 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:40:55.797260 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:40:55.755259 => 19:40:55.797260
[0m19:40:55.798260 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:40:55.841260 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:40:55.845262 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:40:55.846290 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe()

    info.show()

    

    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:40:55.847290 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:40:59.841137 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m19:40:59.884161 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:40:55.799260 => 19:40:59.884161
[0m19:40:59.885163 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:40:59.954432 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6809bea-3e6f-4128-aeec-c73d58ce1610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD71716050>]}
[0m19:40:59.955431 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 4.20s]
[0m19:40:59.957400 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:40:59.961422 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:40:59.961422 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:40:59.962421 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:40:59.963424 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:40:59.964423 [info ] [MainThread]: 
[0m19:40:59.966399 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.24 seconds (6.24s).
[0m19:40:59.968400 [debug] [MainThread]: Command end result
[0m19:40:59.985402 [info ] [MainThread]: 
[0m19:40:59.986398 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:40:59.988397 [info ] [MainThread]: 
[0m19:40:59.989409 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:40:59.991420 [debug] [MainThread]: Command `dbt run` succeeded at 19:40:59.991420 after 7.59 seconds
[0m19:40:59.993402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD683D3F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD688BFB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FD6888F390>]}
[0m19:40:59.994411 [debug] [MainThread]: Flushing usage events
[0m19:43:55.673572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B9C2C2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B9C2BED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B9F18D10>]}


============================== 19:43:55.677570 | e8fa680e-0f3d-465c-84e1-dad6be6a83d2 ==============================
[0m19:43:55.677570 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:43:55.678572 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:43:56.757072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e8fa680e-0f3d-465c-84e1-dad6be6a83d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8C31E0110>]}
[0m19:43:56.776107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e8fa680e-0f3d-465c-84e1-dad6be6a83d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B9F10110>]}
[0m19:43:56.777103 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:43:56.790106 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:43:56.898074 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:43:56.899075 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:43:56.960074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e8fa680e-0f3d-465c-84e1-dad6be6a83d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8C32660D0>]}
[0m19:43:56.976075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e8fa680e-0f3d-465c-84e1-dad6be6a83d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8C32ACDD0>]}
[0m19:43:56.977076 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:43:56.978084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e8fa680e-0f3d-465c-84e1-dad6be6a83d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B597EB10>]}
[0m19:43:56.980075 [info ] [MainThread]: 
[0m19:43:56.982076 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:43:56.983076 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:43:57.001076 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:43:57.002109 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:43:57.002109 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:43:58.076062 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:43:58.079064 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:43:58.147063 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:43:58.160065 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:43:58.161064 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:43:58.162064 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:43:58.823896 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:43:58.829916 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:43:58.930981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e8fa680e-0f3d-465c-84e1-dad6be6a83d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8C2B772D0>]}
[0m19:43:58.932019 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:43:58.933983 [info ] [MainThread]: 
[0m19:43:58.942511 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:43:58.943510 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:43:58.945514 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:43:58.946538 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:43:58.986024 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:43:58.990024 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:43:58.947537 => 19:43:58.989025
[0m19:43:58.991025 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:43:59.035057 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:43:59.038056 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:43:59.039026 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    info=dbt.ref("src_emp").describe().collect()

    result=info[1][1]

    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:43:59.040028 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:44:02.187629 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b074f5-0001-0d24-0000-000299e6ec81
[0m19:44:02.187629 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 106, in main
  File "_udf_code.py", line 101, in materialize
AttributeError: 'float' object has no attribute 'write'
 in function DESCRIBE__DBT_SP with handler main
[0m19:44:02.189601 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:43:58.992024 => 19:44:02.188597
[0m19:44:02.190610 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:44:02.270700 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 101, in materialize
  AttributeError: 'float' object has no attribute 'write'
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:44:02.272668 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e8fa680e-0f3d-465c-84e1-dad6be6a83d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8C32EDE50>]}
[0m19:44:02.273668 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 3.33s]
[0m19:44:02.275703 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:44:02.279669 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:44:02.280701 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:44:02.281669 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:44:02.281669 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:44:02.282669 [info ] [MainThread]: 
[0m19:44:02.283667 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.30 seconds (5.30s).
[0m19:44:02.285669 [debug] [MainThread]: Command end result
[0m19:44:02.301682 [info ] [MainThread]: 
[0m19:44:02.302666 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:44:02.303667 [info ] [MainThread]: 
[0m19:44:02.304568 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 106, in main
    File "_udf_code.py", line 101, in materialize
  AttributeError: 'float' object has no attribute 'write'
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m19:44:02.307611 [info ] [MainThread]: 
[0m19:44:02.308579 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:44:02.310579 [debug] [MainThread]: Command `dbt run` failed at 19:44:02.310579 after 6.67 seconds
[0m19:44:02.311579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B9FFB610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B9F32990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8B9C4CCD0>]}
[0m19:44:02.312581 [debug] [MainThread]: Flushing usage events
[0m19:45:37.946445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A85C68AE50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A85CD929D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A85CD92390>]}


============================== 19:45:37.951442 | a6c35045-39db-4497-8b7c-96631ba12917 ==============================
[0m19:45:37.951442 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:45:37.953410 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select describe', 'send_anonymous_usage_stats': 'True'}
[0m19:45:39.028904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a6c35045-39db-4497-8b7c-96631ba12917', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A85C696190>]}
[0m19:45:39.048937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a6c35045-39db-4497-8b7c-96631ba12917', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A8648D0DD0>]}
[0m19:45:39.049911 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:45:39.062938 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:45:39.168907 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:45:39.170918 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:45:39.199951 [error] [MainThread]: Encountered an error:
Parsing Error in model describe (models\example\describe.py)
  In current version, model function should return only one dataframe object
[0m19:45:39.202167 [debug] [MainThread]: Command `dbt run` failed at 19:45:39.202167 after 1.28 seconds
[0m19:45:39.203165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A85C966410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A85C8F1890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A85CDAFB50>]}
[0m19:45:39.203165 [debug] [MainThread]: Flushing usage events
[0m19:46:43.961966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2D46B590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2D6A7FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2D6E4E90>]}


============================== 19:46:43.965995 | 083c938f-ad8a-404e-a119-e74ad667f271 ==============================
[0m19:46:43.965995 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:46:43.966966 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:46:45.041348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '083c938f-ad8a-404e-a119-e74ad667f271', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2D43AF50>]}
[0m19:46:45.062335 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '083c938f-ad8a-404e-a119-e74ad667f271', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2DB9DB50>]}
[0m19:46:45.064303 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:46:45.078333 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:46:45.182303 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:46:45.183336 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:46:45.215306 [error] [MainThread]: Encountered an error:
Parsing Error in model describe (models\example\describe.py)
  In current version, model function should return only one dataframe object
[0m19:46:45.217304 [debug] [MainThread]: Command `dbt run` failed at 19:46:45.217304 after 1.28 seconds
[0m19:46:45.218304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2D3EF750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2D46B490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029B2D46A010>]}
[0m19:46:45.218304 [debug] [MainThread]: Flushing usage events
[0m19:48:23.162981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B05EC2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B068B3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B09683D0>]}


============================== 19:48:23.166981 | ba3d243e-9ed1-457e-b62c-b3bbbda53fa8 ==============================
[0m19:48:23.166981 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:48:23.168983 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:48:24.253084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ba3d243e-9ed1-457e-b62c-b3bbbda53fa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B9C01A50>]}
[0m19:48:24.272078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ba3d243e-9ed1-457e-b62c-b3bbbda53fa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B729EAD0>]}
[0m19:48:24.274079 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:48:24.286079 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:48:24.391111 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:48:24.392081 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:48:24.423081 [error] [MainThread]: Encountered an error:
Parsing Error in model describe (models\example\describe.py)
  In current version, model function should return only one dataframe object
[0m19:48:24.425082 [debug] [MainThread]: Command `dbt run` failed at 19:48:24.425082 after 1.29 seconds
[0m19:48:24.426082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B067FF50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B10517D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222B08E0710>]}
[0m19:48:24.426082 [debug] [MainThread]: Flushing usage events
[0m19:48:50.852450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B710EBA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B71323ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B712EAF90>]}


============================== 19:48:50.856481 | 9f3153dc-e368-49ba-bd17-d4d4f90b69c5 ==============================
[0m19:48:50.856481 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:48:50.858451 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:48:51.921308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f3153dc-e368-49ba-bd17-d4d4f90b69c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7A60F490>]}
[0m19:48:51.940310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f3153dc-e368-49ba-bd17-d4d4f90b69c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7934BE10>]}
[0m19:48:51.942312 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:48:51.955311 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:48:52.057344 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:48:52.058344 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:48:52.119312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9f3153dc-e368-49ba-bd17-d4d4f90b69c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7A641E90>]}
[0m19:48:52.136319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9f3153dc-e368-49ba-bd17-d4d4f90b69c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7A6DC790>]}
[0m19:48:52.137314 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:48:52.139315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f3153dc-e368-49ba-bd17-d4d4f90b69c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B71817610>]}
[0m19:48:52.140314 [info ] [MainThread]: 
[0m19:48:52.142341 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:48:52.145315 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:48:52.164315 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:48:52.165314 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:48:52.166315 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:48:53.267929 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:48:53.271925 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:48:53.351211 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:48:53.364236 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:48:53.365234 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:48:53.365234 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:48:54.157089 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:48:54.164088 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:48:54.238521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f3153dc-e368-49ba-bd17-d4d4f90b69c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7A7D8E10>]}
[0m19:48:54.240573 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:48:54.241536 [info ] [MainThread]: 
[0m19:48:54.252806 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:48:54.254810 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:48:54.256809 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:48:54.258808 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:48:54.298836 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:48:54.301813 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:48:54.258808 => 19:48:54.301813
[0m19:48:54.303822 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:48:54.351839 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:48:54.355805 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:48:54.356808 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

   
    return source_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:48:54.357806 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:48:57.602820 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m19:48:57.646842 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:48:54.304806 => 19:48:57.646842
[0m19:48:57.647840 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:48:57.724164 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f3153dc-e368-49ba-bd17-d4d4f90b69c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7A600990>]}
[0m19:48:57.726132 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 3.47s]
[0m19:48:57.728132 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:48:57.732165 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:48:57.733132 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:48:57.734132 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:48:57.735134 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:48:57.736132 [info ] [MainThread]: 
[0m19:48:57.737131 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.59 seconds (5.59s).
[0m19:48:57.740134 [debug] [MainThread]: Command end result
[0m19:48:57.756132 [info ] [MainThread]: 
[0m19:48:57.758133 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:48:57.759133 [info ] [MainThread]: 
[0m19:48:57.761165 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:48:57.763138 [debug] [MainThread]: Command `dbt run` succeeded at 19:48:57.763138 after 6.94 seconds
[0m19:48:57.764165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7104BB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B7104B490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B713C9890>]}
[0m19:48:57.765160 [debug] [MainThread]: Flushing usage events
[0m19:52:56.164450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A00192910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A001B1550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A0022AB10>]}


============================== 19:52:56.169451 | 676c2e8d-6eb2-41d5-8ded-83513ddf857c ==============================
[0m19:52:56.169451 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:52:56.170450 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:52:57.266228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '676c2e8d-6eb2-41d5-8ded-83513ddf857c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A09300790>]}
[0m19:52:57.286194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '676c2e8d-6eb2-41d5-8ded-83513ddf857c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A08849890>]}
[0m19:52:57.287228 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:52:57.300209 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:52:57.403212 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:52:57.404231 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:52:57.463228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '676c2e8d-6eb2-41d5-8ded-83513ddf857c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A0933A650>]}
[0m19:52:57.479228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '676c2e8d-6eb2-41d5-8ded-83513ddf857c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A093002D0>]}
[0m19:52:57.480197 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:52:57.482201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '676c2e8d-6eb2-41d5-8ded-83513ddf857c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A0934EA10>]}
[0m19:52:57.483199 [info ] [MainThread]: 
[0m19:52:57.485200 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:52:57.488199 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:52:57.508246 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:52:57.508246 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:52:57.509200 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:52:58.782518 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:52:58.786478 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:52:58.868471 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:52:58.889463 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:52:58.890460 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:52:58.890460 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:52:59.679918 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:52:59.687869 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:52:59.769407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '676c2e8d-6eb2-41d5-8ded-83513ddf857c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A07F34210>]}
[0m19:52:59.771406 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:52:59.772375 [info ] [MainThread]: 
[0m19:52:59.781417 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:52:59.782443 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:52:59.784418 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:52:59.785418 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:52:59.827418 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:52:59.830450 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:52:59.786419 => 19:52:59.829417
[0m19:52:59.830450 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:52:59.877419 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:52:59.881450 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:52:59.882447 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

    if result > 2:
        info.withColumnRenamed('summary','summary1')
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:52:59.883417 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:53:04.370571 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m19:53:04.399571 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:52:59.831417 => 19:53:04.399571
[0m19:53:04.400570 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:53:04.468343 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '676c2e8d-6eb2-41d5-8ded-83513ddf857c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A093AD310>]}
[0m19:53:04.470315 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 4.68s]
[0m19:53:04.471315 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:53:04.474313 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:53:04.475314 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:53:04.476328 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:53:04.476328 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:53:04.477314 [info ] [MainThread]: 
[0m19:53:04.478313 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.99 seconds (6.99s).
[0m19:53:04.480315 [debug] [MainThread]: Command end result
[0m19:53:04.497708 [info ] [MainThread]: 
[0m19:53:04.498707 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:53:04.500710 [info ] [MainThread]: 
[0m19:53:04.501708 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:53:04.503742 [debug] [MainThread]: Command `dbt run` succeeded at 19:53:04.502708 after 8.37 seconds
[0m19:53:04.504742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A7FDBC0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A0063F0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A07F28190>]}
[0m19:53:04.505710 [debug] [MainThread]: Flushing usage events
[0m19:54:10.882193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E540AFD90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E539055D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E53B972D0>]}


============================== 19:54:10.886194 | e0d058ad-6b27-45b2-94ed-d46757a44cb6 ==============================
[0m19:54:10.886194 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:54:10.888194 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select describe', 'send_anonymous_usage_stats': 'True'}
[0m19:54:11.959207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e0d058ad-6b27-45b2-94ed-d46757a44cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5CEBFBD0>]}
[0m19:54:11.978209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e0d058ad-6b27-45b2-94ed-d46757a44cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5C1D7D90>]}
[0m19:54:11.980209 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:54:11.991781 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:54:12.097814 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:54:12.098814 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:54:12.156817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e0d058ad-6b27-45b2-94ed-d46757a44cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5BAC22D0>]}
[0m19:54:12.171826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e0d058ad-6b27-45b2-94ed-d46757a44cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5CF8D990>]}
[0m19:54:12.172783 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:54:12.173794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0d058ad-6b27-45b2-94ed-d46757a44cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5A45FE50>]}
[0m19:54:12.175816 [info ] [MainThread]: 
[0m19:54:12.176815 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:54:12.178816 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:54:12.195822 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:54:12.196822 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:54:12.197785 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:54:13.290735 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:54:13.294739 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:54:13.374468 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:54:13.392499 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:54:13.393470 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:54:13.394513 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:54:14.064344 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:54:14.071343 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:54:14.142620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0d058ad-6b27-45b2-94ed-d46757a44cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5D3AA810>]}
[0m19:54:14.143621 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:54:14.144621 [info ] [MainThread]: 
[0m19:54:14.152735 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:54:14.153734 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:54:14.155734 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:54:14.156735 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:54:14.198736 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:54:14.200781 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:54:14.156735 => 19:54:14.199782
[0m19:54:14.200781 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:54:14.246284 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:54:14.250312 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:54:14.251308 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

    if result > 2:
        info.withColumnRenamed('summary','summary1')
    else:
        info.withColumnRenamed('summary','summary2')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:54:14.252325 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:54:18.139381 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m19:54:18.169407 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:54:14.201774 => 19:54:18.169407
[0m19:54:18.170408 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:54:18.253406 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d058ad-6b27-45b2-94ed-d46757a44cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5CEF3D10>]}
[0m19:54:18.254371 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 4.10s]
[0m19:54:18.257372 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:54:18.261406 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:54:18.262407 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:54:18.263406 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:54:18.264403 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:54:18.265405 [info ] [MainThread]: 
[0m19:54:18.267370 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.09 seconds (6.09s).
[0m19:54:18.270373 [debug] [MainThread]: Command end result
[0m19:54:18.287369 [info ] [MainThread]: 
[0m19:54:18.290373 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:54:18.292371 [info ] [MainThread]: 
[0m19:54:18.293370 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:54:18.295372 [debug] [MainThread]: Command `dbt run` succeeded at 19:54:18.294368 after 7.44 seconds
[0m19:54:18.296371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E5407F790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E54086A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E54086B90>]}
[0m19:54:18.297382 [debug] [MainThread]: Flushing usage events
[0m19:55:36.086831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182901AFC50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182900A3E10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001829010EC90>]}


============================== 19:55:36.091830 | 87b37380-9e86-446b-ba08-467162eeaeb8 ==============================
[0m19:55:36.091830 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:55:36.093804 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select describe', 'send_anonymous_usage_stats': 'True'}
[0m19:55:37.160948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '87b37380-9e86-446b-ba08-467162eeaeb8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182908BE5D0>]}
[0m19:55:37.179949 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '87b37380-9e86-446b-ba08-467162eeaeb8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182980D17D0>]}
[0m19:55:37.180949 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:55:37.195952 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:55:37.298952 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:55:37.299952 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:55:37.357984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '87b37380-9e86-446b-ba08-467162eeaeb8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182996FD050>]}
[0m19:55:37.372952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '87b37380-9e86-446b-ba08-467162eeaeb8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182997BDBD0>]}
[0m19:55:37.373953 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:55:37.374955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87b37380-9e86-446b-ba08-467162eeaeb8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001828BE7EB50>]}
[0m19:55:37.376984 [info ] [MainThread]: 
[0m19:55:37.377953 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:55:37.379954 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:55:37.396985 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:55:37.397954 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:55:37.398976 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:55:38.471551 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:55:38.475551 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:55:38.567699 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:55:38.582695 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:55:38.583695 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:55:38.584696 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:55:39.439253 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:55:39.445253 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:55:39.558860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87b37380-9e86-446b-ba08-467162eeaeb8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182908BFCD0>]}
[0m19:55:39.560892 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:55:39.561858 [info ] [MainThread]: 
[0m19:55:39.572476 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:55:39.573468 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:55:39.575452 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:55:39.576450 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:55:39.618447 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:55:39.620480 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:55:39.577448 => 19:55:39.620480
[0m19:55:39.621473 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:55:39.665451 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:55:39.669449 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:55:39.670481 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

    if result > 2:
        info.withColumnRenamed('SUMMARY','summary1')
    else:
        info.withColumnRenamed('SUMMARY','summary2')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:55:39.671480 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:55:43.397431 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m19:55:43.424430 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:55:39.622448 => 19:55:43.423395
[0m19:55:43.425421 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:55:43.492080 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '87b37380-9e86-446b-ba08-467162eeaeb8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182998ADBD0>]}
[0m19:55:43.494075 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 3.92s]
[0m19:55:43.496071 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:55:43.499038 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:55:43.500037 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:55:43.501036 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:55:43.501036 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:55:43.502039 [info ] [MainThread]: 
[0m19:55:43.503427 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.12 seconds (6.12s).
[0m19:55:43.505441 [debug] [MainThread]: Command end result
[0m19:55:43.520438 [info ] [MainThread]: 
[0m19:55:43.521441 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:55:43.522443 [info ] [MainThread]: 
[0m19:55:43.524440 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:55:43.526443 [debug] [MainThread]: Command `dbt run` succeeded at 19:55:43.526443 after 7.47 seconds
[0m19:55:43.527455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182900EAAD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182903F32D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182903F1910>]}
[0m19:55:43.528440 [debug] [MainThread]: Flushing usage events
[0m19:57:06.597388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8CE9825D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8CE9F6CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8CE697210>]}


============================== 19:57:06.602416 | febccd0a-1988-403d-9293-b2bfd7955f25 ==============================
[0m19:57:06.602416 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:57:06.603158 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:57:07.697629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'febccd0a-1988-403d-9293-b2bfd7955f25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8D7C1E9D0>]}
[0m19:57:07.718652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'febccd0a-1988-403d-9293-b2bfd7955f25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8D6E389D0>]}
[0m19:57:07.720628 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:57:07.734627 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:57:07.840629 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:57:07.841659 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:57:07.901662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'febccd0a-1988-403d-9293-b2bfd7955f25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8D7C94110>]}
[0m19:57:07.917641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'febccd0a-1988-403d-9293-b2bfd7955f25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8D7D5F750>]}
[0m19:57:07.919628 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:57:07.920630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'febccd0a-1988-403d-9293-b2bfd7955f25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8D668A290>]}
[0m19:57:07.922662 [info ] [MainThread]: 
[0m19:57:07.924663 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:57:07.926661 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:57:07.942662 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:57:07.943662 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:57:07.944660 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:09.051833 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:57:09.054833 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:57:09.134151 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:57:09.148185 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:57:09.150153 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:57:09.150153 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:57:09.820544 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:57:09.824508 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:57:09.897941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'febccd0a-1988-403d-9293-b2bfd7955f25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8D668A290>]}
[0m19:57:09.899854 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:57:09.901858 [info ] [MainThread]: 
[0m19:57:09.910863 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:57:09.912857 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:57:09.914859 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:57:09.915891 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:57:09.955889 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:57:09.960860 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:57:09.916870 => 19:57:09.959857
[0m19:57:09.961858 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:57:10.010954 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:57:10.014940 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:57:10.015942 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

    if result == 2:
        info.withColumnRenamed('SUMMARY','summary1')
    else:
        info.withColumnRenamed('SUMMARY','summary2')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:57:10.016940 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:57:13.882527 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m19:57:13.920528 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:57:09.962891 => 19:57:13.920528
[0m19:57:13.921526 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:57:14.003530 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'febccd0a-1988-403d-9293-b2bfd7955f25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8D7D7C690>]}
[0m19:57:14.007537 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 4.09s]
[0m19:57:14.014533 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:57:14.019533 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:57:14.020531 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:57:14.021530 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:57:14.021530 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:57:14.022528 [info ] [MainThread]: 
[0m19:57:14.027532 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.10 seconds (6.10s).
[0m19:57:14.029531 [debug] [MainThread]: Command end result
[0m19:57:14.053531 [info ] [MainThread]: 
[0m19:57:14.054539 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:57:14.056532 [info ] [MainThread]: 
[0m19:57:14.059531 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:57:14.061533 [debug] [MainThread]: Command `dbt run` succeeded at 19:57:14.061533 after 7.49 seconds
[0m19:57:14.062531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8CE69E2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8C7A53450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8CEE2EE10>]}
[0m19:57:14.063530 [debug] [MainThread]: Flushing usage events
[0m19:58:12.259234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234D80EAC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234D80EB750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234D7D10A50>]}


============================== 19:58:12.263232 | 8971aee3-2355-4731-aa52-0e815f8a1148 ==============================
[0m19:58:12.263232 [info ] [MainThread]: Running with dbt=1.6.6
[0m19:58:12.265218 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:58:13.331216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8971aee3-2355-4731-aa52-0e815f8a1148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234D881EDD0>]}
[0m19:58:13.351791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8971aee3-2355-4731-aa52-0e815f8a1148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234E08E16D0>]}
[0m19:58:13.352795 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m19:58:13.364822 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m19:58:13.469510 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:58:13.470511 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m19:58:13.531512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8971aee3-2355-4731-aa52-0e815f8a1148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234E169DA50>]}
[0m19:58:13.547513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8971aee3-2355-4731-aa52-0e815f8a1148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234E16D12D0>]}
[0m19:58:13.548513 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m19:58:13.549543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8971aee3-2355-4731-aa52-0e815f8a1148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234E0E1FAD0>]}
[0m19:58:13.551512 [info ] [MainThread]: 
[0m19:58:13.553834 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:58:13.554803 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m19:58:13.572833 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m19:58:13.572833 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m19:58:13.573813 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:58:14.631676 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m19:58:14.634676 [debug] [ThreadPool]: On list_demo_database: Close
[0m19:58:14.694419 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m19:58:14.706416 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m19:58:14.708451 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m19:58:14.708451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:58:15.366241 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m19:58:15.373196 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m19:58:15.466887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8971aee3-2355-4731-aa52-0e815f8a1148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234E1ADC290>]}
[0m19:58:15.468922 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m19:58:15.470888 [info ] [MainThread]: 
[0m19:58:15.481886 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m19:58:15.482911 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m19:58:15.484886 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m19:58:15.485889 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m19:58:15.524670 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m19:58:15.527674 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 19:58:15.486885 => 19:58:15.527674
[0m19:58:15.528706 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m19:58:15.571668 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m19:58:15.575701 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m19:58:15.575701 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

    if result == 2:
        info.rename('SUMMARY','summary1')
    else:
        info.rename('SUMMARY','summary2')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m19:58:15.576670 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:58:19.226442 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m19:58:19.254460 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 19:58:15.529707 => 19:58:19.253460
[0m19:58:19.254460 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m19:58:19.308541 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8971aee3-2355-4731-aa52-0e815f8a1148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234E1B19890>]}
[0m19:58:19.309541 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 3.82s]
[0m19:58:19.311510 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m19:58:19.314541 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:58:19.315511 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m19:58:19.316510 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m19:58:19.316510 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m19:58:19.317542 [info ] [MainThread]: 
[0m19:58:19.318513 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.76 seconds (5.76s).
[0m19:58:19.320529 [debug] [MainThread]: Command end result
[0m19:58:19.336088 [info ] [MainThread]: 
[0m19:58:19.337087 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:58:19.338088 [info ] [MainThread]: 
[0m19:58:19.339085 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:58:19.342088 [debug] [MainThread]: Command `dbt run` succeeded at 19:58:19.341111 after 7.11 seconds
[0m19:58:19.343089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234D83CAA50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234D83CA990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000234D83CAF50>]}
[0m19:58:19.344088 [debug] [MainThread]: Flushing usage events
[0m20:00:27.124851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022851A7C2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228526BED10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022852A7F210>]}


============================== 20:00:27.128852 | 6df0588a-5a82-4398-8b52-78972eb2ca33 ==============================
[0m20:00:27.128852 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:00:27.129855 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select describe', 'send_anonymous_usage_stats': 'True'}
[0m20:00:28.199156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6df0588a-5a82-4398-8b52-78972eb2ca33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002285B2BF150>]}
[0m20:00:28.217124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6df0588a-5a82-4398-8b52-78972eb2ca33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022852C6DA90>]}
[0m20:00:28.219125 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:00:28.233126 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:00:28.335160 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:00:28.336159 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:00:28.395159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6df0588a-5a82-4398-8b52-78972eb2ca33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002285222C750>]}
[0m20:00:28.411127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6df0588a-5a82-4398-8b52-78972eb2ca33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002285BCEE4D0>]}
[0m20:00:28.413129 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:00:28.414133 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6df0588a-5a82-4398-8b52-78972eb2ca33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002285BC082D0>]}
[0m20:00:28.416160 [info ] [MainThread]: 
[0m20:00:28.417131 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:00:28.419160 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:00:28.438161 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:00:28.439159 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:00:28.440128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:29.498969 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:00:29.501963 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:00:29.566766 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:00:29.580762 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:00:29.582728 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:00:29.582728 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:30.227618 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:00:30.232135 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:00:30.294831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6df0588a-5a82-4398-8b52-78972eb2ca33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002285BD49090>]}
[0m20:00:30.295849 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:00:30.296818 [info ] [MainThread]: 
[0m20:00:30.305830 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:00:30.306832 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:00:30.308829 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:00:30.309832 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:00:30.350872 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:00:30.353873 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:00:30.311833 => 20:00:30.352877
[0m20:00:30.354872 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:00:30.399903 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:00:30.402872 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:00:30.403902 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

    if result == 2:
        info.rename(col('SUMMARY'),'summary1')
    else:
        info.rename(col('SUMMARY'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:00:30.404902 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:00:32.554134 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07506-0001-0d24-0000-000299e6ee49
[0m20:00:32.556136 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 26, in model
NameError: name 'col' is not defined
 in function DESCRIBE__DBT_SP with handler main
[0m20:00:32.557133 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:00:30.355871 => 20:00:32.557133
[0m20:00:32.558135 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:00:32.624550 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 26, in model
  NameError: name 'col' is not defined
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:00:32.625550 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df0588a-5a82-4398-8b52-78972eb2ca33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002285BD3CC10>]}
[0m20:00:32.626519 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 2.32s]
[0m20:00:32.628521 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:00:32.631520 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:00:32.632519 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:00:32.633520 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:00:32.634551 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:00:32.634551 [info ] [MainThread]: 
[0m20:00:32.636519 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.22 seconds (4.22s).
[0m20:00:32.638520 [debug] [MainThread]: Command end result
[0m20:00:32.655519 [info ] [MainThread]: 
[0m20:00:32.656519 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:00:32.657519 [info ] [MainThread]: 
[0m20:00:32.659519 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 26, in model
  NameError: name 'col' is not defined
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:00:32.662523 [info ] [MainThread]: 
[0m20:00:32.664521 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:00:32.665520 [debug] [MainThread]: Command `dbt run` failed at 20:00:32.665520 after 5.57 seconds
[0m20:00:32.666549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022852350B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022852E92650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022852E92E10>]}
[0m20:00:32.667520 [debug] [MainThread]: Flushing usage events
[0m20:01:25.127063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2F788AB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2F7C9E210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2F75FC350>]}


============================== 20:01:25.131063 | a984f2da-006a-467b-acdf-c9d1cc0510ff ==============================
[0m20:01:25.131063 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:01:25.133064 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:01:26.208479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a984f2da-006a-467b-acdf-c9d1cc0510ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F280BB6190>]}
[0m20:01:26.227508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a984f2da-006a-467b-acdf-c9d1cc0510ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F280BA1610>]}
[0m20:01:26.228511 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:01:26.240508 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:01:26.345479 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:01:26.346479 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:01:26.402482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a984f2da-006a-467b-acdf-c9d1cc0510ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F280B9A810>]}
[0m20:01:26.418479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a984f2da-006a-467b-acdf-c9d1cc0510ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F280C5AA10>]}
[0m20:01:26.419480 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:01:26.420479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a984f2da-006a-467b-acdf-c9d1cc0510ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2F333EB90>]}
[0m20:01:26.422480 [info ] [MainThread]: 
[0m20:01:26.424480 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:01:26.425479 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:01:26.443480 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:01:26.445488 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:01:26.447485 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:27.635486 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:01:27.637485 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:01:27.718438 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:01:27.733439 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:01:27.734438 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:01:27.734438 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:28.408243 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:01:28.415240 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:01:28.515480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a984f2da-006a-467b-acdf-c9d1cc0510ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F28108DA10>]}
[0m20:01:28.517472 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:01:28.518441 [info ] [MainThread]: 
[0m20:01:28.527831 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:01:28.528833 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:01:28.530834 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:01:28.531833 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:01:28.569872 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:01:28.571834 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:01:28.531833 => 20:01:28.571834
[0m20:01:28.572831 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:01:28.618863 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:01:28.621833 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:01:28.622863 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.ref("src_emp").describe()

    infoc=info.collect()

    result=infoc[1][1]

    if result == 2:
        info.rename(F.col('SUMMARY'),'summary1')
    else:
        info.rename(F.col('SUMMARY'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {"src_emp": "demo_database.demo_schema.src_emp"}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:01:28.623863 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:01:32.556647 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.0 seconds
[0m20:01:32.604639 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:01:28.572831 => 20:01:32.604639
[0m20:01:32.605607 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:01:32.660870 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a984f2da-006a-467b-acdf-c9d1cc0510ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F280C9FB50>]}
[0m20:01:32.661871 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 4.13s]
[0m20:01:32.662870 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:01:32.666901 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:01:32.666901 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:01:32.667902 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:01:32.668902 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:01:32.668902 [info ] [MainThread]: 
[0m20:01:32.670872 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.25 seconds (6.25s).
[0m20:01:32.671871 [debug] [MainThread]: Command end result
[0m20:01:32.687871 [info ] [MainThread]: 
[0m20:01:32.688872 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:01:32.689871 [info ] [MainThread]: 
[0m20:01:32.690903 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:01:32.693237 [debug] [MainThread]: Command `dbt run` succeeded at 20:01:32.692189 after 7.60 seconds
[0m20:01:32.695203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2F75F59D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2F78E4F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2F767AB10>]}
[0m20:01:32.696206 [debug] [MainThread]: Flushing usage events
[0m20:03:55.660105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288FE056CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288FDCDBC90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288FDD86A90>]}


============================== 20:03:55.665106 | 0518b022-7bbc-44c8-be6d-273eb726ca06 ==============================
[0m20:03:55.665106 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:03:55.667105 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:03:56.757797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0518b022-7bbc-44c8-be6d-273eb726ca06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288872E10D0>]}
[0m20:03:56.777502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0518b022-7bbc-44c8-be6d-273eb726ca06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288861FC4D0>]}
[0m20:03:56.779503 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:03:56.791503 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:03:56.894642 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:03:56.895640 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:03:56.952638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0518b022-7bbc-44c8-be6d-273eb726ca06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288FDFC4750>]}
[0m20:03:56.967641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0518b022-7bbc-44c8-be6d-273eb726ca06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288873AF690>]}
[0m20:03:56.969642 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:03:56.970659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0518b022-7bbc-44c8-be6d-273eb726ca06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028886C77090>]}
[0m20:03:56.972643 [info ] [MainThread]: 
[0m20:03:56.974641 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:03:56.976645 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:03:56.995641 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:03:56.998661 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:03:56.999642 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:03:58.022565 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:03:58.027533 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:03:58.097004 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:03:58.108016 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:03:58.109017 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:03:58.110017 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:03:58.872081 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:03:58.880120 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:03:58.953040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0518b022-7bbc-44c8-be6d-273eb726ca06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288878F0E10>]}
[0m20:03:58.954040 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:03:58.955040 [info ] [MainThread]: 
[0m20:03:58.965236 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:03:58.966236 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:03:58.968245 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:03:58.970244 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:03:59.009234 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:03:59.011269 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:03:58.971238 => 20:03:59.010270
[0m20:03:59.011269 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:03:59.058237 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:03:59.061240 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:03:59.063237 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.source("student_s", "bank_stream")

    infoc=info.collect()

    result=infoc[1][1]

    if result == 2:
        info.rename(F.col('CUSTID'),'summary1')
    else:
        info.rename(F.col('CUSTID'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:03:59.064237 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:04:00.972523 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07509-0001-0d24-0000-000299e6ef69
[0m20:04:00.974523 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 21, in model
IndexError: list index out of range
 in function DESCRIBE__DBT_SP with handler main
[0m20:04:00.975523 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:03:59.013239 => 20:04:00.975523
[0m20:04:00.976523 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:04:01.058266 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 21, in model
  IndexError: list index out of range
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:04:01.060268 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0518b022-7bbc-44c8-be6d-273eb726ca06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288873CFF10>]}
[0m20:04:01.061270 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 2.09s]
[0m20:04:01.064264 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:04:01.067232 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:04:01.068265 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:04:01.069231 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:04:01.070232 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:04:01.071231 [info ] [MainThread]: 
[0m20:04:01.072245 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.10 seconds (4.10s).
[0m20:04:01.074231 [debug] [MainThread]: Command end result
[0m20:04:01.090261 [info ] [MainThread]: 
[0m20:04:01.092231 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:04:01.093230 [info ] [MainThread]: 
[0m20:04:01.094243 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 21, in model
  IndexError: list index out of range
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:04:01.098233 [info ] [MainThread]: 
[0m20:04:01.100232 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:04:01.102234 [debug] [MainThread]: Command `dbt run` failed at 20:04:01.102234 after 5.47 seconds
[0m20:04:01.103267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288FDFE4D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288FB2F9710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000288FDCFD450>]}
[0m20:04:01.104263 [debug] [MainThread]: Flushing usage events
[0m20:04:31.842270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A63D7C42D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A63A493F90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A63CD9C810>]}


============================== 20:04:31.847270 | 9441fee2-db61-46d0-9ef2-199f30eb0b32 ==============================
[0m20:04:31.847270 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:04:31.848239 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select describe', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:04:32.908406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9441fee2-db61-46d0-9ef2-199f30eb0b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A64606F150>]}
[0m20:04:32.927409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9441fee2-db61-46d0-9ef2-199f30eb0b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A645FA80D0>]}
[0m20:04:32.929414 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:04:32.942045 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:04:33.044600 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:04:33.046601 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:04:33.105599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9441fee2-db61-46d0-9ef2-199f30eb0b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A6469CF890>]}
[0m20:04:33.121615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9441fee2-db61-46d0-9ef2-199f30eb0b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A646AB1490>]}
[0m20:04:33.122600 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:04:33.123475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9441fee2-db61-46d0-9ef2-199f30eb0b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A64571A3D0>]}
[0m20:04:33.125516 [info ] [MainThread]: 
[0m20:04:33.127489 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:04:33.129487 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:04:33.147485 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:04:33.148486 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:04:33.149502 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:04:34.145981 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:04:34.148012 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:04:34.212987 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:04:34.224995 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:04:34.225982 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:04:34.225982 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:04:35.026699 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:04:35.033700 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:04:35.106978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9441fee2-db61-46d0-9ef2-199f30eb0b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A6469CA810>]}
[0m20:04:35.107975 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:04:35.108975 [info ] [MainThread]: 
[0m20:04:35.118589 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:04:35.119587 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:04:35.121590 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:04:35.122591 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:04:35.161586 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:04:35.164588 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:04:35.123637 => 20:04:35.164588
[0m20:04:35.167588 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:04:35.210588 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:04:35.213599 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:04:35.214627 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.source("student_s", "bank_stream")

    infoc=info.collect()

    result=infoc[0][1]

    if result == 2:
        info.rename(F.col('CUSTID'),'summary1')
    else:
        info.rename(F.col('CUSTID'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:04:35.216618 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:04:36.952703 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0750a-0001-0d24-0000-000299e6ef75
[0m20:04:36.955715 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 21, in model
IndexError: list index out of range
 in function DESCRIBE__DBT_SP with handler main
[0m20:04:36.958656 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:04:35.167588 => 20:04:36.957659
[0m20:04:36.960759 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:04:37.036403 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 21, in model
  IndexError: list index out of range
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:04:37.038405 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9441fee2-db61-46d0-9ef2-199f30eb0b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A646F0FB50>]}
[0m20:04:37.039436 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 1.92s]
[0m20:04:37.041440 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:04:37.045406 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:04:37.046436 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:04:37.046436 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:04:37.047415 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:04:37.048438 [info ] [MainThread]: 
[0m20:04:37.049403 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.92 seconds (3.92s).
[0m20:04:37.051407 [debug] [MainThread]: Command end result
[0m20:04:37.073406 [info ] [MainThread]: 
[0m20:04:37.074405 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:04:37.075404 [info ] [MainThread]: 
[0m20:04:37.078431 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 21, in model
  IndexError: list index out of range
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:04:37.081420 [info ] [MainThread]: 
[0m20:04:37.082403 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:04:37.085404 [debug] [MainThread]: Command `dbt run` failed at 20:04:37.085404 after 5.27 seconds
[0m20:04:37.086402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A63D7BE950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A63D6F0710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A63D6F2C50>]}
[0m20:04:37.089403 [debug] [MainThread]: Flushing usage events
[0m20:04:55.821869 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E2A8DE90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E2641210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E2398350>]}


============================== 20:04:55.826870 | 2b46b7a6-097c-46a7-bf76-ab98e8221720 ==============================
[0m20:04:55.826870 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:04:55.827839 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select describe', 'send_anonymous_usage_stats': 'True'}
[0m20:04:56.892442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2b46b7a6-097c-46a7-bf76-ab98e8221720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E2A9B8D0>]}
[0m20:04:56.911442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2b46b7a6-097c-46a7-bf76-ab98e8221720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195EB808150>]}
[0m20:04:56.913444 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:04:56.924473 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:04:57.032476 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:04:57.033481 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:04:57.091661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2b46b7a6-097c-46a7-bf76-ab98e8221720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195EB857990>]}
[0m20:04:57.107246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2b46b7a6-097c-46a7-bf76-ab98e8221720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195EB8EE810>]}
[0m20:04:57.108245 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:04:57.109250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2b46b7a6-097c-46a7-bf76-ab98e8221720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E2A8D650>]}
[0m20:04:57.111275 [info ] [MainThread]: 
[0m20:04:57.112244 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:04:57.114278 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:04:57.131249 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:04:57.132248 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:04:57.133247 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:04:58.141484 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:04:58.143519 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:04:58.205143 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:04:58.216111 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:04:58.217114 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:04:58.218118 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:04:58.935672 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:04:58.941674 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:04:59.044079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2b46b7a6-097c-46a7-bf76-ab98e8221720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195DDFBEB10>]}
[0m20:04:59.046093 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:04:59.048080 [info ] [MainThread]: 
[0m20:04:59.056871 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:04:59.057856 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:04:59.059855 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:04:59.059855 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:04:59.101858 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:04:59.105865 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:04:59.060854 => 20:04:59.104857
[0m20:04:59.106860 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:04:59.152904 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:04:59.155855 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:04:59.156888 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.source("student_s", "bank_stream")

    # infoc=info.collect()

    result=info[0][1]

    if result == 2:
        info.rename(F.col('CUSTID'),'summary1')
    else:
        info.rename(F.col('CUSTID'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:04:59.157886 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:05:01.907284 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0750b-0001-0d23-0000-000299e6fe2d
[0m20:05:01.909321 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 23, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
    raise TypeError(
TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
 in function DESCRIBE__DBT_SP with handler main
[0m20:05:01.911293 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:04:59.107859 => 20:05:01.910322
[0m20:05:01.912281 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:05:01.983665 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:05:01.984665 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2b46b7a6-097c-46a7-bf76-ab98e8221720', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195EB8F48D0>]}
[0m20:05:01.986665 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 2.93s]
[0m20:05:01.987668 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:05:01.991669 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:05:01.992666 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:05:01.992666 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:05:01.993666 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:05:01.994667 [info ] [MainThread]: 
[0m20:05:01.995699 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.88 seconds (4.88s).
[0m20:05:01.997669 [debug] [MainThread]: Command end result
[0m20:05:02.012667 [info ] [MainThread]: 
[0m20:05:02.013678 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:05:02.015667 [info ] [MainThread]: 
[0m20:05:02.016666 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:05:02.020667 [info ] [MainThread]: 
[0m20:05:02.021669 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:05:02.023990 [debug] [MainThread]: Command `dbt run` failed at 20:05:02.022947 after 6.23 seconds
[0m20:05:02.023990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E1BEC7D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E22CB9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000195E22ED350>]}
[0m20:05:02.024959 [debug] [MainThread]: Flushing usage events
[0m20:05:49.234994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3808BAA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D380892690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D38055FB10>]}


============================== 20:05:49.238994 | 0c908f89-e049-4888-af5b-b91457b4b7af ==============================
[0m20:05:49.238994 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:05:49.239977 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:05:50.315349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c908f89-e049-4888-af5b-b91457b4b7af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D389AD1ED0>]}
[0m20:05:50.335350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c908f89-e049-4888-af5b-b91457b4b7af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D388678DD0>]}
[0m20:05:50.337352 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:05:50.353355 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:05:50.453383 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:05:50.454355 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:05:50.515383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c908f89-e049-4888-af5b-b91457b4b7af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D389BFA7D0>]}
[0m20:05:50.530353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c908f89-e049-4888-af5b-b91457b4b7af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D389B9CDD0>]}
[0m20:05:50.531354 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:05:50.532401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c908f89-e049-4888-af5b-b91457b4b7af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3FC24EB90>]}
[0m20:05:50.534387 [info ] [MainThread]: 
[0m20:05:50.536354 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:05:50.538384 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:05:50.556358 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:05:50.558355 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:05:50.559357 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:05:51.608207 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:05:51.611207 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:05:51.683694 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:05:51.697653 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:05:51.698653 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:05:51.699653 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:05:52.490908 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:05:52.494908 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:05:52.581677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c908f89-e049-4888-af5b-b91457b4b7af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D389B1D510>]}
[0m20:05:52.583705 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:05:52.584678 [info ] [MainThread]: 
[0m20:05:52.593678 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:05:52.594686 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:05:52.596677 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:05:52.597678 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:05:52.637709 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:05:52.639713 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:05:52.597678 => 20:05:52.639713
[0m20:05:52.640712 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:05:52.684710 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:05:52.688678 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:05:52.689679 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.source("student_s", "bank_stream")

    # infoc=info.collect()

    result=info[0][1]

    if result == "hello":
        info.rename(F.col('CUSTID'),'summary1')
    else:
        info.rename(F.col('CUSTID'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:05:52.690678 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:05:54.624680 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0750b-0001-0d23-0000-000299e6fe41
[0m20:05:54.625680 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 23, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
    raise TypeError(
TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
 in function DESCRIBE__DBT_SP with handler main
[0m20:05:54.626684 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:05:52.641689 => 20:05:54.625680
[0m20:05:54.627651 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:05:54.687297 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:05:54.688298 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c908f89-e049-4888-af5b-b91457b4b7af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D38A00FB50>]}
[0m20:05:54.689299 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 2.09s]
[0m20:05:54.691298 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:05:54.694298 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:05:54.695336 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:05:54.696329 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:05:54.697333 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:05:54.697333 [info ] [MainThread]: 
[0m20:05:54.699299 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.16 seconds (4.16s).
[0m20:05:54.701298 [debug] [MainThread]: Command end result
[0m20:05:54.717304 [info ] [MainThread]: 
[0m20:05:54.718300 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:05:54.720300 [info ] [MainThread]: 
[0m20:05:54.721297 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:05:54.724300 [info ] [MainThread]: 
[0m20:05:54.726299 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:05:54.729338 [debug] [MainThread]: Command `dbt run` failed at 20:05:54.728302 after 5.52 seconds
[0m20:05:54.729338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D380556AD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D38055D810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D380CE1D50>]}
[0m20:05:54.731299 [debug] [MainThread]: Flushing usage events
[0m20:06:42.524557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC56AC2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC569C610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC56AC990>]}


============================== 20:06:42.529558 | 3015bbc6-61bf-4750-888f-355a2084467c ==============================
[0m20:06:42.529558 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:06:42.530557 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select describe', 'send_anonymous_usage_stats': 'True'}
[0m20:06:43.594555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3015bbc6-61bf-4750-888f-355a2084467c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC5E9D1D0>]}
[0m20:06:43.614524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3015bbc6-61bf-4750-888f-355a2084467c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCDA080D0>]}
[0m20:06:43.615526 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:06:43.628776 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:06:43.730856 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:06:43.731855 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:06:43.787864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3015bbc6-61bf-4750-888f-355a2084467c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCED43510>]}
[0m20:06:43.802865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3015bbc6-61bf-4750-888f-355a2084467c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCEDA10D0>]}
[0m20:06:43.803866 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:06:43.805866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3015bbc6-61bf-4750-888f-355a2084467c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC145EB10>]}
[0m20:06:43.807898 [info ] [MainThread]: 
[0m20:06:43.809865 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:06:43.811895 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:06:43.829864 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:06:43.830866 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:06:43.832874 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:06:44.906547 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:06:44.908497 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:06:44.975320 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:06:44.987655 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:06:44.988655 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:06:44.989656 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:06:45.643058 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:06:45.652074 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:06:45.733670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3015bbc6-61bf-4750-888f-355a2084467c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCD6F4310>]}
[0m20:06:45.734686 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:06:45.736684 [info ] [MainThread]: 
[0m20:06:45.746918 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:06:45.747935 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:06:45.750916 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:06:45.751918 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:06:45.792943 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:06:45.794948 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:06:45.752912 => 20:06:45.794948
[0m20:06:45.795945 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:06:45.841945 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:06:45.845945 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:06:45.845945 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.source("student_s", "bank_stream")

    # infoc=info.collect()

    result=info[0][1]

    if result > 2:
        info.rename(F.col('CUSTID'),'summary1')
    else:
        info.rename(F.col('CUSTID'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:06:45.846914 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:06:47.621822 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0750c-0001-0d23-0000-000299e6fe55
[0m20:06:47.622823 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 23, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
    raise TypeError(
TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
 in function DESCRIBE__DBT_SP with handler main
[0m20:06:47.623822 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:06:45.795945 => 20:06:47.622823
[0m20:06:47.624851 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:06:47.686662 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:06:47.687632 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3015bbc6-61bf-4750-888f-355a2084467c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BCF2D0750>]}
[0m20:06:47.688632 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 1.94s]
[0m20:06:47.689632 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:06:47.692640 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:06:47.693662 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:06:47.694667 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:06:47.694667 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:06:47.695633 [info ] [MainThread]: 
[0m20:06:47.696631 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.89 seconds (3.89s).
[0m20:06:47.699634 [debug] [MainThread]: Command end result
[0m20:06:47.716637 [info ] [MainThread]: 
[0m20:06:47.718634 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:06:47.720633 [info ] [MainThread]: 
[0m20:06:47.721631 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:06:47.724632 [info ] [MainThread]: 
[0m20:06:47.725648 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:06:47.727633 [debug] [MainThread]: Command `dbt run` failed at 20:06:47.727633 after 5.23 seconds
[0m20:06:47.728635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC5987A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC59B1BD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019BC5E72A50>]}
[0m20:06:47.728635 [debug] [MainThread]: Flushing usage events
[0m20:07:42.074389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C10B2A450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C10C47B90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1087B790>]}


============================== 20:07:42.078364 | 23fccd2b-a7d9-4cee-952d-be068875135c ==============================
[0m20:07:42.078364 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:07:42.080388 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:07:43.156040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '23fccd2b-a7d9-4cee-952d-be068875135c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C18B7BF10>]}
[0m20:07:43.175070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '23fccd2b-a7d9-4cee-952d-be068875135c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C10B2B290>]}
[0m20:07:43.177071 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:07:43.190073 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:07:43.295073 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:07:43.296073 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:07:43.357076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '23fccd2b-a7d9-4cee-952d-be068875135c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C19E40D50>]}
[0m20:07:43.372045 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '23fccd2b-a7d9-4cee-952d-be068875135c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C19F0CF50>]}
[0m20:07:43.373058 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:07:43.374075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '23fccd2b-a7d9-4cee-952d-be068875135c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1915CFD0>]}
[0m20:07:43.376075 [info ] [MainThread]: 
[0m20:07:43.378060 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:07:43.380045 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:07:43.400048 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:07:43.402045 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:07:43.403078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:07:44.446172 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:07:44.451201 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:07:44.518824 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:07:44.530794 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:07:44.531792 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:07:44.531792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:07:45.321244 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:07:45.330188 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:07:45.414984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '23fccd2b-a7d9-4cee-952d-be068875135c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1A1DCB10>]}
[0m20:07:45.416984 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:07:45.418947 [info ] [MainThread]: 
[0m20:07:45.429946 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:07:45.430946 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:07:45.432946 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:07:45.433976 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:07:45.475974 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:07:45.479945 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:07:45.434943 => 20:07:45.479945
[0m20:07:45.480944 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:07:45.526974 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:07:45.530974 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:07:45.531945 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.source("student_s", "bank_stream")

    # infoc=info.collect()

    result=info[0][1]

    if result == 0:
        info.rename(F.col('CUSTID'),'summary1')
    else:
        info.rename(F.col('CUSTID'),'summary1')    
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:07:45.532944 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:07:47.366093 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0750d-0001-0d23-0000-000299e6fe65
[0m20:07:47.368059 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 23, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
    raise TypeError(
TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
 in function DESCRIBE__DBT_SP with handler main
[0m20:07:47.370055 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:07:45.480944 => 20:07:47.369093
[0m20:07:47.371096 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:07:47.437602 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:07:47.438602 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '23fccd2b-a7d9-4cee-952d-be068875135c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C1A4640D0>]}
[0m20:07:47.439603 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 2.01s]
[0m20:07:47.441603 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:07:47.444636 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:07:47.445602 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:07:47.445602 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:07:47.446604 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:07:47.446604 [info ] [MainThread]: 
[0m20:07:47.448604 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.07 seconds (4.07s).
[0m20:07:47.450606 [debug] [MainThread]: Command end result
[0m20:07:47.463607 [info ] [MainThread]: 
[0m20:07:47.465604 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:07:47.466605 [info ] [MainThread]: 
[0m20:07:47.468604 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 23, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 327, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:07:47.470603 [info ] [MainThread]: 
[0m20:07:47.472605 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:07:47.474606 [debug] [MainThread]: Command `dbt run` failed at 20:07:47.473607 after 5.43 seconds
[0m20:07:47.474606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C10879C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C10B56B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C10B57990>]}
[0m20:07:47.476609 [debug] [MainThread]: Flushing usage events
[0m20:08:52.470101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAD48F1450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAD41D3F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAD4429590>]}


============================== 20:08:52.474132 | 7a368f04-203c-4f6c-bf4b-eef2e0d6b50e ==============================
[0m20:08:52.474132 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:08:52.476104 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:08:53.544172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7a368f04-203c-4f6c-bf4b-eef2e0d6b50e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EADD678410>]}
[0m20:08:53.563174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7a368f04-203c-4f6c-bf4b-eef2e0d6b50e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAD4A7AB10>]}
[0m20:08:53.565140 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:08:53.577170 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:08:53.680143 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:08:53.681173 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:08:53.739145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7a368f04-203c-4f6c-bf4b-eef2e0d6b50e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EADD68DF10>]}
[0m20:08:53.754142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7a368f04-203c-4f6c-bf4b-eef2e0d6b50e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EADD75E250>]}
[0m20:08:53.755143 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:08:53.757145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a368f04-203c-4f6c-bf4b-eef2e0d6b50e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EADD699150>]}
[0m20:08:53.759143 [info ] [MainThread]: 
[0m20:08:53.761175 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:08:53.763174 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:08:53.781144 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:08:53.781144 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:08:53.782143 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:08:54.956743 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:08:54.961757 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:08:55.037154 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:08:55.055154 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:08:55.056155 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:08:55.057186 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:08:55.831387 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:08:55.836376 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:08:55.905165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a368f04-203c-4f6c-bf4b-eef2e0d6b50e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EADDA2C950>]}
[0m20:08:55.906130 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:08:55.907131 [info ] [MainThread]: 
[0m20:08:55.915539 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:08:55.916540 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:08:55.917539 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:08:55.919540 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:08:55.960542 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:08:55.962539 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:08:55.919540 => 20:08:55.962539
[0m20:08:55.963538 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:08:56.006570 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:08:56.010576 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:08:56.012541 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    source_df = dbt.source("student_s", "bank_stream")

    info=dbt.source("student_s", "bank_stream")

    # infoc=info.collect()

    result=info[0][1]

    
    info.rename(F.col('CUSTID'),'summary1')
    
        
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:08:56.013542 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:08:58.760047 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m20:08:58.796484 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:08:55.964571 => 20:08:58.796484
[0m20:08:58.797484 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:08:58.870314 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a368f04-203c-4f6c-bf4b-eef2e0d6b50e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EADD743D50>]}
[0m20:08:58.871344 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 2.95s]
[0m20:08:58.873344 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:08:58.876344 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:08:58.876344 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:08:58.877344 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:08:58.878314 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:08:58.878314 [info ] [MainThread]: 
[0m20:08:58.880338 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.12 seconds (5.12s).
[0m20:08:58.881313 [debug] [MainThread]: Command end result
[0m20:08:58.897313 [info ] [MainThread]: 
[0m20:08:58.898319 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:08:58.899326 [info ] [MainThread]: 
[0m20:08:58.901314 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:08:58.904347 [debug] [MainThread]: Command `dbt run` succeeded at 20:08:58.903313 after 6.46 seconds
[0m20:08:58.905349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAD4423490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAD43E3590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAD48CF9D0>]}
[0m20:08:58.906315 [debug] [MainThread]: Flushing usage events
[0m20:10:16.768850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF72DA7D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF72ADEE90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF731B1DD0>]}


============================== 20:10:16.772880 | a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb ==============================
[0m20:10:16.772880 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:10:16.773876 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:10:17.836526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF7B77F150>]}
[0m20:10:17.855552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF7B77EC90>]}
[0m20:10:17.857498 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:10:17.872500 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:10:17.973500 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:10:17.974500 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:10:18.031531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF7C0DAAD0>]}
[0m20:10:18.046600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF7C1AC790>]}
[0m20:10:18.047531 [info ] [MainThread]: Found 8 models, 4 tests, 4 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:10:18.048517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF72AD55D0>]}
[0m20:10:18.050500 [info ] [MainThread]: 
[0m20:10:18.051497 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:10:18.053501 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:10:18.075498 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:10:18.076498 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:10:18.076498 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:10:19.106488 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:10:19.109487 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:10:19.182626 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:10:19.197596 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:10:19.198596 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:10:19.199594 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:10:19.994406 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:10:19.997385 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:10:20.091245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF7AB07FD0>]}
[0m20:10:20.093246 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:10:20.095244 [info ] [MainThread]: 
[0m20:10:20.106153 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:10:20.108153 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:10:20.110151 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:10:20.111156 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:10:20.151150 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:10:20.154151 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:10:20.112151 => 20:10:20.153183
[0m20:10:20.155153 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:10:20.207152 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:10:20.211183 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:10:20.212162 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    

    info=dbt.source("student_s", "bank_stream")

    # infoc=info.collect()

    result=info[0][1]

    
    info.rename(F.col('CUSTID'),'summary1')
    
        
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.bank_stream": "demo_database.demo_schema.bank_stream"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:10:20.213185 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:10:22.745208 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m20:10:22.773208 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:10:20.156159 => 20:10:22.773208
[0m20:10:22.774207 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:10:22.849793 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0fd875c-b5d9-4e06-b01f-bf79b2ec08fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF7C2B13D0>]}
[0m20:10:22.851757 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 2.74s]
[0m20:10:22.853751 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:10:22.856751 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:10:22.856751 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:10:22.857751 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:10:22.858751 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:10:22.858751 [info ] [MainThread]: 
[0m20:10:22.859750 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.81 seconds (4.81s).
[0m20:10:22.862753 [debug] [MainThread]: Command end result
[0m20:10:22.877758 [info ] [MainThread]: 
[0m20:10:22.879754 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:10:22.880752 [info ] [MainThread]: 
[0m20:10:22.881750 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:10:22.883765 [debug] [MainThread]: Command `dbt run` succeeded at 20:10:22.883765 after 6.14 seconds
[0m20:10:22.887758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF72EA03D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF7327F3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF73286690>]}
[0m20:10:22.889755 [debug] [MainThread]: Flushing usage events
[0m20:11:08.505134 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020353452F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020352638690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020352762810>]}


============================== 20:11:08.510131 | e854ade1-cc51-4c22-a872-09ce81e83bc6 ==============================
[0m20:11:08.510131 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:11:08.511144 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select describe', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:11:09.667038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e854ade1-cc51-4c22-a872-09ce81e83bc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002035346BF10>]}
[0m20:11:09.690040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e854ade1-cc51-4c22-a872-09ce81e83bc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020352F4AD50>]}
[0m20:11:09.691043 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:11:09.705037 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:11:09.828038 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:11:09.829038 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:11:09.878073 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.snowflake_dbt1.describe' (models\example\describe.py) depends on a source named 'student_s.emp' which was not found
[0m20:11:09.880041 [debug] [MainThread]: Command `dbt run` failed at 20:11:09.880041 after 1.41 seconds
[0m20:11:09.881042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020352CBCA10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020352CBECD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020352CBD490>]}
[0m20:11:09.882041 [debug] [MainThread]: Flushing usage events
[0m20:11:57.719451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEF41DA590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEF41FD490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEF49C21D0>]}


============================== 20:11:57.724420 | f46e647e-16d0-4831-98d0-55b835b38a00 ==============================
[0m20:11:57.724420 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:11:57.725432 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select describe', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:11:58.790033 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f46e647e-16d0-4831-98d0-55b835b38a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEF49B3410>]}
[0m20:11:58.809033 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f46e647e-16d0-4831-98d0-55b835b38a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEFC1F80D0>]}
[0m20:11:58.811034 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:11:58.822918 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:11:58.931770 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:11:58.931770 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:11:58.939805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f46e647e-16d0-4831-98d0-55b835b38a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEFD90E910>]}
[0m20:11:58.956771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f46e647e-16d0-4831-98d0-55b835b38a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEFD83C9D0>]}
[0m20:11:58.957771 [info ] [MainThread]: Found 8 models, 4 tests, 5 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:11:58.958770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f46e647e-16d0-4831-98d0-55b835b38a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEFD987DD0>]}
[0m20:11:58.960804 [info ] [MainThread]: 
[0m20:11:58.962772 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:11:58.963769 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:11:58.984801 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:11:58.984801 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:11:58.986771 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:12:00.044091 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:12:00.047091 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:12:00.123217 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:12:00.135743 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:12:00.136748 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:12:00.138746 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:12:00.786238 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:12:00.793274 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:12:00.864221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f46e647e-16d0-4831-98d0-55b835b38a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEFDDEA810>]}
[0m20:12:00.865253 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:12:00.866221 [info ] [MainThread]: 
[0m20:12:00.873919 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:12:00.874920 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:12:00.876920 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:12:00.877922 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:12:00.919592 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:12:00.923601 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:12:00.877922 => 20:12:00.923601
[0m20:12:00.924594 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:12:00.966622 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:12:00.969593 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:12:00.970613 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    

    info=dbt.source("student_s", "emp")

    # infoc=info.collect()

    result=info[0][1]

    
    info.rename(F.col('CUSTID'),'summary1')
    
        
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.emp": "demo_database.demo_schema.emp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:12:00.972640 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:12:02.676128 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07512-0001-0d23-0000-000299e6fea9
[0m20:12:02.678128 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 24, in model
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
    r = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3405, in rename
    return self.with_column_renamed(col_or_mapper, new_column)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
    r = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3486, in with_column_renamed
    raise ValueError(
ValueError: Unable to rename column "Column["CUSTID"]" because it doesn't exist.
 in function DESCRIBE__DBT_SP with handler main
[0m20:12:02.681120 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:12:00.924594 => 20:12:02.680140
[0m20:12:02.683123 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:12:02.753520 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 24, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3405, in rename
      return self.with_column_renamed(col_or_mapper, new_column)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3486, in with_column_renamed
      raise ValueError(
  ValueError: Unable to rename column "Column["CUSTID"]" because it doesn't exist.
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:12:02.755488 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f46e647e-16d0-4831-98d0-55b835b38a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEFDE15B90>]}
[0m20:12:02.756487 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 1.88s]
[0m20:12:02.758489 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:12:02.762523 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:12:02.763526 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:12:02.764522 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:12:02.765487 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:12:02.766487 [info ] [MainThread]: 
[0m20:12:02.767487 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.80 seconds (3.80s).
[0m20:12:02.769495 [debug] [MainThread]: Command end result
[0m20:12:02.784488 [info ] [MainThread]: 
[0m20:12:02.786502 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:12:02.787488 [info ] [MainThread]: 
[0m20:12:02.789489 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 24, in model
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3405, in rename
      return self.with_column_renamed(col_or_mapper, new_column)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 184, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3486, in with_column_renamed
      raise ValueError(
  ValueError: Unable to rename column "Column["CUSTID"]" because it doesn't exist.
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:12:02.793488 [info ] [MainThread]: 
[0m20:12:02.795491 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:12:02.797488 [debug] [MainThread]: Command `dbt run` failed at 20:12:02.796487 after 5.11 seconds
[0m20:12:02.797488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEF4274C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEF4291A50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AEF49D2650>]}
[0m20:12:02.798487 [debug] [MainThread]: Flushing usage events
[0m20:12:41.092971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDD34DB190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDD34FFF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDD38327D0>]}


============================== 20:12:41.097941 | 29dd4a60-af2d-44a1-a30d-5db996227cf5 ==============================
[0m20:12:41.097941 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:12:41.098940 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select describe', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:12:42.166984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '29dd4a60-af2d-44a1-a30d-5db996227cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDD3CAC810>]}
[0m20:12:42.185985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '29dd4a60-af2d-44a1-a30d-5db996227cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDDCA30810>]}
[0m20:12:42.187954 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:12:42.199952 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:12:42.303954 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:12:42.304955 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:12:42.361588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '29dd4a60-af2d-44a1-a30d-5db996227cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDDCB3E090>]}
[0m20:12:42.376608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '29dd4a60-af2d-44a1-a30d-5db996227cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDDCAFF090>]}
[0m20:12:42.377578 [info ] [MainThread]: Found 8 models, 4 tests, 5 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:12:42.379610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '29dd4a60-af2d-44a1-a30d-5db996227cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDDB94FA50>]}
[0m20:12:42.381609 [info ] [MainThread]: 
[0m20:12:42.382579 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:12:42.384579 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:12:42.402578 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:12:42.404622 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:12:42.406579 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:12:43.466069 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:12:43.470037 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:12:43.533331 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:12:43.548363 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:12:43.549366 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:12:43.550367 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:12:44.425449 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:12:44.430449 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:12:44.508540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '29dd4a60-af2d-44a1-a30d-5db996227cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDDCC28150>]}
[0m20:12:44.510505 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:12:44.512504 [info ] [MainThread]: 
[0m20:12:44.524654 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:12:44.526703 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:12:44.528671 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:12:44.529705 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:12:44.568671 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:12:44.571673 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:12:44.530704 => 20:12:44.571673
[0m20:12:44.573671 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:12:44.616704 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:12:44.619670 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:12:44.621671 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    

    info=dbt.source("student_s", "emp")

    # infoc=info.collect()

    result=info[0][1]

    
    info.rename(F.col('EMPID'),'summary1')
    
        
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.emp": "demo_database.demo_schema.emp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:12:44.622675 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:12:47.456552 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m20:12:47.504547 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:12:44.574670 => 20:12:47.504547
[0m20:12:47.505587 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:12:47.575590 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29dd4a60-af2d-44a1-a30d-5db996227cf5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDDCA6FBD0>]}
[0m20:12:47.576550 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 3.05s]
[0m20:12:47.579586 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:12:47.583552 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:12:47.584587 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:12:47.585550 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:12:47.587553 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:12:47.588553 [info ] [MainThread]: 
[0m20:12:47.590556 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.21 seconds (5.21s).
[0m20:12:47.592552 [debug] [MainThread]: Command end result
[0m20:12:47.608551 [info ] [MainThread]: 
[0m20:12:47.610552 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:12:47.612550 [info ] [MainThread]: 
[0m20:12:47.613555 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:12:47.615584 [debug] [MainThread]: Command `dbt run` succeeded at 20:12:47.615584 after 6.55 seconds
[0m20:12:47.615584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDD34FF5D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDD377FB10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDD3C6EED0>]}
[0m20:12:47.616570 [debug] [MainThread]: Flushing usage events
[0m20:14:26.045652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A7E81C2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A7EB29190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A7EA63010>]}


============================== 20:14:26.050652 | b86056c2-ae54-4d0a-88d6-74bc02315200 ==============================
[0m20:14:26.050652 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:14:26.051631 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select describe', 'send_anonymous_usage_stats': 'True'}
[0m20:14:27.110635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b86056c2-ae54-4d0a-88d6-74bc02315200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A074A6A10>]}
[0m20:14:27.130665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b86056c2-ae54-4d0a-88d6-74bc02315200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A07CC8110>]}
[0m20:14:27.131657 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:14:27.144635 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:14:27.247665 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:14:27.248668 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:14:27.304638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b86056c2-ae54-4d0a-88d6-74bc02315200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A07DED990>]}
[0m20:14:27.320637 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b86056c2-ae54-4d0a-88d6-74bc02315200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A07DAC790>]}
[0m20:14:27.321638 [info ] [MainThread]: Found 8 models, 4 tests, 5 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:14:27.322637 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b86056c2-ae54-4d0a-88d6-74bc02315200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A0736E5D0>]}
[0m20:14:27.324668 [info ] [MainThread]: 
[0m20:14:27.326650 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:14:27.328672 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:14:27.344637 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:14:27.344637 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:14:27.345639 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:14:28.386658 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:14:28.390658 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:14:28.452530 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:14:28.465529 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:14:28.467530 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:14:28.468529 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:14:29.300764 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:14:29.308757 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:14:29.428576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b86056c2-ae54-4d0a-88d6-74bc02315200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A07EDFDD0>]}
[0m20:14:29.430579 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:14:29.432196 [info ] [MainThread]: 
[0m20:14:29.443324 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:14:29.444329 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:14:29.446333 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:14:29.447327 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:14:29.484342 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:14:29.489329 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:14:29.448353 => 20:14:29.488327
[0m20:14:29.491328 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:14:29.535328 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:14:29.539361 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:14:29.540330 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    

    info=dbt.source("student_s", "emp")

    # infoc=info.collect()

    result=info[0][1]

    
    info.rename(with_column_renamed('EMPID'),'summary1')
    
        
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.emp": "demo_database.demo_schema.emp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:14:29.542326 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:14:31.195410 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b07514-0001-0d24-0002-99e60001003e
[0m20:14:31.195410 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 24, in model
NameError: name 'with_column_renamed' is not defined
 in function DESCRIBE__DBT_SP with handler main
[0m20:14:31.196378 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:14:29.492331 => 20:14:31.196378
[0m20:14:31.197411 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:14:31.273827 [debug] [Thread-1 (]: Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 24, in model
  NameError: name 'with_column_renamed' is not defined
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:14:31.275835 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b86056c2-ae54-4d0a-88d6-74bc02315200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A07D1C350>]}
[0m20:14:31.277829 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.describe .................. [[31mERROR[0m in 1.83s]
[0m20:14:31.279795 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:14:31.282796 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:14:31.283796 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:14:31.284792 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:14:31.285826 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:14:31.286829 [info ] [MainThread]: 
[0m20:14:31.287792 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.96 seconds (3.96s).
[0m20:14:31.289794 [debug] [MainThread]: Command end result
[0m20:14:31.303792 [info ] [MainThread]: 
[0m20:14:31.304793 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:14:31.306812 [info ] [MainThread]: 
[0m20:14:31.308857 [error] [MainThread]:   Database Error in model describe (models\example\describe.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 24, in model
  NameError: name 'with_column_renamed' is not defined
   in function DESCRIBE__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\describe.py
[0m20:14:31.311796 [info ] [MainThread]: 
[0m20:14:31.313797 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:14:31.314793 [debug] [MainThread]: Command `dbt run` failed at 20:14:31.314793 after 5.30 seconds
[0m20:14:31.315795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A7EB2B690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A7EF22650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028A7E2CE750>]}
[0m20:14:31.316795 [debug] [MainThread]: Flushing usage events
[0m20:14:52.702102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083F7B8A90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083F772990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083EEF7210>]}


============================== 20:14:52.706102 | 5c12d190-d0e1-4f12-b864-6d01bbaa18b1 ==============================
[0m20:14:52.706102 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:14:52.708104 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select describe', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:14:53.804401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5c12d190-d0e1-4f12-b864-6d01bbaa18b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208480BF150>]}
[0m20:14:53.823402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5c12d190-d0e1-4f12-b864-6d01bbaa18b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020847F6F150>]}
[0m20:14:53.824402 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:14:53.837432 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:14:53.940404 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:14:53.940404 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:14:53.997404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5c12d190-d0e1-4f12-b864-6d01bbaa18b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020848A21A10>]}
[0m20:14:54.012433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5c12d190-d0e1-4f12-b864-6d01bbaa18b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020848A82E50>]}
[0m20:14:54.013406 [info ] [MainThread]: Found 8 models, 4 tests, 5 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:14:54.015439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5c12d190-d0e1-4f12-b864-6d01bbaa18b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083B1BEB10>]}
[0m20:14:54.017407 [info ] [MainThread]: 
[0m20:14:54.019406 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:14:54.020405 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:14:54.039407 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:14:54.041409 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:14:54.042464 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:14:55.055609 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:14:55.058608 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:14:55.125602 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:14:55.137599 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:14:55.138600 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:14:55.139632 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:14:55.848971 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:14:55.858964 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:14:56.500904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5c12d190-d0e1-4f12-b864-6d01bbaa18b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020847769010>]}
[0m20:14:56.501904 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:14:56.503902 [info ] [MainThread]: 
[0m20:14:56.513144 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.describe
[0m20:14:56.514144 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.describe ........................... [RUN]
[0m20:14:56.516146 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.describe'
[0m20:14:56.517145 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.describe
[0m20:14:56.554144 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.describe"
[0m20:14:56.558152 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (compile): 20:14:56.517145 => 20:14:56.558152
[0m20:14:56.559186 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.describe
[0m20:14:56.603736 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.describe"
[0m20:14:56.607723 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.describe"
[0m20:14:56.608725 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.describe"} */
WITH describe__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F


def model(dbt, session):
    dbt.config(materialized = "table")

    

    info=dbt.source("student_s", "emp")

    # infoc=info.collect()

    result=info[0][1]

    
    info.with_column_renamed(F.col('EMPID'),'summary1')
    
        
   
    return info


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {"student_s.emp": "demo_database.demo_schema.emp"}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "describe"
    
    def __repr__(self):
        return 'demo_database.demo_schema.describe'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.describe', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL describe__dbt_sp();
[0m20:14:56.609722 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:14:59.112033 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.0 seconds
[0m20:14:59.142989 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.describe (execute): 20:14:56.560178 => 20:14:59.141988
[0m20:14:59.142989 [debug] [Thread-1 (]: On model.snowflake_dbt1.describe: Close
[0m20:14:59.215498 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5c12d190-d0e1-4f12-b864-6d01bbaa18b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020848E537D0>]}
[0m20:14:59.216499 [info ] [Thread-1 (]: 1 of 1 OK created python table model demo_schema.describe ...................... [[32mSUCCESS 1[0m in 2.70s]
[0m20:14:59.218496 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.describe
[0m20:14:59.222532 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:14:59.224500 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:14:59.225497 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:14:59.226497 [debug] [MainThread]: Connection 'model.snowflake_dbt1.describe' was properly closed.
[0m20:14:59.227498 [info ] [MainThread]: 
[0m20:14:59.229499 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.21 seconds (5.21s).
[0m20:14:59.231497 [debug] [MainThread]: Command end result
[0m20:14:59.249500 [info ] [MainThread]: 
[0m20:14:59.250497 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:14:59.251529 [info ] [MainThread]: 
[0m20:14:59.253497 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:14:59.255496 [debug] [MainThread]: Command `dbt run` succeeded at 20:14:59.254497 after 6.58 seconds
[0m20:14:59.257505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083EF12B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083F4834D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002083F4E7C50>]}
[0m20:14:59.258500 [debug] [MainThread]: Flushing usage events
[0m20:25:17.560659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4C1572E90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4C1972210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4C16601D0>]}


============================== 20:25:17.565658 | 93302080-3dc7-46b6-8e13-abbaccfd95a8 ==============================
[0m20:25:17.565658 [info ] [MainThread]: Running with dbt=1.6.6
[0m20:25:17.566180 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\yashm\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'D:\\snowflake_dbt1\\snowflake_dbt1\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select insert', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:25:18.630208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '93302080-3dc7-46b6-8e13-abbaccfd95a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4CA8A5750>]}
[0m20:25:18.650172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '93302080-3dc7-46b6-8e13-abbaccfd95a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4CA062390>]}
[0m20:25:18.652174 [info ] [MainThread]: Registered adapter: snowflake=1.6.4
[0m20:25:18.664673 [debug] [MainThread]: checksum: 546b81fb56652c304d87abd676e84d4737d8a0c6b62160f4a6e79dcddbc842bb, vars: {}, profile: , target: , version: 1.6.6
[0m20:25:18.767704 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:25:18.767704 [debug] [MainThread]: Partial parsing: updated file: snowflake_dbt1://models\example\describe.py
[0m20:25:18.825707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '93302080-3dc7-46b6-8e13-abbaccfd95a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4CA93E7D0>]}
[0m20:25:18.841674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '93302080-3dc7-46b6-8e13-abbaccfd95a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4CA9AC090>]}
[0m20:25:18.842677 [info ] [MainThread]: Found 8 models, 4 tests, 5 sources, 0 exposures, 0 metrics, 375 macros, 0 groups, 0 semantic models
[0m20:25:18.843679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93302080-3dc7-46b6-8e13-abbaccfd95a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4CAA2B310>]}
[0m20:25:18.845706 [info ] [MainThread]: 
[0m20:25:18.846673 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:25:18.848705 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database'
[0m20:25:18.868699 [debug] [ThreadPool]: Using snowflake connection "list_demo_database"
[0m20:25:18.869676 [debug] [ThreadPool]: On list_demo_database: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database"} */
show terse schemas in database demo_database
    limit 10000
[0m20:25:18.870678 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:25:19.976447 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 1.0 seconds
[0m20:25:19.982437 [debug] [ThreadPool]: On list_demo_database: Close
[0m20:25:20.063878 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_demo_database_demo_schema'
[0m20:25:20.077912 [debug] [ThreadPool]: Using snowflake connection "list_demo_database_demo_schema"
[0m20:25:20.078912 [debug] [ThreadPool]: On list_demo_database_demo_schema: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "connection_name": "list_demo_database_demo_schema"} */
show terse objects in demo_database.demo_schema limit 10000
[0m20:25:20.079879 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:25:20.733237 [debug] [ThreadPool]: SQL status: SUCCESS 41 in 1.0 seconds
[0m20:25:20.740236 [debug] [ThreadPool]: On list_demo_database_demo_schema: Close
[0m20:25:20.816167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93302080-3dc7-46b6-8e13-abbaccfd95a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4C158E210>]}
[0m20:25:20.818168 [info ] [MainThread]: Concurrency: 10 threads (target='dev')
[0m20:25:20.819143 [info ] [MainThread]: 
[0m20:25:20.827137 [debug] [Thread-1 (]: Began running node model.snowflake_dbt1.insert
[0m20:25:20.829156 [info ] [Thread-1 (]: 1 of 1 START python table model demo_schema.insert ............................. [RUN]
[0m20:25:20.831138 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.snowflake_dbt1.insert'
[0m20:25:20.832138 [debug] [Thread-1 (]: Began compiling node model.snowflake_dbt1.insert
[0m20:25:20.869144 [debug] [Thread-1 (]: Writing injected SQL for node "model.snowflake_dbt1.insert"
[0m20:25:20.873172 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (compile): 20:25:20.833138 => 20:25:20.872139
[0m20:25:20.874173 [debug] [Thread-1 (]: Began executing node model.snowflake_dbt1.insert
[0m20:25:20.921139 [debug] [Thread-1 (]: Writing runtime python for node "model.snowflake_dbt1.insert"
[0m20:25:20.924173 [debug] [Thread-1 (]: Using snowflake connection "model.snowflake_dbt1.insert"
[0m20:25:20.925167 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: /* {"app": "dbt", "dbt_version": "1.6.6", "profile_name": "snowflake_dbt1", "target_name": "dev", "node_id": "model.snowflake_dbt1.insert"} */
WITH insert__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

import sys
sys._xoptions['snowflake_partner_attribution'].append("dbtLabs_dbtPython")


  
    
import snowflake.snowpark.functions as F

def model(dbt, session):
    dbt.config(materialized = "table")

    table='emp'

    insert_query = f"insert into {table} values (7,'adad',6666);"
    result=session.sql(insert_query)



    

    return result


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args, **kwargs):
    refs = {}
    key = '.'.join(args)
    version = kwargs.get("v") or kwargs.get("version")
    if version:
        key += f".v{version}"
    dbt_load_df_function = kwargs.get("dbt_load_df_function")
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = '.'.join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = "demo_database"
    schema = "demo_schema"
    identifier = "insert"
    
    def __repr__(self):
        return 'demo_database.demo_schema.insert'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          session.use_database(target_relation.database)
          session.use_schema(target_relation.schema)
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    
    df.write.mode("overwrite").save_as_table('demo_database.demo_schema.insert', create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL insert__dbt_sp();
[0m20:25:20.926166 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:25:24.788827 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01b0751f-0001-0d24-0002-99e60001006e
[0m20:25:24.789832 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 108, in main
  File "_udf_code.py", line 103, in materialize
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
    raise ex
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
    results_cursor = self._cursor.execute(query, params=params, **kwargs)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b0751f-0001-0d24-0002-99e60001007e: 001003 (42000): SQL compilation error:
syntax error line 1 at position 54 unexpected '.'.
 in function INSERT__DBT_SP with handler main
[0m20:25:24.790797 [debug] [Thread-1 (]: Timing info for model.snowflake_dbt1.insert (execute): 20:25:20.875141 => 20:25:24.790797
[0m20:25:24.791797 [debug] [Thread-1 (]: On model.snowflake_dbt1.insert: Close
[0m20:25:24.863080 [debug] [Thread-1 (]: Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b0751f-0001-0d24-0002-99e60001007e: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m20:25:24.864083 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93302080-3dc7-46b6-8e13-abbaccfd95a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4CAE00650>]}
[0m20:25:24.865088 [error] [Thread-1 (]: 1 of 1 ERROR creating python table model demo_schema.insert .................... [[31mERROR[0m in 4.03s]
[0m20:25:24.868053 [debug] [Thread-1 (]: Finished running node model.snowflake_dbt1.insert
[0m20:25:24.871086 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:25:24.872088 [debug] [MainThread]: Connection 'list_demo_database' was properly closed.
[0m20:25:24.873052 [debug] [MainThread]: Connection 'list_demo_database_demo_schema' was properly closed.
[0m20:25:24.874053 [debug] [MainThread]: Connection 'model.snowflake_dbt1.insert' was properly closed.
[0m20:25:24.874053 [info ] [MainThread]: 
[0m20:25:24.876052 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.03 seconds (6.03s).
[0m20:25:24.878050 [debug] [MainThread]: Command end result
[0m20:25:24.894050 [info ] [MainThread]: 
[0m20:25:24.895075 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:25:24.896053 [info ] [MainThread]: 
[0m20:25:24.899052 [error] [MainThread]:   Database Error in model insert (models\example\insert.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 108, in main
    File "_udf_code.py", line 103, in materialize
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 162, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 202, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 445, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 181, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 111, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 546, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 102, in wrap
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 96, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 366, in run_query
      raise ex
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 347, in run_query
      results_cursor = self._cursor.execute(query, params=params, **kwargs)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 842, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 232, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 287, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/7349c87e1c9d9245c1236165e827b478dafdbd6cc4eed11fb15ca1d27ff576a1/lib/python3.8/site-packages/snowflake/connector/errors.py", line 165, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01b0751f-0001-0d24-0002-99e60001007e: 001003 (42000): SQL compilation error:
  syntax error line 1 at position 54 unexpected '.'.
   in function INSERT__DBT_SP with handler main
  compiled Code at target\run\snowflake_dbt1\models\example\insert.py
[0m20:25:24.906052 [info ] [MainThread]: 
[0m20:25:24.908051 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:25:24.910083 [debug] [MainThread]: Command `dbt run` failed at 20:25:24.910083 after 7.38 seconds
[0m20:25:24.910083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4C12ACC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4C182EBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4C11D0450>]}
[0m20:25:24.911081 [debug] [MainThread]: Flushing usage events
